---
title: "Chapter 1: Global disparity of camera trap research allocation and defaunation risk of terrestrial mammals."
description: "A global assessment of whether terrestrial mammal camera trap research allocation in the last two decades has tracked priority
    areas where mammal defaunation risk is highest"
author(s):
    - name: "Mwezi 'Badru' Mugerwa"
      url: https://izw-berlin.de/en/john-smith-en.html  
      affiliation: Leibniz Institute for Zoo and Wildlife Research
      affiliation_url: https://izw-berlin.de/en/badru-mugerwa-en.html
      orcid_id: 0000-0002-2633-176X
    - name: "Jürgen Niedballa"
      url: https://izw-berlin.de/en/john-smith-en.html  
      affiliation: Leibniz Institute for Zoo and Wildlife Research
      affiliation_url: https://izw-berlin.de/en/jürgen-niedballa-en.html
      orcid_id: 0000-0002-9187-2116
    - name: "Aimara Planillo"
      url: https://izw-berlin.de/en/john-smith-en.html  
      affiliation: Leibniz Institute for Zoo and Wildlife Research
      affiliation_url: https://izw-berlin.de/en/aimara-planillo-en.html
      orcid_id: 0000-0002-1607-2039
    - name: "Douglas Sheil"
      url: https://www.wur.nl/en/persons/douglas-prof.dr.-rd-douglas-sheil.htm  
      affiliation:Wageningen University and Research,Wageningen, Netherlands.
      affiliation_url: https://www.wur.nl/en.htm
      orcid_id: 0000-0002-1166-6591
    - name: "Stephanie Kramer Schadt"
      url: https://izw-berlin.de/en/john-smith-en.html  
      affiliation: Leibniz Institute for Zoo and Wildlife Research
      affiliation_url: https://izw-berlin.de/en/badru-mugerwa-en.html
      orcid_id: 0000-0002-9269-4446
    - name: "Andreas Wilting"
      url: https://izw-berlin.de/en/john-smith-en.html  
      affiliation: Leibniz Institute for Zoo and Wildlife Research
      affiliation_url: https://izw-berlin.de/en/badru-mugerwa-en.html
      orcid_id: 0000-0001-5073-9186
date: "23/04/2021"
output: html_document
editor_options: 
  chunk_output_type: console
---

# Chunk options (checked)
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo=TRUE, warning=TRUE, message = TRUE,
                      fig.with=9, fig.height=6,dpi=300,
                      retina=1, fig.showtext=TRUE)
```

* ** Research questions:
*1. What are the global patterns of terrestrial mammal camera trap research allocation? *
*2. What are the key predictors of global terrestrial mammal camera trap research allocation? *
*3. What is the disparity in terrestrial mammal camera trap research allocation in relation to defaunation? *

* ** Study area:**
*Global *

* ** Data:**
*Research locations' Lat/Long data + global environmental (predictor) remote sensed datasets:1) country income, 2) IUCN protected area, 3) forest loss, 4) number of species impacted by human activity, 5) terrestrial mammal diversity, 6) remoteness, 7) Intact Forest Landscape (IFL), 8) biome, 9) elevation, and 10) Terrain Ruggedness Index (TRI).*

# Setup: setting project in D6 style (checked)
```{r setting up project in D6 style}
# create project 
# d6::new_project(
# name = "mugerwa_2019_01_chapter1",
# path = "D:/BioDivCloud/Mwezi_B_Mugerwa/IMac/IZW/my_PhD/")
```

# Setup: cleaning memory (checked)
```{r cleaning memory}
rm(list=ls())
gc()
```

# Setup: installing packages (Checked)
```{r package installation}
# install.packages("maps")
# install.packages("classInt")
# install.packages("ggmosaic")
# install.packages("sf")
# install.packages("fasterize")
# install.packages("tmap", dependencies = TRUE)
# install.packages("XML")
# install.packages("pacman")
# install.packages("rdrop2")
# install.packages("repmis")
# install.packages("rworldmap")
# install.packages("rworldxtra")
# install.packages ("plyr")
# install.packages ("lme4")
# install.packages ("cartogram")
# install.packages ("dismo")
# install.packages("readxl")
# install.packages("raster")
# install.packages("rJava")
# install.packages("rgdal")
# install.packages("tidyverse")
# install.packages("ggplot2")
# install.packages("ggplots")
# install.packages("rgeos")
# install.packages("scales")
# install.packages("dplyr")
# install.packages("ENMeval")
# install.packages("sp")
# install.packages ("maptools")
# install.packages ("mapview")
# install.packages ("leaflet")
# install.packages ("broom")
# install.packages(c("JGR","Deducer","DeducerExtras"))
# install.packages("devtools")
# devtools::install_github("EcoDynIZW/d6")
# install.packages("rmarkdown")
# install.packages("Hmisc")
# install.packages("normImage")
# install.packages ("ppcor")
# install.packages("corrr")
# install.packages("GGally")
# install.packages("viridis")
# install.packages("ggcorrplot")
# install.packages("cowplot")
# install.packages ("ggpubr")
# install.packages ("reshape")
# webshot::install_phantomjs()
# install.packages("patchwork")
```

# Setup: loading packages (checked)
```{r package loading}
# find folder to put the maxent.jar
# system.file("java", package="dismo")

# run to check if the maxent.jar file is available, in the right folder
jar <- paste(system.file(package="dismo"), "/java/maxent.jar", sep='')

# run these before loading dismo and rJava. maxent needs them
options(java.parameters = "-Xmx2g" )
Sys.setenv(NOAWT=TRUE)

# now load packages
library(classInt)
library(reshape)
library(ggmosaic)
library(dismo)
library(rgdal)
library(ENMeval)
library(fasterize)
library(devtools)
library(rmarkdown)
library (geosphere)
library (RColorBrewer)
library(ppcor)
library(corrr)
library(GGally)
library(SDMtune)
library(d6)
library(maps)
library(sp)
library(raster)
library(rJava)
library(rgeos)
library(rgdal)
library(sf)
library(scales)
library(maptools)
library(mapview)
library(leaflet)
library(broom)
library(XML)
library(tmap)
library(rworldmap)
library(rworldxtra)
library(dplyr)
library(plyr)
library(readxl)
library(ggplot2)
library(cartogram)
library(Hmisc)
library(tidyverse)
library(ggpubr)
library(patchwork)
library(viridis)
library(cowplot)
library(stars)
library(patchwork)
library(ggcorrplot)
library(reshape2)
library(car)
```

# Setup: projections and functions (checked)
```{r required functions}
# Projections and extents
crs_equal_earth <- 8857 # Equal Earth 
crs_latlon <- 4326 # LatLong
prj <- "+proj=longlat +ellps=WGS84 +datum=WGS84 +no_defs"
extent <- extent(-180, 180, -90, 90)

# Raincloud plots
source("https://gist.githubusercontent.com/benmarwick/2a1bb0133ff568cbe28d/raw/fb53bd97121f7f9ce947837ef1a4c65a73bffb3f/geom_flat_violin.R")

# fastRandomPoint function
fastRandomPoints <- function(r, n, prob = FALSE) {
  if(raster::nlayers(r) > 1) r <- r[[1]]
  v <- as.vector(r)
  v.notNA <- which(!is.na(v))
  v.vals <- v[v.notNA]
  if(prob == TRUE & n <= length(v.notNA)) {
    x <- sample(v.notNA, n, prob = v.vals)
  } else {
    x <- sample(v.notNA, n)
  }
  pts <- raster::xyFromCell(r, x)
  return(pts)
}

# Themes for figures
science_theme = theme(panel.grid.major = element_line(size = 0.5, color = "grey"),axis.line = element_line(size = 0.7, color = "black"), legend.position = c(0.85,0.7),text = element_text(size = 14))

science_theme_facets = theme(panel.grid.major = element_line(size = 0.5, color = "grey"),axis.line = element_line(size = 0.7, color = "black"), legend.position = c(0.80,0.40), text = element_text(size = 24))

science_theme_distribution = theme(panel.grid.major = element_line(size = 0.5, color = "grey"),axis.line = element_line(size = 0.7, color = "black"), text = element_text(size =22))

science_theme_distribution_diparity = theme(panel.grid.major = element_line(size = 0.5, color ="grey"),axis.line = element_line(size = 0.7, color = "black"), legend.position="top",text = element_text(size = 22))

science_theme_maps = theme(panel.grid.major = element_line(size = 0.5, color = "grey"),
  axis.line = element_line(size = 0.7, color = "black"), 
  #legend.position = c(0.15,0.3), 
  #legend.position = "bottom",
  #legend.key.height = unit(0.4, "cm"),
  #legend.key.width = unit(2, "cm"),
  text = element_text(size = 20),
  #legend.justification = c(-140, -10),
  plot.margin = unit(x = c(0.5,0.2,0,0.5), units = "cm"),
  panel.border = element_rect(color = "grey20"))

science_theme_fig1 = theme(panel.grid.major = element_line(size = 0.5, color = "grey"),
  # axis.line = element_line(size = 0.7, color = "black"),
  legend.position = c(0.7,0.8), text = element_text(size = 20), plot.margin = unit(x = c(0.1,0.2,0,0.5), units = "cm"),
panel.border = element_rect(color = "grey90"))

science_theme_fig1b = theme(panel.grid.major = element_line(size = 0.5, color = "grey"),
# axis.line = element_line(size = 0.7, color = "black"), 
legend.position = c(0.4,0.8), 
text = element_text(size = 20),
plot.margin = unit(x = c(0.1,0.2,0,0.5), units = "cm"),
panel.border = element_rect(color = "grey90"))

science_theme_fig2b = theme(panel.grid.major = element_line(size = 0.5, color = "grey"),
  #axis.line = element_line(size = 0.7, color = "black"), 
  legend.position = c(0.10,0.3), 
  text = element_text(size = 18),
  plot.margin = unit(x = c(0.1,0.2,0,0.5), units = "cm"),
  panel.border = element_rect(color = "grey90"))

science_theme_fig2c = theme(panel.grid.major = element_line(size = 0.5, color = "grey"),
  # axis.line = element_line(size = 0.7, color = "black"), 
  #legend.position = c(0.10,0.3), 
  text = element_text(size = 20),
  plot.margin = unit(x = c(0.1,0.2,0,0.5), units = "cm"),
  panel.border = element_rect(color = "grey90"))

science_theme_facets = theme(panel.grid.major = element_line(size = 0.5, color = "grey"),
axis.line = element_line(size = 0.7, color = "black"), 
legend.position = c(0.80,0.40), text = element_text(size = 24))

science_theme_distribution = theme(panel.grid.major = element_line(size = 0.5, color = "grey"),
axis.line = element_line(size = 0.7, color = "black"), 
text = element_text(size = 22))

# More figure themes
plot.margin = unit(x = c(0.1,0.2,0,0.5), units = "cm")
ctry_border_size <- 0.5
ctry_border_color1 <- "grey60"
ctry_border_color2 <- "grey25"
study_point_size <- 1
legend.bg <- element_rect(fill = rgb(1,1,1,0.2))
axis.text.size <- 16
legend.text.size <- 14
fig2_bar_color <- "grey65"
fig2_line_color <- "grey20"

science_theme_fig1b = theme(panel.grid.major = element_line(size = 0.5, color = "grey"),
axis.line = element_line(size = 0.7, color = "black"), legend.position = c(0.5,0.8), text = element_text(size = 14))

# function to normalize rasters
normalizeRaster <- function(x){
  out <- (x - cellStats(x, min)) / (cellStats(x, max) - cellStats(x, min))  
  return(out)
}

# Bivariate maps
# The function that produces the colour matrix
colmat <- function(nquantiles = 3, upperleft = "#0096EB", upperright = "#820050", 
                   bottomleft = "#BEBEBE", bottomright = "#FFE60F",
                   xlab = "x label", ylab = "y label", plotLeg = TRUE,
                   saveLeg = TRUE) {
  require(dplyr)
  require(tidyr)
  require(ggplot2)
  require(magrittr)
  require(classInt)
  
  my.data <- seq(0, 1, .01)
  
  # divide range from 0-1 into nquantiles
  # Default uses terciles (Lucchesi and Wikle [2017] doi: 10.1002/sta4.150)
  my.class <- classInt::classIntervals(my.data,
                                       n = nquantiles,
                                       style = "quantile" )
  # interpolate colors between the corners along both axes (returns 101 values irrespective of the number of intervals)
  my.pal.1 <- findColours(my.class, c(upperleft, bottomleft))
  my.pal.2 <- findColours(my.class, c(upperright, bottomright))
  
  # create empty color matrix
  col.matrix <- matrix(nrow = 101, ncol = 101, NA)
  
  # loop over all rows and assign interpolated colors to each cell
  for (i in 1:101) {
    my.col <- c(paste(my.pal.1[i]), paste(my.pal.2[i]))
    col.matrix[102 - i, ] <- findColours(my.class, my.col)
  }
  
  col.matrix.plot <- col.matrix %>%
    as.data.frame(.) %>% 
    mutate("Y" = row_number()) %>%
    mutate_at(.tbl = ., .vars = vars(starts_with("V")), .funs = list(as.character)) %>% 
    pivot_longer(data = ., cols = -Y, names_to = "X", values_to = "HEXCode") %>% 
    mutate("X" = as.integer(sub("V", "", .$X))) %>%
    distinct(as.factor(HEXCode), .keep_all = TRUE) %>%
    mutate(Y = rev(.$Y)) %>% 
    dplyr::select(-c(4)) %>%
    mutate("Y" = rep(seq(from = 1, to = nquantiles, by = 1), each = nquantiles),
           "X" = rep(seq(from = 1, to = nquantiles, by = 1), times = nquantiles)) %>%
    mutate("UID" = row_number())
  
  # Use plotLeg if you want a preview of the legend
  if (plotLeg) {
    p <- ggplot(col.matrix.plot, aes(X, Y, fill = HEXCode)) +
      geom_raster() +
      scale_fill_identity() +
      coord_equal(expand = FALSE) +
      theme_void() +
      theme(aspect.ratio = 1,
            axis.title = element_text(size = 12, colour = "black",hjust = 0.5, 
                                      vjust = 1),
            axis.title.y = element_text(angle = 90, hjust = 0.5)) +
      xlab(bquote(.(xlab) ~  symbol("\256"))) +
      ylab(bquote(.(ylab) ~  symbol("\256")))
    print(p)
    assign(
      x = "BivLegend",
      value = p,
      pos = .GlobalEnv
    )
  }
  # Use saveLeg if you want to save a copy of the legend
  if (saveLeg) {
    ggsave(filename = "bivLegend.pdf", plot = p, device = "pdf",
           path = "./", width = 4, height = 4, units = "in",
           dpi = 300)
  }
  
  # create sequence from 0 to 100, equally spaced
  seqs <- seq(0, 100, (100 / nquantiles))
  
  # replace 1st value (0) with 1
  seqs[1] <- 1
  
  # subset the color matrix to the colors at the breakpoints
  col.matrix <- col.matrix[c(seqs), c(seqs)]
}

# Function to assign colour-codes to raster data. As before, by default assign tercile breaks
bivariate.map <- function(rasterx, rastery, colormatrix = col.matrix,
                          nquantiles = 3, export.colour.matrix = TRUE,
                          outname = paste0("colMatrix_rasValues", names(rasterx))) {
  # export.colour.matrix will export a data.frame of rastervalues and RGB codes 
  # to the global environment outname defines the name of the data.frame
  
  # extract raster values of first raster
  quanmean <- getValues(rasterx)
  
  # make data frame containing raster values and a placeholder for the quantile group
  temp <- data.frame(quanmean, quantile = rep(NA, length(quanmean)))
  
  # calculate quantile breaks of the raster values (1 more than nquantiles)
  brks <- with(temp, quantile(temp,
                              na.rm = TRUE,
                              probs = c(seq(0, 1, 1 / nquantiles))
  ))
  brks[-1] <- brks[-1] + seq_along(brks[-1]) * .Machine$double.eps
  
  # assign quantile group to each raster value (group 1 is omitted, so for 3 quantiles the values are 2,3,4)
  r1 <- within(temp, quantile <- cut(quanmean,
                                     breaks = brks,
                                     labels = 2:length(brks),
                                     include.lowest = TRUE
  ))
  quantr <- data.frame(r1[, 2])
  
  # same for raster 2
  quanvar <- getValues(rastery)
  temp <- data.frame(quanvar, quantile = rep(NA, length(quanvar)))
  brks <- with(temp, quantile(temp,
                              na.rm = TRUE,
                              probs = c(seq(0, 1, 1 / nquantiles))
  ))
  brks[-1] <- brks[-1] + seq_along(brks[-1]) * .Machine$double.eps
  r2 <- within(temp, quantile <- cut(quanvar,
                                     breaks = brks,
                                     labels = 2:length(brks),
                                     include.lowest = TRUE
  ))
  quantr2 <- data.frame(r2[, 2])
  
  # define function that converts factor labels to numeric
  as.numeric.factor <- function(x) {
    as.numeric(levels(x))[x]
  }
  
  
  col.matrix2 <- colormatrix
  
  # remove 1st row of color matrix (it is identical to 2nd row)
  # nevertheless 1st column = 2nd column
  cn <- unique(colormatrix)
  
  # loop over all cells of the original color matrix
  # if the color is NA, replace cell with 1, otherwise the the first match of the color i in cn
  for (i in 1:length(col.matrix2)) {
    ifelse(is.na(col.matrix2[i]), 
           col.matrix2[i] <- 1,
           col.matrix2[i] <- which(col.matrix2[i] == cn)[1]
    )
  }
  # Export the colour.matrix to data.frame()
  if (export.colour.matrix) {
    # create a dataframe of colours corresponding to raster values
    exportCols <- as.data.frame(cbind(
      as.vector(col.matrix2), as.vector(colormatrix),
      t(col2rgb(as.vector(colormatrix)))
    ))
    # rename columns of data.frame()
    colnames(exportCols)[1:2] <- c("rasValue", "HEX")
    # Export to the global environment
    assign(
      x = outname,
      value = exportCols,
      pos = .GlobalEnv
    )
  }
  
  # create vector of 0s, same length as rows in quantr (= number of cells in rasterx)
  cols <- numeric(length(quantr[, 1]))
  
  # loop over all raster cells, and assign color value to each cell
  for (i in 1:length(quantr[, 1])) {
    a <- as.numeric.factor(quantr[i, 1])
    b <- as.numeric.factor(quantr2[i, 1])
    cols[i] <- as.numeric(col.matrix2[b, a])
  }
  # template raster
  r <- rasterx
  # assign color values to each raster cell
  r[1:length(r)] <- cols
  
  return(r)
}

# Function to create the colour matrix. NOTE: Aichi changed to defaunation risk during revisions.
nBreaks <- 5 # Define the number of breaks. 
col.matrix <- colmat(nquantiles = nBreaks, xlab = "Maxent", ylab = "Aichi", 
                     bottomleft = "grey90",
                     upperleft = "#ff4704", 
                     upperright =  "grey10", 
                     bottomright = "#04eaff",
                     saveLeg = FALSE, plotLeg = TRUE)

# Function to throw/overlay points on the matrix
nquantiles <- 5
bottomleft = "grey90"
upperleft = "#ff4704"
upperright =  "grey10"
bottomright = "#04eaff"

my.data <- seq(0, 1, .01)
my.class <- classInt::classIntervals(my.data,
                                     n = nquantiles,
                                     style = "quantile" )
my.pal.1 <- findColours(my.class, c(upperleft, bottomleft))
my.pal.2 <- findColours(my.class, c(upperright, bottomright))
col.matrix <- matrix(nrow = 101, ncol = 101, NA)
for (i in 1:101) {
  my.col <- c(paste(my.pal.1[i]), paste(my.pal.2[i]))
  col.matrix[102 - i, ] <- findColours(my.class, my.col)
}
col.matrix.plot <- col.matrix %>%
  as.data.frame(.) %>%
  mutate("Y" = row_number()) %>%
  mutate_at(.tbl = ., .vars = vars(starts_with("V")), .funs = list(as.character)) %>%
  pivot_longer(data = ., cols = -Y, names_to = "X", values_to = "HEXCode") %>%
  mutate("X" = as.integer(sub("V", "", .$X))) %>%
  distinct(as.factor(HEXCode), .keep_all = TRUE) %>%
  mutate(Y = rev(.$Y)) %>%
  dplyr::select(-c(4)) %>%
  mutate("Y" = rep(seq(from = 1, to = nquantiles, by = 1), each = nquantiles),
         "X" = rep(seq(from = 1, to = nquantiles, by = 1), times = nquantiles)) %>%
  mutate("UID" = row_number())
# Plotting the matrix
p <- ggplot(col.matrix.plot, aes(X, Y, fill = HEXCode)) +
  geom_raster() +
  scale_fill_identity() +
  coord_equal(expand = FALSE) +
  theme_void() +
  theme(aspect.ratio = 1,
        axis.title = element_text(size = 12, colour = "black",hjust = 0.5,
                                  vjust = 1),
        axis.title.y = element_text(angle = 90, hjust = 0.5)) +
  xlab(bquote(.(xlab) ~  symbol("\256"))) +
  ylab(bquote(.(ylab) ~  symbol("\256")))
print(p)
assign(
  x = "BivLegend",
  value = p,
  pos = .GlobalEnv
)
```

# Setup: setting working directory (checked)
```{r working directory}
# set working directory
dir = "~/BioDivCloud/Mwezi_B_Mugerwa/IMac/IZW/my_PhD/mugerwa_2019_01_chapter1/"
```

# Data: shapefiles,.csv tables (checked)
```{r}
# shape files
world <- st_read(paste0(dir,"/output/geo-proc/shp/ne_10m_admin_0_countries.shp"))
ocean <- st_read(paste0(dir,"/output/geo-proc/shp/ne_10m_ocean.shp"))
landmass <- st_read(paste0(dir,"/data-raw/geo-raw/shp/ne_10m_land.shp"))
wdpa <- st_read(paste0(dir,"/data-raw/geo-raw/shp/WDPA_Jul2020-shapefile-polygons.shp"))
biomes <- st_read(paste0(dir,"/data-raw/geo-raw/shp/Ecoregions2017.shp"))
ifl <- st_read(paste0(dir,"/data-raw/geo-raw/shp/ifl_2000_2013_2016.shp"))
hum_impact_spp <- st_read(paste0(dir,"/data-raw/geo-raw/shp/Spatial_data_mammals.shp"))

# tables
figure2a <-read.csv(paste0(dir,"/output/data-tables/noStudies_PerYear_noCountries_PerYear.csv"))
figure2b <-read.csv(paste0(dir,"/output/data-tables/locs_peryr_countryInc_2000.csv"))
figure2c <- read.csv(paste0(dir,"/output/data-tables/research_locations_ALLYears.csv"))
corr_matrix <- read.csv(paste0(dir,"/output/data-tables/corrmatrix_avail_occ_covs.csv"))# correlation matrix
data_distribution_continuous <- read.csv(paste0(dir,"/output/data-tables/data_distribution_continuous.csv"))#data distribution
data_distribution_Income <- read.csv(paste0(dir,"/output/data-tables/data_distribution_Income.csv"))#data distribution
data_distribution_IFL <- read.csv(paste0(dir,"/output/data-tables/data_distribution_IFL.csv"))#data distribution
data_distribution_WDPA <- read.csv(paste0(dir,"/output/data-tables/data_distribution_WDPA.csv"))#data distribution
data_distribution_Biomes <- read.csv(paste0(dir,"/output/data-tables/data_distribution_Biomes.csv"))#data distribution

# rasters
# global
access <- raster(paste0(dir,"/output/geo-proc/rasters/global/global_accessibility.tif"))
biomes <- raster(paste0(dir,"/output/geo-proc/rasters/global/global_biomes.tif"))
income <- raster(paste0(dir,"/output/geo-proc/rasters/global/global_country_income_group.tif"))
elevation <- raster(paste0(dir,"/output/geo-proc/rasters/global/global_elevation.tif"))
for_loss <- raster(paste0(dir,"/output/geo-proc/rasters/global/global_forest_loss.tif"))
cum_hum_impact <- raster(paste0(dir,"/output/geo-proc/rasters/global/global_hum_impact_spp.tif"))
ifl <- raster(paste0(dir,"/output/geo-proc/rasters/global/global_ifl.tif"))
sp_rich <- raster(paste0(dir,"/output/geo-proc/rasters/global/global_iucn_species_rich.tif"))
wdpa <- raster(paste0(dir,"/output/geo-proc/rasters/global/global_iucn_wdpa.tif"))
tri <- raster(paste0(dir,"/output/geo-proc/rasters/global/global_tri.tif"))

# biome 1 (Tropical moist forests)
biome1_access <- raster(paste0(dir,"/output/geo-proc/rasters/biomes/biome1/biome1_accessibility.tif"))
biome1_income <- raster(paste0(dir,"/output/geo-proc/rasters/biomes/biome1/biome1_country_income_group.tif"))
biome1_elevation <- raster(paste0(dir,"/output/geo-proc/rasters/biomes/biome1/biome1_elevation.tif"))
biome1_forloss <- raster(paste0(dir,"/output/geo-proc/rasters/biomes/biome1/biome1_forest_loss.tif"))
biome1_cum_hum_impact <- raster(paste0(dir,"/output/geo-proc/rasters/biomes/biome1/biome1_hum_impact_spp.tif"))
biome1_ifl <- raster(paste0(dir,"/output/geo-proc/rasters/biomes/biome1/biome1_ifl.tif"))
biome1_sp_rich <- raster(paste0(dir,"/output/geo-proc/rasters/biomes/biome1/biome1_iucn_species_rich.tif"))
biome1_wdpa <- raster(paste0(dir,"/output/geo-proc/rasters/biomes/biome1/biome1_iucn_wdpa.tif"))
biome1_tri <- raster(paste0(dir,"/output/geo-proc/rasters/biomes/biome1/biome1_tri.tif"))

# biome 7 (Temperate forests)
biome7_access <- raster(paste0(dir,"/output/geo-proc/rasters/biomes/biome7/biome7_accessibility.tif"))
biome7_income <- raster(paste0(dir,"/output/geo-proc/rasters/biomes/biome7/biome7_country_income_group.tif"))
biome7_elevation <- raster(paste0(dir,"/output/geo-proc/rasters/biomes/biome7/biome7_elevation.tif"))
biome7_forloss <- raster(paste0(dir,"/output/geo-proc/rasters/biomes/biome7/biome7_forest_loss.tif"))
biome7_cum_hum_impact <- raster(paste0(dir,"/output/geo-proc/rasters/biomes/biome7/biome7_hum_impact_spp.tif"))
biome7_ifl <- raster(paste0(dir,"/output/geo-proc/rasters/biomes/biome7/biome7_ifl.tif"))
biome7_sp_rich <- raster(paste0(dir,"/output/geo-proc/rasters/biomes/biome7/biome7_iucn_species_rich.tif"))
biome7_wdpa <- raster(paste0(dir,"/output/geo-proc/rasters/biomes/biome7/biome7_iucn_wdpa.tif"))
biome7_tri <- raster(paste0(dir,"/output/geo-proc/rasters/biomes/biome7/biome7_tri.tif"))

# biome 12 (Tropical grasslands)
biome12_access <- raster(paste0(dir,"/output/geo-proc/rasters/biomes/biome12/biome12_accessibility.tif"))
biome12_income <- raster(paste0(dir,"/output/geo-proc/rasters/biomes/biome12/biome12_country_income_group.tif"))
biome12_elevation <- raster(paste0(dir,"/output/geo-proc/rasters/biomes/biome12/biome12_elevation.tif"))
biome12_forloss <- raster(paste0(dir,"/output/geo-proc/rasters/biomes/biome12/biome12_forest_loss.tif"))
biome12_cum_hum_impact <- raster(paste0(dir,"/output/geo-proc/rasters/biomes/biome12/biome12_hum_impact_spp.tif"))
biome12_ifl <- raster(paste0(dir,"/output/geo-proc/rasters/biomes/biome12/biome12_ifl.tif"))
biome12_sp_rich <- raster(paste0(dir,"/output/geo-proc/rasters/biomes/biome12/biome12_iucn_species_rich.tif"))
biome12_wdpa <- raster(paste0(dir,"/output/geo-proc/rasters/biomes/biome12/biome12_iucn_wdpa.tif"))
biome12_tri <- raster(paste0(dir,"/output/geo-proc/rasters/biomes/biome12/biome12_tri.tif"))

# biome 4 (Mediterranean biome)
biome4_access <- raster(paste0(dir,"/output/geo-proc/rasters/biomes/biome4/biome4_accessibility.tif"))
biome4_income <- raster(paste0(dir,"/output/geo-proc/rasters/biomes/biome4/biome4_country_income_group.tif"))
biome4_elevation <- raster(paste0(dir,"/output/geo-proc/rasters/biomes/biome4/biome4_elevation.tif"))
biome4_forloss <- raster(paste0(dir,"/output/geo-proc/rasters/biomes/biome4/biome4_forest_loss.tif"))
biome4_cum_hum_impact <- raster(paste0(dir,"/output/geo-proc/rasters/biomes/biome4/biome4_hum_impact_spp.tif"))
biome4_ifl <- raster(paste0(dir,"/output/geo-proc/rasters/biomes/biome4/biome4_ifl.tif"))
biome4_sp_rich <- raster(paste0(dir,"/output/geo-proc/rasters/biomes/biome4/biome4_iucn_species_rich.tif"))
biome4_wdpa <- raster(paste0(dir,"/output/geo-proc/rasters/biomes/biome4/biome4_iucn_wdpa.tif"))
biome4_tri <- raster(paste0(dir,"/output/geo-proc/rasters/biomes/biome4/biome4_tri.tif"))

# for MaxEnt models
global_locs <- read.csv(paste0(dir,"/output/data-tables/research_locations_global.csv"),sep=',',header=TRUE)[,-1]
biome1_locs <- read.csv(paste0(dir,"/output/data-tables/research_locations_biome1.csv"),sep=',',header=TRUE)[,-1]
biome7_locs <- read.csv(paste0(dir,"/output/data-tables/research_locations_biome7.csv"),sep=',',header=TRUE)[,-1]
biome12_locs <- read.csv(paste0(dir,"/output/data-tables/research_locations_biome12.csv"),sep=',',header=TRUE)[,-1]
biome4_locs <- read.csv(paste0(dir,"/output/data-tables/research_locations_biome4.csv"),sep=',',header=TRUE)[,-1]
```

# Figure S1 (correlation matrix: Testing collinearity among predictors) (checked)
```{r extended data figure 1: Correlation matrix}
# subset data for only occurrence data
occ_data <- subset(corr_matrix,data=="Occurrence"); length(occ_data$fid)
names(occ_data)

# collate variables to be tested
cordata <- occ_data %>% dplyr::select(access,cum_hum_im,forloss,sp_rich,elevation,TRI)

# check for collinearity
cor <- round(cor(cordata,use="pairwise.complete.obs",method = "spearman"),1)
# write.csv(cor, paste0(dir,"/output/data-tables/Spearman_cormatrix.csv"))

# plot
corplot <- ggcorrplot(cor, hc.order = TRUE,lab=TRUE,legend.title = "Correlation")+
labs(fill='Correlation')
corplot

# plot
corplot <- ggcorrplot(cor, hc.order = TRUE,lab=TRUE,legend.title = "Correlation")+
labs(fill='Correlation')+
labs(x="",y="")+
#scale_fill_viridis()+
theme_bw()+
theme(axis.text.x=element_text(size=20, angle=45, vjust=1, hjust=1, margin=margin(-3,0,0,0)),
      axis.text.y=element_text(size=20, margin=margin(-3,0,0,0)),
	text = element_text(size=20),
	legend.text = element_text(size=12))
science_theme_fig2c
corplot

# save plot
ggsave(filename = paste0(dir,"/plots/Spearman_cormatrixFinal.png"),plot = corplot, width = 10, height = 7, dpi = 300)
```

# Figure S2 (Visualising distribution of avialable vs. locations) (checked)
```{r data distribution between available vs. locations }
# load in occurrence and available points
avail_locs <-  data_distribution_continuous;str(avail_locs);names(avail_locs)

# Plot available and occurrence points for continuous covariates with Raincloud plot with boxplots
# continuous covariates
# species richness
sp_rich_graph <- ggplot(avail_locs,aes(x=data,y= sp_rich, fill = data, colour = data))+
theme_update(text = element_text(size=12))+
geom_flat_violin(position = position_nudge(x = .25, y = 0),adjust =2, trim = TRUE, alpha=0.7,color="white")+
geom_point(position = position_jitter(width = .23), size = .25,alpha=0.1, colour="grey")+
geom_boxplot(aes(x = data, y = sp_rich),outlier.shape = NA, alpha = 0.3, width = .1, colour = "BLACK")+
ylab("Terrestrial mammal species richness")+
xlab("Data")+
coord_flip()+
guides(fill = FALSE, colour = FALSE) +
scale_fill_manual(values = c("grey75","grey25"))+
theme_bw()+
science_theme_distribution;
sp_rich_graph

# number of species impacted (cumulative human impact)
num_sp_impacted_graph <- ggplot(avail_locs ,aes(x=data,y= num_sp_imp, fill = data, colour = data))+
theme_update(text = element_text(size=12))+
geom_flat_violin(position = position_nudge(x = .25, y = 0),adjust =2, trim = TRUE, alpha=0.7,color="white")+
geom_point(position = position_jitter(width = .23), size = .25,alpha=0.1, colour="grey")+
geom_boxplot(aes(x = data, y = num_sp_imp),outlier.shape = NA, alpha = 0.3, width = .1, colour = "BLACK")+
ylab("Number of impacted species")+
xlab("")+
coord_flip()+
guides(fill = FALSE, colour = FALSE) +
scale_fill_manual(values = c("grey75","grey25"))+
theme_bw()+
science_theme_distribution;
num_sp_impacted_graph

# accessibility
avail_locs$access_hrs <- 1/60*(avail_locs$access)# convert to hours
access_graph <- ggplot(avail_locs,aes(x=data,y= access_hrs, fill = data, colour = data))+
theme_update(text = element_text(size=20))+
geom_flat_violin(position = position_nudge(x = .25, y = 0),adjust =2, trim = TRUE, alpha=0.7,color="white")+
geom_point(position = position_jitter(width = .23), size = .25,alpha=0.1, colour="grey")+
geom_boxplot(aes(x = data, y = access_hrs),outlier.shape = NA, alpha = 0.3, width = .1, colour = "BLACK")+
coord_flip()+
ylim(0,300)+
ylab("Accessibility (Travel time in hours)")+
xlab("Data")+
guides(fill = FALSE, colour = FALSE) +
scale_fill_manual(values = c("grey75","grey25"))+
theme_bw()+
science_theme_distribution;
access_graph

# forest loss
avail_locs$forlossSQ<- sqrt(avail_locs$forloss)
forloss_graph <- ggplot(avail_locs,aes(x=data,y= forlossSQ, fill = data, colour = data))+
theme_update(text = element_text(size=12))+
geom_flat_violin(position = position_nudge(x = .25, y = 0),adjust =2, trim = TRUE, alpha=0.7,color="white")+
geom_point(position = position_jitter(width = .23), size = .25,alpha=0.1, colour="grey")+
geom_boxplot(aes(x = data, y = forlossSQ),outlier.shape = NA, alpha = 0.3, width = .1, colour = "BLACK")+
ylab("Forest loss")+
xlab("")+
coord_flip()+
guides(fill = FALSE, colour = FALSE) +
scale_fill_manual(values = c("grey75","grey25"))+
theme_bw()+
science_theme_distribution;
forloss_graph
  
# TRI
tri_graph <- ggplot(avail_locs,aes(x=data,y= TRI, fill = data, colour = data))+
theme_update(text = element_text(size=12))+
geom_flat_violin(position = position_nudge(x = .25, y = 0),adjust =2, trim = TRUE, alpha=0.7,color="white")+
geom_point(position = position_jitter(width = .23), size = .25,alpha=0.1, colour="grey")+
geom_boxplot(aes(x = data, y = TRI),outlier.shape = NA, alpha = 0.3, width = .1, colour = "BLACK")+
ylab("Terrain Ruggedness Index (meters)")+
xlab("Data")+
coord_flip()+
guides(fill = FALSE, colour = FALSE) +
scale_fill_manual(values = c("grey75","grey25"))+
theme_bw()+
science_theme_distribution;
tri_graph

# Elevation
elevation_graph <- ggplot(avail_locs,aes(x=data,y= elevation, fill = data, colour = data))+
theme_update(text = element_text(size=12))+
geom_flat_violin(position = position_nudge(x = .25, y = 0),adjust =2, trim = TRUE, alpha=0.7,color="white")+
geom_point(position = position_jitter(width = .23), size = .25,alpha=0.1, colour="grey")+
geom_boxplot(aes(x = data, y = elevation),outlier.shape = NA, alpha = 0.3, width = .1, colour = "BLACK")+
ylab("Elevation (meters)")+
xlab("")+
coord_flip()+
guides(fill = FALSE, colour = FALSE) +
scale_fill_manual(values = c("grey75","grey25"))+
theme_bw()+
science_theme_distribution;
elevation_graph

# save for continuous predictors
continuous <- ggarrange(sp_rich,num_sp_impacted,access,forloss,tri,elevation, ncol=2, nrow=3);continuous
# continuous <- num_sp_impacted + sp_rich + access + forloss + tri + elevation
#continuous <- (threat_sp|num_sp_impacted)/ (access|forloss)/ (tri|elevation)
# ggsave(filename = paste0(dir,"/plots/ExTFig2_distribution_continuous.png"),
# plot = continuous, width =14, height = 17, dpi = 300)

# Country income group
income_graph <- ggplot(data=data_distribution_Income, aes(x=Data, y=percent, fill= Income)) +
geom_bar(stat="identity",color="Black", alpha=0.5)+
#labs(fill="Income")+
#geom_text(aes(y=percent, label=percent), vjust=-0.25, color="black", size=5,position = position_dodge(0.5))+
xlab("Data")+ylab("Percentage of locations")+
theme(panel.grid.major.x=element_blank())+
# scale_color_viridis(discrete = TRUE,option = "A")+
# scale_fill_viridis(discrete = TRUE,option = "A")+
scale_fill_manual(values = c("grey90","grey70","grey50","grey30"), name= "Country income", labels=c("Group 1","Group 2","Group 3","Group 4"))+
#scale_colour_brewer(palette = "Dark2")+
#scale_fill_brewer(palette = "Dark2")+
coord_flip()+
theme_bw()+
science_theme_distribution;
income_graph

# IFL
ifl_graph <- ggplot(data=data_distribution_IFL, aes(x=Data, y=percent, fill= IFL)) +
geom_bar(stat="identity",color="Black",alpha=0.5)+
#geom_text(aes(y=percent, label=percent), vjust=-0.25, color="black", size=5,position = position_dodge(0.5))+
xlab("")+ylab("Percentage of locations")+
theme(panel.grid.major.x=element_blank())+
#scale_colour_brewer(palette = "Dark2")+
#scale_fill_brewer(palette = "Dark2")+
coord_flip()+
#scale_color_viridis(discrete = TRUE,option = "A")+
#scale_fill_viridis(discrete = TRUE,option = "A")+
scale_fill_manual(values = c("grey75","grey25"), name= "IFL", labels=c("No","Yes"),guide = guide_legend(reverse = TRUE))+
#scale_fill_manual(values = c("grey75","grey25"))+
theme_bw()+
science_theme_distribution;
ifl_graph

# WDPA
wdpa_graph <- ggplot(data=data_distribution_WDPA, aes(x=Data, y=percent, fill= Protected)) +
geom_bar(stat="identity",color="Black",alpha=0.5)+
#labs(fill="IUCN protected area")+
#geom_text(aes(y=percent, label=percent), vjust=-0.25, color="black", size=5,position = position_dodge(0.5))+
xlab("")+ylab("")+
theme(panel.grid.major.x=element_blank())+
#scale_color_viridis(discrete = TRUE,option = "A")+
#scale_fill_viridis(discrete = TRUE,option = "A")+
#scale_fill_manual(values = c("grey75","grey25"))+
scale_fill_manual(values = c("grey75","grey25"), name= "IUCN PA", labels=c("No","Yes"),guide = guide_legend(reverse = TRUE))+
coord_flip()+
# scale_colour_brewer(palette = "Dark2")+
# scale_fill_brewer(palette = "Dark2")+
theme_bw()+
science_theme_distribution;
wdpa_graph

# Biomes
# arranging the biomes
data_distribution_Biomes$Biomes <- factor(data_distribution_Biomes$Biomes, levels = c("Biome 1","Biome 2","Biome 3","Biome 4","Biome 5","Biome 6","Biome 7","Biome 8", "Biome 9","Biome 10","Biome 11","Biome 12","Biome 13","Biome 14"))

biomes_graph <- ggplot(data=data_distribution_Biomes, aes(x=Data, y=percent, fill= Biomes)) +
geom_bar(stat="identity",color="Black", alpha=0.8)+
labs(fill="Biomes")+
xlab("Data")+ylab("Percentage of locations")+
theme(panel.grid.major.x=element_blank())+
#scale_color_viridis(discrete = TRUE,option = "E")+
scale_fill_viridis(discrete = TRUE,option = "E")+
coord_flip()+
science_theme_distribution;
biomes_graph

# save for categorical predictors
#categorical <- biomes + wdpa + income + ifl
#ggsave(filename = paste0(dir,"/plots/ExTFig2_distribution_categoricalF.png"),
#plot = categorical2, width =15, height = 9, dpi = 300)
```

# Figure 2 (checked)
```{r Number of studies, echo=TRUE}
# Fig.2a
Fig2a <- ggplot() +
geom_bar(data=  figure2a,aes(x= Year,y= No_studies),stat="identity",
color="white",fill=fig2_bar_color,position=position_dodge())+
geom_line(data= figure2a,aes(x= Year,y= No_countries*5),size=1.5,color=fig2_line_color)+
scale_y_continuous(sec.axis = sec_axis(~./5, name = "Countries with studies")) +
labs(x="Year", y="Number of studies")+
theme_bw()+
theme(axis.title.y = element_text(color = fig2_bar_color),
         axis.title.y.right = element_text(color = fig2_line_color, angle=90),
         axis.text = element_text(size=20))+
science_theme_fig1
Fig2a
# save
ggsave(filename = paste0(dir,"/plots/Fig2a.png"), plot = Fig2a, width = 7, height = 5, dpi = 300)
########################################################################################################

# Fig.2b
# country income as factor
dataframe <- figure2b
dataframe$country_inc <- factor(dataframe$country_inc,levels = c("High","Upper-Middle","Lower-Middle","Low"))

Fig2b <- ggplot(data=dataframe, aes(x=Year, y=locs_country_inc, fill= country_inc)) +
geom_bar(stat="identity",color="white", alpha=0.8) +
labs(fill='Country income group')+
scale_fill_manual(values=c("#CD5C5C","#EFC8BD","#8874a3","#283655"),
name= "Country income group",labels = c("High", "Upper-Middle", "Lower-Middle","Low"))+
geom_line(data= dataframe,aes(x= Year,y= locs_per_yr*1.00),size=1.5,color=fig2_line_color, alpha=0.6)+
labs(x="Year", y="Number of locations")+
scale_y_continuous(sec.axis = sec_axis(~./1, name = "Locations per country income group")) + 
theme_bw()+
theme(axis.title.y = element_text(color = fig2_bar_color),
         axis.title.y.right = element_text(color = fig2_line_color, angle=90),
         axis.text = element_text(size=20),
	   legend.text = element_text(size=legend.text.size))+
science_theme_fig1b
Fig2b 
# save
ggsave(filename = paste0(dir,"/plots/Fig2b.png"), plot = Fig2b, width = 7, height = 5, dpi = 300)
##############################################################################################################

# Fig.2c
# make research locations spatial, assign coordinate reference system to spatial points
coordinates(figure2c) <- ~ lon + lat
str(figure2c)
 
locs_sp <- SpatialPointsDataFrame(coords = figure2c[, c("lon", "lat")],
                   data = figure2c,proj4string =   CRS("+proj=longlat +datum=WGS84"))
locs_sf <- as(locs_sp, "sf")

# Transforming to Equal Earth Projection
world_ee <- st_transform(world, st_crs(crs_equal_earth))
locs_sf_ee <- st_transform(locs_sf, st_crs(crs_equal_earth))

# Year as a factor
locs_sf$Year <- factor(locs_sf$Year, levels = c("After 2000","Before 2000"))

Fig2c <- ggplot() +
geom_sf(data = world_ee, fill="grey95", colour = ctry_border_color1, size = ctry_border_size) +
geom_sf(data = locs_sf_ee, aes(colour=Year, fill = Year), alpha = 0.5, size = study_point_size, shape = 16) +
scale_fill_manual(values=c("grey20", "purple")) + 
scale_colour_manual(values=c("grey20", "purple"))+
theme_bw()+
theme(axis.title = element_blank(),
         axis.text = element_blank(),
         panel.border = element_blank(),
         legend.background = legend.bg,
         legend.text = element_text(size=legend.text.size)) +
guides(fill = guide_legend(title.position="top", 
                              title.hjust = 0.5,
                              override.aes = list(size = 2, alpha = 0.8)))+
science_theme_fig2b
Fig2c
# save
ggsave(filename = paste0(dir,"/plots/Fig2c.png"),plot = Fig2c, scale = 1, dpi = 300, height = 4, width = 8)
##################################################################################################################
# Fig.2d
#construct cartogram
country <- cartogram_cont(world_ee, "No_sites", itermax = 5)
plot(country[,76])

# Create classes
country$No_studies_class <- ifelse(country$No_studies == 0, 0, 
                                    ifelse(country$No_studies <= 10, 1, 
                                           ifelse(country$No_studies <= 50, 2, 
                                                  ifelse(country$No_studies <= 100, 3, 
                                                         ifelse(country$No_studies <= 200, 4, 
                                                                ifelse(country$No_studies <= 300, 5,
												                                          ifelse(country$No_studies <= 400, 6,
													                                          ifelse(country$No_studies <= 500, 7, 
                                                                       			ifelse(country$No_studies <= 600, 8, NA)))))))))
country$No_studies_class <- factor(country$No_studies_class, 
                            levels = seq(0, 8), 
                            labels = c("0", "1-10", "11-50", "51-100", "101-200", "201-300", "301-400","401-500","501-600"))

Fig2d <- ggplot() +
geom_sf(data = country,  aes(fill= No_studies_class), color= ctry_border_color2, size = ctry_border_size,) +
theme_bw()+
scale_fill_viridis_d(name="Number of studies") +
guides(fill = guide_legend(title.position="top", 
                             title.hjust = 0.8,
                             label.position = "right",
                             ncol = 1)) +
theme(axis.title = element_blank(),
        panel.border = element_blank(),
        legend.text = element_text(size=legend.text.size),
        legend.background = legend.bg) +
science_theme_fig2b +
coord_sf()
Fig2d
# save
ggsave(filename = paste0(dir,"/plots/Fig2d.png"),plot = Fig2d, width =7, height = 8, dpi = 300)
#####################################################################################################################

# Fig.2
Fig2 <- Fig2a + Fig2b + Fig2c + Fig2d + plot_layout(ncol = 2, nrow = 2, 
                 widths = c(1,1), heights = c(1.2, 1)) +
                         plot_annotation(tag_levels = 'a', tag_suffix = ')')
Fig2
ggsave(filename = paste0(dir,"/plots/Fig2.png"), plot = Fig2, width = 20, height = 12, dpi = 600)
```

# Generate background points for use in the maxent models
```{r generating background points}
# create raster stacks for different models

# Global
predictorsGL <- raster::stack(access,cum_hum_impact,for_loss,income,biomes,sp_rich,wdpa,ifl,elevation,tri)

# Biomes
predictorsBiome1 <- raster::stack(biome1_access,biome1_income,biome1_elevation,biome1_forloss,biome1_cum_hum_impact,biome1_ifl,biome1_sp_rich,biome1_wdpa,biome1_tri)

predictorsBiome7 <- raster::stack(biome7_access,biome7_income,biome7_elevation,biome7_forloss,biome7_cum_hum_impact,biome7_ifl,biome7_sp_rich,biome7_wdpa,biome7_tri)

predictorsBiome12 <- raster::stack(biome12_access,biome12_income,biome12_elevation,biome12_forloss,biome12_cum_hum_impact,biome12_ifl,biome12_sp_rich,biome12_wdpa,biome12_tri)

predictorsBiome4 <- raster::stack(biome4_access,biome4_income,biome4_elevation,biome4_forloss,biome4_cum_hum_impact,biome4_ifl,biome4_sp_rich,biome4_wdpa,biome4_tri)

# Generate background points using the fastRandomPoint function
# Global
bgGL <- fastRandomPoints(predictorsGL, 10000)

# Biomes
bgBiome1 <- fastRandomPoints(predictorsBiome1, 10000)
bgBiome7 <- fastRandomPoints(predictorsBiome7, 10000)
bgBiome12 <- fastRandomPoints(predictorsBiome12, 10000)
bgBiome4 <- fastRandomPoints(predictorsBiome4, 10000)
```

# Model evaluation
```{r model evaluation with ENMevaluate}
# We use function ENMevaluate that allows us to objectively select what model settings to use when running MaxEnt
# run the evaluation: This run uses the "randomkfold" method of cross-validation and 10 cross-validation folds. 

# Global
enmevalGL <- ENMevaluate(global_locs, predictorsGL, method="randomkfold", kfolds = 5, n.bg=10000, categoricals=c(4,5,7,8), algorithm='maxent.jar')
enmevalGL@results
write.csv(enmevalGL@results, paste0(dir,"/results/After_2000/Final/Tables/enmevaGL_resultsFinalFinalFinal.csv"))

# Biomes
enmevalBiome1 <- ENMevaluate(biome1_locs, predictorsBiome1, method="randomkfold", kfolds = 5, n.bg=10000, categoricals=c(4,6,7), algorithm='maxent.jar')
enmevalBiome1@results
write.csv(enmevalBiome1@results, paste0(dir,"/results/After_2000/Final/Tables/enmevalBiome1_resultsFinalFinalFinal.csv"))

enmevalBiome7 <- ENMevaluate(biome7_locs, predictorsBiome7, method="randomkfold", kfolds = 5, n.bg=bgBiome7, categoricals=c(4,6,7), algorithm='maxent.jar')
enmevalBiome7@results
write.csv(enmevalBiome7@results, paste0(dir,"/results/After_2000/Final/Tables/enmevalBiome7_resultsFinalFinalFinal.csv"))

enmevalBiome12 <- ENMevaluate(biome12_locs, predictorsBiome12, method="randomkfold", kfolds = 5, n.bg=bgBiome12, categoricals=c(4,6,7), algorithm='maxent.jar')
enmevalBiome12@results
write.csv(enmevalBiome12@results, paste0(dir,"/results/After_2000/Final/Tables/enmevalBiome12_results.csv"))

enmevalBiome4 <- ENMevaluate(biome4_locs, predictorsBiome4, method="randomkfold", kfolds = 5, n.bg=bgBiome4, categoricals=c(4,6,7), algorithm='maxent.jar')
enmevalBiome4@results
write.csv(enmevalBiome4@results, paste0(dir,"/results/After_2000/Final/Tables/enmevalBiome4_results.csv"))

# IMPORTANT; We don't use bias files for our modeling. This is because bias files  account for spatial bias in the occurrence points. The assumption is that where our presence points are places that are easier to sample. The bias file allows background points or the pseudo absence points to be generated preferentially from areas with the highest density of presence points such that the absence points are near the presence points. But it is this bias we are trying to measure- the bias in the camera trap locations, so no need to correct for sampling bias. 
```

# Dividing occurrence data into training and testing sets for MaxEnt modelling
```{r training and testing sets}
# Withholding a 20% sample for testing and 80% for training the model.
# Global
set.seed(1)
fold_global <- kfold(global_locs, k=5)
occtest_global <- global_locs[fold_global == 1,]
occtrain_global <- global_locs[fold_global != 1,]

# Biomes
# 1
set.seed(1)
fold_biome1 <- kfold(biome1_locs, k=5)
occtest_biome1 <- biome1_locs[fold_biome1 == 1,]
occtrain_biome1 <- biome1_locs[fold_biome1 != 1,]

# 7
set.seed(1)
fold_biome7 <- kfold(biome7_locs, k=5)
occtest_biome7 <- biome7_locs[fold_biome7 == 1,]
occtrain_biome7 <- biome7_locs[fold_biome7 != 1,]

# 12
set.seed(1)
fold_biome12 <- kfold(biome12_locs, k=5)
occtest_biome12 <- biome12_locs[fold_biome12 == 1,]
occtrain_biome12 <- biome12_locs[fold_biome12 != 1,]

# 4
set.seed(1)
fold_biome4 <- kfold(biome4_locs, k=5)
occtest_biome4 <- biome4_locs[fold_biome4 == 1,]
occtrain_biome4 <- biome4_locs[fold_biome4 != 1,]
```

#  Global maxent
```{r Global MaxEnt}
# fit model
global <- maxent(predictorsGL, occtrain_global,a=bgGL,removeDuplicates=TRUE,factors=c("global_biomes","global_iucn_wdpa","global_ifl","global_country_income_group"), args = c('jackknife=true','outputformat=Logistic','linear=true', 'quadratic=true', 'product=true', 'threshold=true', 'hinge=true', 'maximumiterations=5000','betamultiplier=1.5','replicates=10','replicatetype=Crossvalidate','responsecurves','writeplotdata=true','doclamp=false'),path=paste0(dir,"/output/models/global"));global

# Model results
global_results <- global@results
write.csv(global_results,paste0(dir,"/output/models/global/global_results.csv"))

# Jacknife test
AUCjktglobal<- data.frame(driver=c("Accessibility","Biome","Number of impacted species","Elevation","Forest loss","Intact Forest Landscape","Country income group","Terrestrial mammal species richness","Terrain Ruggedness Index","IUCN protected area","With all drivers"),
                     
                        Jacknife=c("Without driver","Without driver","Without driver","Without driver","Without driver","Without driver","Without driver","Without driver","Without driver","Without driver","With all drivers","With only driver","With only driver","With only driver","With only driver","With only driver","With only driver","With only driver","With only driver","With only driver","With only driver","With all drivers"),
                     
                        AUC=c(0.795,0.7961,0.7969,0.7992,0.8002,0.8003,0.7859,0.7965,0.7969,0.7879,0.8003,0.6827,0.7232,0.6888,0.5488,0.5952,0.5118,0.5479,0.6902,0.6221,0.5795,0.8003));AUCjktglobal

# lollipop
AUCjkt_JN <- AUCjktglobal

# Change "Jackknife" value of "Model" 
AUCjkt_JN$Jacknife [AUCjkt_JN$driver == "With all drivers"] <- c("With only driver", "Without driver")

# reorder factor levels (adjust argument labels also - not shown here)
# entries are plotted in reverse order, i.e. Model is on top in the plot
AUCjkt_JN$driver <- factor(AUCjkt_JN$driver, levels = c("Accessibility","Biome","Number of impacted species","Elevation","Forest loss","Intact Forest Landscape","Country income group","Terrestrial mammal species richness","Terrain Ruggedness Index","IUCN protected area","With all drivers"))

# create the lollipop plot
p4 <- ggplot(AUCjkt_JN, aes(y = driver, x = AUC, fill = Jacknife)) +
geom_segment(aes(x = 0.5, y = driver, xend = AUC, yend = driver), size=2,color = "grey50") +
geom_point(aes(color=ifelse(driver %in% c("With all drivers","With all drivers"), "With all drivers",ifelse(driver %in% c("Accessibility","Biome","Number of impacted species","Elevation","Forest loss","Intact Forest Landscape","Country income group","Terrestrial mammal species richness","Terrain Ruggedness Index","IUCN protected area","With all drivers"),""))), size = 10,alpha=0.7,stroke=2,show.legend=FALSE)+
scale_color_viridis(discrete = TRUE,option = "D")+
scale_fill_viridis(discrete = TRUE,option = "D")+
labs(x="", y="Predictors")+
theme_bw()+
science_theme+
xlim(0.5,1.0)+
facet_wrap(~Jacknife);p4
ggsave(filename = paste0(dir,"/plots/ExTFig2_Global_Global_JackKnifeAUC.png"), plot = p4, width = 7, height = 5, dpi = 300)

# evaluate model
#train
test.train1 <- evaluate(global@models[[1]],p=occtrain_global,a=bgGL,x=predictorsGL);test.train1
test.train2 <- evaluate(global@models[[2]],p=occtrain_global,a=bgGL,x=predictorsGL);test.train2
test.train3 <- evaluate(global@models[[3]],p=occtrain_global,a=bgGL,x=predictorsGL);test.train3
test.train4 <- evaluate(global@models[[4]],p=occtrain_global,a=bgGL,x=predictorsGL);test.train4
test.train5 <- evaluate(global@models[[5]],p=occtrain_global,a=bgGL,x=predictorsGL);test.train5
test.train6 <- evaluate(global@models[[6]],p=occtrain_global,a=bgGL,x=predictorsGL);test.train6
test.train7 <- evaluate(global@models[[7]],p=occtrain_global,a=bgGL,x=predictorsGL);test.train7
test.train8 <- evaluate(global@models[[8]],p=occtrain_global,a=bgGL,x=predictorsGL);test.train8
test.train9 <- evaluate(global@models[[9]],p=occtrain_global,a=bgGL,x=predictorsGL);test.train9
test.train10 <- evaluate(global@models[[10]],p=occtrain_global,a=bgGL,x=predictorsGL);test.train10

# test
test.test1 <- evaluate(global@models[[1]],p=occtest_global,a=bgGL,x=predictorsGL);test.test1
test.test2 <- evaluate(global@models[[2]],p=occtest_global,a=bgGL,x=predictorsGL);test.test2
test.test3 <- evaluate(global@models[[3]],p=occtest_global,a=bgGL,x=predictorsGL);test.test3
test.test4 <- evaluate(global@models[[4]],p=occtest_global,a=bgGL,x=predictorsGL);test.test4
test.test5 <- evaluate(global@models[[5]],p=occtest_global,a=bgGL,x=predictorsGL);test.test5
test.test6 <- evaluate(global@models[[6]],p=occtest_global,a=bgGL,x=predictorsGL);test.test6
test.test7 <- evaluate(global@models[[7]],p=occtest_global,a=bgGL,x=predictorsGL);test.test7
test.test8 <- evaluate(global@models[[8]],p=occtest_global,a=bgGL,x=predictorsGL);test.test8
test.test9 <- evaluate(global@models[[9]],p=occtest_global,a=bgGL,x=predictorsGL);test.test9
test.test10 <- evaluate(global@models[[10]],p=occtest_global,a=bgGL,x=predictorsGL);test.test10

# plot response curves
response(global@models[[3]], rug=FALSE,expand=0)# replicate with highest AUC

# plot model covariate contributions
plot(global@models[[3]])

# Response curves show (and derived from) the mean response of the 10 replicate Maxent runs
# access
accessGl <- read.csv(paste0(dir,"/output/models/global/plots/responsecurves/access_prj_only.csv"))
accessGl$xh <- (accessGl$x)*0.016667
accessGl <- ggplot(data= accessGl,aes(x=xh,y= y))+geom_line(colour="black", size=2)+
xlab("")+
ylab("")+
theme_bw()+
ylim(0,1)+
facet_wrap(~ covariate, scales="free",ncol = 3)+ 
science_theme_facets; accessGl
ggsave(filename = paste0(dir,"/plots/Figure3_EXTFig3_Global_accessibility.png"),plot = accessGl, width =10, height = 7, dpi = 300)

# forest loss
for_lossGl <- read.csv(paste0(dir,"/output/models/global/plots/responsecurves/for_loss_JN_prj_maskf_prop.csv"))
for_lossGl <- ggplot(data=for_lossGl,aes(x=x,y= y))+geom_line(colour="black", size=2)+xlab("")+ylab("Predicted probability")+theme_bw()+
ylim(0,1)+facet_wrap(~ covariate, scales="free",ncol = 3)+ 
science_theme_facets; for_lossGl
ggsave(filename = paste0(dir,"/plots/ExTFig3_Global_ForestLoss.png"),plot = for_lossGl, width =10, height = 7, dpi = 300)

# country income
income <- read.csv(paste0(dir,"/output/models/global/plots/responsecurves/income_gp_prj_prj.csv"))
incomeGl <- ggplot(data=income,aes(reorder(x= x,- y), y= y, fill=income))+
geom_bar(sta="identity",position=position_dodge(), colour="Black", fill="Black")+
xlab("")+ylab("Predicted probability")+
theme_bw()+
scale_color_viridis(discrete = TRUE,option = "D",alpha=0.7)+
scale_fill_viridis(discrete = TRUE,option = "D",alpha=0.7)+
ylim(0,1)+
facet_wrap(~ covariate, scales="free",ncol = 3)+ 
science_theme_facets;incomeGl
ggsave(filename = paste0(dir,"/plots/Figure3_ExTFig3_Global_CountryIncome.png"),plot = incomeGl, width =10, height = 7, dpi = 300)

# Number of species impacted 
spec_impactedGl <-  read.csv(paste0(dir,"/output/models/global/plots/responsecurves/cum_hum_impact_prj.csv"))
spec_impactedGl <- ggplot(data= spec_impactedGl,aes(x=x,y= y))+geom_line(colour="black", size=2)+
xlab("")+ylab("Predicted probability")+
theme_bw()+
ylim(0,1)+
facet_wrap(~ covariate, scales="free",ncol = 3)+
science_theme_facets;spec_impactedGl
ggsave(filename = paste0(dir,"/plots/EXTFig3_Global_SpeciesImpacted.png"),plot = spec_impactedGl, width =10, height = 7, dpi = 300)

# biomes
biomeGL <-  read.csv(paste0(dir,"/output/models/global/plots/responsecurves/biomesNum_prj.csv"))
dataframe <- as.data.frame.matrix(biomeGL)
biomeGl <- ggplot(data=dataframe,aes(reorder(x= x,- y), y= y, fill=x))+
geom_bar(sta="identity",position=position_dodge(), colour="#000000", fill="#000000")+
xlab("")+ylab("")+
theme_bw()+
ylim(0,1)+
facet_wrap(~ covariate, scales="free",ncol = 3)+
science_theme_facets; biomeGl
ggsave(filename = paste0(dir,"/plots/Figure3_EXTFig3_Global_Biome.png"),plot = biomeGl, width =10, height = 7, dpi = 300)

# Species richness
sp_richGl<-  read.csv(paste0(dir,"/output/models/global/plots/responsecurves/sp_rich_prj.csv"))
sp_richGl <- ggplot(data= sp_richGl,aes(x=x,y= y))+geom_line(colour="black", size=2)+
theme_bw()+
labs(x="",y="Predicted probability")+
ylim(0,1)+
facet_wrap(~ covariate, scales="free",ncol = 3)+
science_theme_facets; sp_richGl
ggsave(filename = paste0(dir,"/plots/Figure3_EXTFig3_Global_SpeciesRichness.png"),plot = sp_richGl, width =10, height = 7, dpi = 300)

# IUCN protection
IUCNPAGl <-  read.csv(paste0(dir,"/output/models/global/plots/responsecurves/wdpa_bin_prj.csv"))
dataframe <- as.data.frame.matrix(IUCNPAGl)
IUCNPAGl <- ggplot(data=dataframe,aes(reorder(x= x,- y), y= y, fill=x))+
geom_bar(sta="identity",position=position_dodge(), colour="grey", fill="black")+
xlab("")+ylab("Predicted probability")+
theme_bw()+
ylim(0,1)+facet_wrap(~ covariate, scales="free",ncol = 3)+
science_theme_facets; IUCNPAGl
ggsave(filename = paste0(dir,"/plots/Figure3_EXTFig3_Global_IUCNPA.png"),plot = IUCNPAGl, width =10, height = 7, dpi = 300)

# IFL 
IFLGl <-  read.csv(paste0(dir,"/output/models/global/plots/responsecurves/ifl_bin_prj.csv"))
dataframe <- as.data.frame.matrix(IFLGl)
IFLGl <- ggplot(data=dataframe,aes(reorder(x= x,- y), y= y, fill=x))+
geom_bar(sta="identity",position=position_dodge(), colour="grey", fill="black")+
xlab("")+ylab("")+
theme_bw()+
ylim(0,1)+facet_wrap(~ covariate, scales="free",ncol = 3)+
science_theme_facets; IFLGl
ggsave(filename = paste0(dir,"/plots/Figure3_EXTFig3_Global_IFL.png"),plot = IFLGl, width =10, height = 7, dpi = 300)

# elevation
elevationGl <- read.csv(paste0(dir,"/output/models/global/plots/responsecurves/elevation_prj_maskf.csv"))
elevationGl <- ggplot(data=elevationGl,aes(x=x,y= y))+geom_line(colour="black", size=2)+xlab("")+ylab("")+theme_bw()+
ylim(0,1)+facet_wrap(~ covariate, scales="free",ncol = 3)+
science_theme_facets; elevationGl
ggsave(filename = paste0(dir,"/plots/Figure3_EXTFig3_Global_Elevation.png"),plot = elevationGl, width =10, height = 7, dpi = 300)

# TRI
TRIGl <- read.csv(paste0(dir,"/output/models/global/plots/responsecurves/tri_prj_mask_only.csv"))
TRIGl <- ggplot(data=TRIGl,aes(x=x,y= y))+geom_line(colour="black", size=2)+xlab("")+ylab("")+theme_bw()+
ylim(0,1)+facet_wrap(~ covariate, scales="free",ncol = 3)+
science_theme_facets;TRIGl
ggsave(filename = paste0(dir,"/plots/Figure3_EXTFig3_Global_TRI.png"),plot = TRIGl, width =10, height = 7, dpi = 300)

# with ggpubr
responsesGL <- ggarrange(incomeGl,biomeGl,sp_richGl,accessGl,IUCNPAGl,TRIGl,spec_impactedGl,elevationGl,for_lossGl,IFLGl,align="hv", ncol=2,nrow=5);responsesGL
ggsave(filename = paste0(dir,"/plots/ExTFig3A_Global_ResponseCurves.png"),plot = responsesGL, width =12, height = 17, dpi = 300)

# pie chart for permutation importance
PI <- data.frame(covariate = c("Country income","Biome","Terrestrial mammal richness","Accessibility","Others"),importance = c(23.5,22.6,16.5,14.2,23.2))

# Add label position
df <- PI %>%
arrange(desc(importance)) %>%
mutate(lab.ypos = cumsum(importance) - 0.5*importance)

# with ggplot
mycols <- c("#000000","white","#2F4F4F","#778899","#808080")

global_PI <- ggplot(data=df,aes(x = "", y = importance, fill=reorder(covariate,-importance))) +
geom_bar(width = 2, stat = "identity", color = "grey75",show.legend=TRUE) +
coord_polar("y", start = 0)+
labs(fill='Permutation importance')+
scale_fill_manual(values = mycols)+
science_theme_facets+
theme_void()
global_PI
ggsave(filename = paste0(dir,"/plots/Figure3A_Global_PI_MostImportantDrivers.png"), plot = global_PI, width = 10, height = 7, dpi = 300)

# make prediction
ppredictorsGl<- predict(global@models[[3]], predictorsGL,progress='text')
plot(ppredictorsGl)
writeRaster(ppredictorsGl,filename = paste0(dir,"/output/geo-proc/Predictions/global_prediction.tif"))

# project to EE and write raster
global_prediction <- raster(paste0(dir,"/output/geo-proc/Predictions/global_prediction.tif"))
global_prediction_ee = projectRaster(global_prediction, crs = crs_equal_earth, method = "bilinear")
writeRaster(global_prediction_ee,filename = paste0(dir,"/output/geo-proc/Predictions/global_predictionEE.tif"))

# with ggplot
# Prediction too big to plot on ggplot...first aggregate it to get a lower resolution
global_predictionEE <- raster(paste0(dir,"/output/geo-proc/Predictions/global_predictionEE.tif"))
plot(global_predictionEE)

global_predictionEE <- raster(paste0(dir,"/output/geo-proc/Predictions/global_predictionEE.tif"))
global_predictionEE_agg <- raster::aggregate(global_predictionEE,fact=10, fun=mean, expand=FALSE, na.rm=TRUE);writeRaster(global_predictionEE_agg,paste0(dir, "/output/geo-proc/Predictions/global_predictionEE_agg_10.tif"))

global_predictionEE_agg_10  <- raster(paste0(dir,"/output/geo-proc/Predictions/global_predictionEE_agg_10.tif"))
plot(global_predictionEE_agg_10)
globalpredictionEE_agg_10_spdf <- as(global_predictionEE_agg_10, "SpatialPixelsDataFrame")
globalpredictionEE_agg_10_df <- as.data.frame(globalpredictionEE_agg_10_spdf)
colnames(globalpredictionEE_agg_10_df) <- c("values", "x", "y")

globalprediction_plot <- ggplot() +
geom_tile(data=globalpredictionEE_agg_10_df, aes(x=x, y=y, fill=values), alpha=0.8)+
geom_sf(data = world, fill=NA, colour = "lightgray", size = 0.2)+
scale_fill_viridis(name="Predicted probability") +
science_theme_maps+
theme_map() +
theme(legend.position="bottom") +
theme(legend.key.width=unit(2, "cm"))
globalprediction_plot
globalprediction_plot_ee <- globalprediction_plot + coord_sf(crs = sf::st_crs(crs_equal_earth))
globalprediction_plot_ee

# extracting legend
global_prediction_NoNA <- as.data.frame(na.omit(values(global_prediction))); head(global_prediction_NoNA)
my_datal <- melt(global_prediction_NoNA, measure.vars = "na.omit(values(global_prediction))", variable.name = "cell", value.name = "Global_prediction");head(my_datal)

global_prediction_plot <- ggplot(my_datal, aes(x=cell, y= Global_prediction))+
geom_point(position = position_jitter(width = 0.25), size = 0.01, alpha=0.7, aes(colour=Global_prediction))+
geom_violin(position = position_nudge(x = 0, y = 0), alpha = 0.5, adjust =1, trim = T, width = .5, fill= "#A4A4A4")+
geom_boxplot(aes(x=cell, y= Global_prediction), outlier.shape = NA, alpha = 0.5, width = 0.02, colour = "black")+
scale_color_viridis(discrete=F, option = "D") +
scale_fill_viridis(discrete=F, option = "D")+
ylab("")+
ylim(0, 1)+
xlab("")+
theme_update(text = element_text(size=12))+
guides(fill = FALSE, colour = FALSE) +
theme_bw()+
science_theme_facets
global_prediction_plot
ggsave(filename = paste0(dir,"/plots/Figure2D_Global_PredictionLegend.png"),plot = global_prediction_plot, width =10, height = 7, dpi = 300)
```

# Biome1 (Tropical & Subtropical Moist Broadleaf Forests) MaxEnt
```{r biome 1 maxent}
# fit model
biome1 <- maxent(predictorsBiome1,occtrain_biome1,a=bgBiome1,removeDuplicates=TRUE,factors=c("biome1_ifl","biome1_iucn_wdpa","biome1_country_income_group"), args = c('jackknife=true','outputformat=Logistic','linear=true', 'quadratic=true','hinge=true','product=true','threshold=true','maximumiterations=5000','betamultiplier=3','replicates=10','replicatetype=Crossvalidate','responsecurves','writeplotdata=true','doclamp=false'),path=paste0(dir,"/output/models/biome1b"));biome1

# Model results
biome1_results <- biome1@results
write.csv(biome1_results,paste0(dir,"/output/models/biome1/biome1_results.csv"))

# Jacknife test
AUCjktbiome1<- data.frame(driver =c("Accessibility","Number of impacted species","Elevation","Forest loss","Intact Forest Landscape","Country income group","Terrestrial mammal species richness","Terrain Ruggedness Index","IUCN protected area","With all drivers"),
                     
                        Jacknife=c("Without driver","Without driver","Without driver","Without driver","Without driver","Without driver","Without driver","Without driver","Without driver","With all drivers","With only driver","With only driver","With only driver","With only driver","With only driver","With only driver","With only driver","With only driver","With only driver","With all drivers"),
                     
                        AUC=c(0.7755,0.7623,0.7777,0.7759,0.7769,0.7648,0.7704,0.7732,0.7286,0.7774,0.5677,0.6697,0.5599,0.5569,0.5492,0.5759,0.6071,0.6229,0.6285,0.7774));AUCjktbiome1

dataframebiome1 <- as.data.frame.matrix(AUCjktbiome1)

# lollipop
AUCjkt_JN <- AUCjktbiome1

# Change "Jackknife" value of "Model" 
AUCjkt_JN$Jacknife [AUCjkt_JN$driver == "With all drivers"] <- c("With only driver", "Without driver")

# reorder factor levels (adjust argument labels also - not shown here)
# entries are plotted in reverse order, i.e. Model is on top in the plot
AUCjkt_JN$driver <- factor(AUCjkt_JN$driver, levels = c("Accessibility","Number of impacted species","Elevation","Forest loss","Intact Forest Landscape","Country income group","Terrestrial mammal species richness","Terrain Ruggedness Index","IUCN protected area","With all drivers"))

# create the lollipop plot
p5 <- ggplot(AUCjkt_JN, aes(y = driver, x = AUC, fill = Jacknife)) +
geom_segment(aes(x = 0.5, y = driver, xend = AUC, yend = driver), size=2,color = "grey50") +
geom_point(aes(color=ifelse(driver%in% c("With all drivers","With all drivers"), "With all drivers",ifelse(driver %in% c("Accessibility","Number of impacted species","Elevation","Forest loss","Intact Forest Landscape","Country income group","Terrestrial mammal species richness","Terrain Ruggedness Index","IUCN protected area","With all drivers"),""))), size = 10,alpha=0.7,stroke=2,show.legend=FALSE)+
scale_color_viridis(discrete = TRUE,option = "D")+
scale_fill_viridis(discrete = TRUE,option = "D")+
labs(x="", y="")+
theme_bw()+
science_theme+
xlim(0.5,1.0)+
facet_wrap(~Jacknife);p5
ggsave(filename = paste0(dir,"/plots/ExTFig2_Biome1_JackKnifeAUC.png"), plot = p5, width = 7, height = 5, dpi = 300)

# evaluate model
#train
test.train1 <- evaluate(biome1@models[[1]],p=occtrain_biome1,a=bgBiome1,x=predictorsBiome1);test.train1
test.train2 <- evaluate(biome1@models[[2]],p=occtrain_biome1,a=bgBiome1,x=predictorsBiome1);test.train2
test.train3 <- evaluate(biome1@models[[3]],p=occtrain_biome1,a=bgBiome1,x=predictorsBiome1);test.train3
test.train4 <- evaluate(biome1@models[[4]],p=occtrain_biome1,a=bgBiome1,x=predictorsBiome1);test.train4
test.train5 <- evaluate(biome1@models[[5]],p=occtrain_biome1,a=bgBiome1,x=predictorsBiome1);test.train5
test.train6 <- evaluate(biome1@models[[6]],p=occtrain_biome1,a=bgBiome1,x=predictorsBiome1);test.train6
test.train7 <- evaluate(biome1@models[[7]],p=occtrain_biome1,a=bgBiome1,x=predictorsBiome1);test.train7
test.train8 <- evaluate(biome1@models[[8]],p=occtrain_biome1,a=bgBiome1,x=predictorsBiome1);test.train8
test.train9 <- evaluate(biome1@models[[9]],p=occtrain_biome1,a=bgBiome1,x=predictorsBiome1);test.train9
test.train10 <- evaluate(biome1@models[[10]],p=occtrain_biome1,a=bgBiome1,x=predictorsBiome1);test.train10

# test
test.test1 <- evaluate(biome1@models[[1]],p=occtest_biome1,a=bgBiome1,x=predictorsBiome1);test.test1
test.test2 <- evaluate(biome1@models[[2]],p=occtest_biome1,a=bgBiome1,x=predictorsBiome1);test.test2
test.test3 <- evaluate(biome1@models[[3]],p=occtest_biome1,a=bgBiome1,x=predictorsBiome1);test.test3
test.test4 <- evaluate(biome1@models[[4]],p=occtest_biome1,a=bgBiome1,x=predictorsBiome1);test.test4
test.test5 <- evaluate(biome1@models[[5]],p=occtest_biome1,a=bgBiome1,x=predictorsBiome1);test.test5
test.test6 <- evaluate(biome1@models[[6]],p=occtest_biome1,a=bgBiome1,x=predictorsBiome1);test.test6
test.test7 <- evaluate(biome1@models[[7]],p=occtest_biome1,a=bgBiome1,x=predictorsBiome1);test.test7
test.test8 <- evaluate(biome1@models[[8]],p=occtest_biome1,a=bgBiome1,x=predictorsBiome1);test.test8
test.test9 <- evaluate(biome1@models[[9]],p=occtest_biome1,a=bgBiome1,x=predictorsBiome1);test.test9
test.test10 <- evaluate(biome1@models[[10]],p=occtest_biome1,a=bgBiome1,x=predictorsBiome1Mask);test.test10

# plot response curves
response(biome1@models[[8]], rug=FALSE,expand=0)# replicate with highest AUC

# plot model covariate contributions
plot(biome1@models[[8]])

# Response curves show (and derived from) the mean response of the 10 replicate Maxent runs
# access
accessbiome1 <- read.csv(paste0(dir,"/output/models/biome1/plots/responsecurves/access_prj_only.csv"))
accessbiome1$xh <- (accessbiome1$x)*1/60
accessbiome1 <- ggplot(data= accessbiome1,aes(x=xh,y= y))+geom_line(colour="black", size=2)+xlab("")+ylab("")+theme_bw()+
ylim(0,1)+
facet_wrap(~ covariate, scales="free",ncol = 3)+
science_theme_facets;accessbiome1
ggsave(filename = paste0(dir,"/plots/Figure3_ExTFig3B_Biome1_accessibility.png"),plot = accessbiome1, width =10, height = 7, dpi = 300)

# forest loss
forlossbiome1 <- read.csv(paste0(dir,"/output/models/biome1/plots/responsecurves/for_loss_JN_prj_maskf_prop.csv"))
forlossbiome1 <- ggplot(data=forlossbiome1,aes(x=x,y= y))+geom_line(colour="black", size=2)+xlab("")+ylab("Predicted probability")+theme_bw()+
ylim(0,1)+
facet_wrap(~ covariate, scales="free",ncol = 3)+
science_theme_facets; forlossbiome1
ggsave(filename = paste0(dir,"/plots/ExTFig3B_Biome1_ForestLoss.png"),plot = forlossbiome1, width =10, height = 7, dpi = 300)

# country income
incomebiome1 <- read.csv(paste0(dir,"/output/models/biome1/plots/responsecurves/income_Avgp_prj.csv"))
incomebiome1 <- ggplot(data=incomebiome1,aes(reorder(x= x,- y), y= y, fill=income))+
geom_bar(sta="identity",position=position_dodge(), colour="Black", fill="Black")+
xlab("")+ylab("Predicted probability")+
theme_bw()+
scale_color_viridis(discrete = TRUE,option = "D",alpha=0.7)+
scale_fill_viridis(discrete = TRUE,option = "D",alpha=0.7)+
ylim(0,1)+
facet_wrap(~ covariate, scales="free",ncol = 3)+ 
science_theme_facets;incomebiome1
ggsave(filename = paste0(dir,"/plots/Figure3_ExTFig3B_Biome1_country.png"),plot = incomebiome1, width =10, height = 7, dpi = 300)

# Number of species impacted 
spec_impactedbiome1 <-  read.csv(paste0(dir,"/output/models/biome1/plots/responsecurves/cum_hum_impact_prj.csv"))
spec_impactedbiome1 <- ggplot(data= spec_impactedbiome1,aes(x=x,y= y))+geom_line(colour="black", size=2)+xlab("")+ylab("")+theme_bw()+
ylim(0,1)+
facet_wrap(~ covariate, scales="free",ncol = 3)+
science_theme_facets;spec_impactedbiome1
ggsave(filename = paste0(dir,"/plots/ExTFig3B_Biome1_#SpeciesImpacted.png"),plot = spec_impactedbiome1, width =10, height = 7, dpi = 300)

# Species richness
sp_richbiome1<-  read.csv(paste0(dir,"/output/models/biome1/plots/responsecurves/sp_rich_prj.csv"))
sp_richbiome1 <- ggplot(data= sp_richbiome1,aes(x=x,y= y))+geom_line(colour="black",size=2)+xlab("")+ylab("")+theme_bw()+
ylim(0,1)+
facet_wrap(~ covariate, scales="free",ncol = 3)+
science_theme_facets;sp_richbiome1
ggsave(filename = paste0(dir,"/plots/Figure3_ExTFig3B_Biome1_SpeciesRichness.png"),plot = sp_richbiome1, width =10, height = 7, dpi = 300)

# IUCN protection
protectionbiome1 <-  read.csv(paste0(dir,"/output/models/biome1/plots/responsecurves/wdpa_bin_prj.csv"))
dataframe <- as.data.frame.matrix(protectionbiome1)
protectionbiome1 <- ggplot(data=dataframe,aes(reorder(x= x,- y), y= y, fill=x))+
geom_bar(sta="identity",position=position_dodge(), colour="black", fill="black")+
xlab("")+ylab("Predicted probability")+
theme_bw()+
ylim(0,1)+
facet_wrap(~ covariate, scales="free",ncol = 3)+
science_theme_facets;protectionbiome1
ggsave(filename = paste0(dir,"/plots/Figure3_ExTFig3B_Biome1_IUCNPA.png"),plot = protectionbiome1, width =10, height = 7, dpi = 300)

# IFL
IFLbiome1 <-  read.csv(paste0(dir,"/output/models/biome1/plots/responsecurves/ifl_bin_prj.csv"))
dataframe <- as.data.frame.matrix(IFLbiome1)
IFLbiome1 <- ggplot(data=dataframe,aes(reorder(x= x,- y), y= y, fill=x))+
geom_bar(sta="identity",position=position_dodge(), colour="black", fill="black")+ylim(0,1)+
xlab("")+ylab("")+
theme_bw()+
facet_wrap(~ covariate, scales="free",ncol = 3)+
science_theme_facets; IFLbiome1
ggsave(filename = paste0(dir,"/plots/ExTFig4B_Biome1_IFL.png"),plot = IFLbiome1, width =10, height = 7, dpi = 300)

# elevation
elevationbiome1 <- read.csv(paste0(dir,"/output/models/biome1/plots/responsecurves/elevation_prj_maskf.csv"))
elevationbiome1 <- ggplot(data=elevationbiome1,aes(x=x,y= y))+geom_line(colour="black", size=2)+xlab("")+ylab("Predicted probability")+theme_bw()+
ylim(0,1)+
facet_wrap(~ covariate, scales="free",ncol = 3)+
science_theme_facets; elevationbiome1
ggsave(filename = paste0(dir,"/plots/ExTFig3B_Biome1_Elevation.png"),plot = elevationbiome1, width =10, height = 7, dpi = 300)

# TRI
TRIbiome1 <- read.csv(paste0(dir,"/output/models/biome1/plots/responsecurves/tri_prj_mask.csv"))
TRIbiome1 <- ggplot(data=TRIbiome1,aes(x=x,y= y))+geom_line(colour="black", size=2)+
xlab("")+ylab("Predicted probability")+theme_bw()+
ylim(0,1)+
facet_wrap(~ covariate, scales="free",ncol = 3)+ 
science_theme_facets; TRIbiome1
ggsave(filename = paste0(dir,"/plots/Figure3_ExTFig3B_Biome1_TRI.png"),plot = TRIbiome1, width =10, height = 7, dpi = 300)

# with ggpubr
biome1responses <- ggarrange(protectionbiome1,spec_impactedbiome1,incomebiome1,accessbiome1,TRIbiome1,sp_richbiome1,forlossbiome1,IFLbiome1,elevationbiome1,align="v", ncol=2,nrow=5);biome1responses
ggsave(filename = paste0(dir,"/plots/ExTFig3_Biome1_ResponseCurves.png"),plot = biome1responses, width =12, height = 17, dpi = 300)

# pie chart for permutation importance
PI <- data.frame(covariate = c("IUCN protected area","Number of species impacted","Country income group","Accessibility", "Others"),
  importance = c(36.0174,32.6065,9.4445,6.5191,15.4126))

# Add label position
df <- PI %>%
  arrange(desc(importance)) %>%
  mutate(lab.ypos = cumsum(importance) - 0.5*importance)

# with ggplot
mycols <- c("#000000","#2F4F4F","white","#778899","#808080")

biome1_PI <- ggplot(data=df,aes(x = "", y = importance, fill=reorder(covariate,-importance))) +
  geom_bar(width = 2, stat = "identity", color = "grey75",show.legend=TRUE) +
  coord_polar("y", start = 0)+
  labs(fill='Permutation importance')+
  #geom_text(aes(y = lab.ypos, label = importance), color = "white")+
  scale_fill_manual(values = mycols)+
  science_theme_facets+
  theme_void();
  biome1_PI
ggsave(filename = paste0(dir,"/plots/Figure4B1_Biome1_PI_MostImportantDrivers.png"), plot = biome1_PI, width = 10, height = 7, dpi = 300)

# make prediction
ppredictorsbiome1<- predict(biome1@models[[8]], predictorsBiome1Mask,progress='text')
plot(ppredictorsbiome1)
writeRaster(ppredictorsbiome1,filename = paste0(dir,"/output/geo-proc/Predictions/Biome1_predictionFinal.tif"))

# project to EE and write raster
biome1_prediction <- raster(paste0(dir,"/output/geo-proc/Predictions/Biome1_predictionFinal.tif"))
biome1_prediction_ee = projectRaster(Biome1_prediction, crs = crs_equal_earth, method = "bilinear")
writeRaster(biome1_prediction_ee,filename = paste0(dir,"/output/geo-proc/Predictions/Biome1_predictionFinalEE.tif"))

# with ggplot
# Prediction too big...first aggregate it to get a lower resolution  (larger cells)
biome1_predictionFinalEE <- raster(paste0(dir,"/output/geo-proc/Predictions/Biome1_predictionFinalEE.tif"))
plot(Biome1_predictionFinalEE)
biome1_predictionEE_agg <- raster::aggregate(biome1_prediction,fact=5, fun=mean, expand=FALSE, na.rm=TRUE);writeRaster(biome1_predictionEE_agg,paste0(dir, "/output/geo-proc/Predictions/biome1_predictionFinal_agg_5.tif"))

biome1_prediction_agg_5  <- raster(paste0(dir,"/output/geo-proc/Predictions/Biome1_predictionFinal_agg_5.tif"))
plot(biome1_prediction_agg_5)
biome1_prediction_agg_5_spdf <- as(biome1_prediction_agg_5, "SpatialPixelsDataFrame")
biome1_prediction_agg_5_df <- as.data.frame(biome1_prediction_agg_5_spdf)
colnames(biome1_prediction_agg_5_df) <- c("values", "x", "y")

biome1_prediction_plot <- ggplot() +
geom_tile(data=biome1_prediction_agg_5_df, aes(x=x, y=y, fill=values), alpha=0.8)+
geom_sf(data = world, fill=NA, colour = "lightgray", size = 0.2)+
scale_fill_viridis(name="Predicted probabibility") +
science_theme_maps+
theme_map() +
theme(legend.position="bottom") +
theme(legend.key.width=unit(2, "cm"))
biome1_prediction_plot
Biome1prediction_plot_ee <- biome1_prediction_plot + coord_sf(crs = sf::st_crs(crs_equal_earth))
Biome1prediction_plot_ee

# extracting legend
biome1_prediction_NoNA <- as.data.frame(na.omit(values(biome1_prediction)))
head(biome1_prediction_NoNA)
my_datal <- melt(biome1_prediction_NoNA, measure.vars = "na.omit(values(biome1_prediction))", variable.name = "cell", value.name = "biome1_prediction");head(my_datal)

biome1_prediction_plot <- ggplot(my_datal, aes(x=cell, y= biome1_prediction))+
geom_point(position = position_jitter(width = 0.25), size = 0.01, alpha=0.7, aes(colour = biome1_prediction))+
geom_violin(position = position_nudge(x = 0, y = 0), alpha = 0.5, adjust =1, trim = T, width = .5, fill= "#A4A4A4")+
geom_boxplot(aes(x=cell, y= biome1_prediction), outlier.shape = NA, alpha = 0.5, width = 0.02, colour = "black")+
#scale_color_viridis(discrete=F, option = "magma") +
#scale_fill_viridis(discrete=F, option = "magma")+
scale_color_viridis(discrete=F, option = "D") +
scale_fill_viridis(discrete=F, option = "D")+
ylab("")+
ylim(0, 1)+
xlab("")+
theme_update(text = element_text(size=12))+
guides(fill = FALSE, colour = FALSE) +
theme_bw()+
science_theme_facets
biome1_prediction_plot
ggsave(filename = paste0(dir,"/plots/Figure3A1_Biome1_PredictionLegend.png"),plot = biome1_prediction_plot, width =10, height = 7, dpi = 300)
```

# Biome7 (Tropical & Subtropical Grasslands, Savannah and Shrubs) MaxEnt
```{r biome 7 maxent}
# fit model
biome7 <- maxent(predictorsBiome7, occtrain_biome7,a=bgBiome7,removeDuplicates=TRUE,factors=c("biome7_ifl","biome7_iucn_wdpa","biome7_country_income_group"), args = c('jackknife=true','outputformat=Logistic','linear=true','maximumiterations=5000','betamultiplier=3.5','replicates=10','replicatetype=Crossvalidate','responsecurves','writeplotdata=true','doclamp=false'),path=paste0(dir,"/output/models/biome7"));biome7

# Model results
biome7_results <- biome7@results
write.csv(biome7_results,paste0(dir,"/output/models/biome7/biome7_results.csv"))

# Jacknife test
AUCjktbiome7<- data.frame(driver =c("Accessibility","Number of impacted species","Elevation","Forest loss","Intact Forest Landscape","Country income group","Terrestrial mammal species richness","Terrain Ruggedness Index","IUCN protected area","With all drivers"),
                     
                        Jacknife=c("Without driver","Without driver","Without driver","Without driver","Without driver","Without driver","Without driver","Without driver","Without driver","With all drivers",
                                   
                                   "With only driver","With only driver","With only driver","With only driver","With only driver","With only driver","With only driver","With only driver","With only driver","With all drivers"),
                     
                        AUC=c(0.8276,0.8259,0.8292,0.8304,0.8335,0.7997,0.8269,0.8288,0.8043,0.8334,0.6029,0.707,0.6052,0.5,0.5191,0.6983,0.6886,0.6023,0.6082,0.8334));AUCjktbiome7

dataframebiome7 <- as.data.frame.matrix(AUCjktbiome7)

# lollipop
AUCjkt_JN <- AUCjktbiome7

# Change "Jackknife" value of "Model" 
AUCjkt_JN$Jacknife [AUCjkt_JN$driver == "With all drivers"] <- c("With only driver", "Without driver")

# reorder factor levels (adjust argument labels also - not shown here)
# entries are plotted in reverse order, i.e. Model is on top in the plot
AUCjkt_JN$driver <- factor(AUCjkt_JN$driver, levels = c("Accessibility","Number of impacted species","Elevation","Forest loss","Intact Forest Landscape","Country income group","Terrestrial mammal species richness","Terrain Ruggedness Index","IUCN protected area","With all drivers"))

# create the lollipop plot
p7 <- ggplot(AUCjkt_JN, aes(y = driver, x = AUC, fill = Jacknife)) +
geom_segment(aes(x = 0.5,y = driver, xend = AUC, yend = driver), size=2,color = "grey50") +
geom_point(aes(color=ifelse(driver %in% c("With all drivers","With all drivers"), "With all drivers",ifelse(driver %in% c("Accessibility","Number of impacted species","Elevation","Forest loss","Intact Forest Landscape","Country income group","Terrestrial mammal species richness","Terrain Ruggedness Index","IUCN protected area","With all drivers"),""))), size = 10,alpha=0.7,stroke=2,show.legend=FALSE)+
scale_color_viridis(discrete = TRUE,option = "D")+
scale_fill_viridis(discrete = TRUE,option = "D")+
labs(x="", y="Predictors")+
theme_bw()+
science_theme+
xlim(0.5,1.0)+
facet_wrap(~Jacknife)
p7
ggsave(filename = paste0(dir,"/plots/ExTFig4_Biome7_JackKnifeAUC.png"), plot = p7, width = 7, height = 5, dpi = 300)

# evaluate model
#train
test.train1 <- evaluate(biome7@models[[1]],p=occtrain_biome7,a=bgBiome7,x=predictorsBiome7);test.train1
test.train2 <- evaluate(biome7@models[[2]],p=occtrain_biome7,a=bgBiome7,x=predictorsBiome7);test.train2
test.train3 <- evaluate(biome7@models[[3]],p=occtrain_biome7,a=bgBiome7,x=predictorsBiome7);test.train3
test.train4 <- evaluate(biome7@models[[4]],p=occtrain_biome7,a=bgBiome7,x=predictorsBiome7);test.train4
test.train5 <- evaluate(biome7@models[[5]],p=occtrain_biome7,a=bgBiome7,x=predictorsBiome7);test.train5
test.train6 <- evaluate(biome7@models[[6]],p=occtrain_biome7,a=bgBiome7,x=predictorsBiome7);test.train6
test.train7 <- evaluate(biome7@models[[7]],p=occtrain_biome7,a=bgBiome7,x=predictorsBiome7);test.train7
test.train8 <- evaluate(biome7@models[[8]],p=occtrain_biome7,a=bgBiome7,x=predictorsBiome7);test.train8
test.train9 <- evaluate(biome7@models[[9]],p=occtrain_biome7,a=bgBiome7,x=predictorsBiome7);test.train9
test.train10 <- evaluate(biome7@models[[10]],p=occtrain_biome7,a=bgBiome7,x=predictorsBiome7);test.train10

# test
test.test1 <- evaluate(biome7@models[[1]],p=occtest_biome7,a=bgBiome7,x=predictorsBiome7);test.test1
test.test2 <- evaluate(biome7@models[[2]],p=occtest_biome7,a=bgBiome7,x=predictorsBiome7);test.test2
test.test3 <- evaluate(biome7@models[[3]],p=occtest_biome7,a=bgBiome7,x=predictorsBiome7);test.test3
test.test4 <- evaluate(biome7@models[[4]],p=occtest_biome7,a=bgBiome7,x=predictorsBiome7);test.test4
test.test5 <- evaluate(biome7@models[[5]],p=occtest_biome7,a=bgBiome7,x=predictorsBiome7);test.test5
test.test6 <- evaluate(biome7@models[[6]],p=occtest_biome7,a=bgBiome7,x=predictorsBiome7);test.test6
test.test7 <- evaluate(biome7@models[[7]],p=occtest_biome7,a=bgBiome7,x=predictorsBiome7);test.test7
test.test8 <- evaluate(biome7@models[[8]],p=occtest_biome7,a=bgBiome7,x=predictorsBiome7);test.test8
test.test9 <- evaluate(biome7@models[[9]],p=occtest_biome7,a=bgBiome7,x=predictorsBiome7);test.test9
test.test10 <- evaluate(biome7@models[[10]],p=occtest_biome7,a=bgBiome7,x=predictorsBiome7);test.test10

# plot response curves
response(biome7@models[[5]], rug=FALSE,expand=0)# replicate with highest AUC

# plot model covariate contributions
plot(biome7@models[[5]])

# Response curves show (and derived from) the mean response of the 10 replicate Maxent runs
# access
accessbiome7<- read.csv(paste0(dir,"/output/models/biome7/plots/responsecurves/access_prj.csv"))
accessbiome7$xh <- (accessbiome7$x)*1/60
accessbiome7 <- ggplot(data= accessbiome7,aes(x=xh,y= y))+geom_line(colour="black", size=2)+xlab("")+ylab("Predicted probability")+theme_bw()+
ylim(0,1)+
facet_wrap(~ covariate, scales="free",ncol = 3)+
science_theme_facets;accessbiome7
ggsave(filename = paste0(dir,"/plots/Figure4_ExTFig4D_Biome7_Accessibility.png"),plot = accessbiome7, width =10, height = 7, dpi = 300)

# forest loss
forlossbiome7 <- read.csv(paste0(dir,"/output/models/biome7/plots/responsecurves/for_loss_JN_prj_maskf_prop.csv"))
forlossbiome7 <- ggplot(data=forlossbiome7,aes(x=x,y= y))+geom_line(colour="black", size=2)+xlab("")+ylab("")+theme_bw()+
ylim(0,1)+
facet_wrap(~ covariate, scales="free",ncol = 3)+
science_theme_facets; forlossbiome7
ggsave(filename = paste0(dir,"/plots/ExTFig3C_Biome7_ForestLoss.png"),plot = forlossbiome7, width =10, height = 7, dpi = 300)

# country income
incomebiome7 <- read.csv(paste0(dir,"/output/models/biome7/plots/responsecurves/income_Avgp_prj.csv"))
incomebiome7 <- ggplot(data=incomebiome7,aes(reorder(x= x,- y), y= y, fill=income))+
geom_bar(sta="identity",position=position_dodge(), colour="Black", fill="Black")+
xlab("")+ylab("Predicted probability")+
theme_bw()+
scale_color_viridis(discrete = TRUE,option = "D",alpha=0.7)+
scale_fill_viridis(discrete = TRUE,option = "D",alpha=0.7)+
ylim(0,1)+
facet_wrap(~ covariate, scales="free",ncol = 3)+ 
science_theme_facets;incomebiome7
ggsave(filename = paste0(dir,"/plots/Figure3_ExTFig3C_Biome7_country.png"),plot = incomebiome7, width =10, height = 7, dpi = 300)

# Number of species impacted 
spec_impactedbiome7 <-  read.csv(paste0(dir,"/output/models/biome7/plots/responsecurves/cum_hum_impact_prj.csv"))
spec_impactedbiome7 <- ggplot(data= spec_impactedbiome7,aes(x=x,y= y))+geom_line(colour="black", size=2)+xlab("")+ylab("")+theme_bw()+
ylim(0,1)+
facet_wrap(~ covariate, scales="free",ncol = 3)+
science_theme_facets;spec_impactedbiome7
ggsave(filename = paste0(dir,"/plots/Figure4_ExTFig3C_Biome7_#SpeciesImpacted.png"),plot = spec_impactedbiome7, width =10, height = 7, dpi = 300)

# Species richness
sp_richbiome7<-  read.csv(paste0(dir,"/output/models/biome7/plots/responsecurves/sp_rich_prj.csv"))
sp_richbiome7 <- ggplot(data= sp_richbiome7,aes(x=x,y= y))+geom_line(colour="black",size=2)+xlab("")+ylab("")+theme_bw()+
ylim(0,1)+
facet_wrap(~ covariate, scales="free",ncol = 3)+
science_theme_facets;sp_richbiome7
ggsave(filename = paste0(dir,"/plots/Figure4_ExTFig3C_Biome7_SpeciesRichness.png"),plot = sp_richbiome7, width =10, height = 7, dpi = 300)
 
# IUCN protection
protectionbiome7 <-  read.csv(paste0(dir,"/output/models/biome7/plots/responsecurves/wdpa_bin_prj.csv"))
dataframe <- as.data.frame.matrix(protectionbiome7)
protectionbiome7 <- ggplot(data=dataframe,aes(reorder(x= x,- y), y= y, fill=Protection))+
geom_bar(sta="identity",position=position_dodge(), colour="black", fill="black")+ylim(0,1)+
xlab("")+ylab("Predicted probability")+
theme_bw()+
facet_wrap(~ covariate, scales="free",ncol = 3)+
science_theme_facets;protectionbiome7
ggsave(filename = paste0(dir,"/plots/Figure4_ExTFig3C_Biome7_IUCNPA.png"),plot = protectionbiome7, width =10, height = 7, dpi = 300)

# IFL
IFLbiome7 <-  read.csv(paste0(dir,"/output/models/biome7/plots/responsecurves/ifl_bin_prj.csv"))
dataframe <- as.data.frame.matrix(IFLbiome7)
IFLbiome7 <- ggplot(data=dataframe,aes(reorder(x= x,- y), y= y, fill=x))+
geom_bar(sta="identity",position=position_dodge(), colour="black", fill="black")+ylim(0,1)+
xlab("")+ylab("Predicted probability")+
theme_bw()+
facet_wrap(~ covariate, scales="free",ncol = 3)+
science_theme_facets;IFLbiome7
ggsave(filename = paste0(dir,"/plots/ExTFig3C_Biome7_IFL.png"),plot = IFLbiome7, width =10, height = 7, dpi = 300)

# elevation
elevationbiome7 <- read.csv(paste0(dir,"/output/models/biome7/plots/responsecurves/elevation_prj_maskf.csv"))
elevationbiome7 <- ggplot(data=elevationbiome7,aes(x=x,y= y))+geom_line(colour="black", size=2)+xlab("")+ylab("")+theme_bw()+
ylim(0,1)+facet_wrap(~ covariate, scales="free",ncol = 3)+
science_theme_facets; elevationbiome7
ggsave(filename = paste0(dir,"/plots/ExTFig3C_Biome7_Elevation.png"),plot = elevationbiome7, width =10, height = 7, dpi = 300)

# TRI
TRIbiome7 <- read.csv(paste0(dir,"/output/models/biome7/plots/responsecurves/tri_prj_mask.csv"))
TRIbiome7 <- ggplot(data=TRIbiome7,aes(x=x,y= y))+geom_line(colour="black", size=2)+xlab("")+ylab("Predicted probability")+theme_bw()+
#theme(axis.text=element_text(size=12), axis.title=element_text(size=12))+
ylim(0,1)+facet_wrap(~ covariate, scales="free",ncol = 3)+
science_theme_facets; TRIbiome7
ggsave(filename = paste0(dir,"/plots/ExTFig3C_Biome7_TRI.png"),plot = TRIbiome7, width =10, height = 7, dpi = 300)

# with ggpubr
biome7responses <- ggarrange(incomebiome7,spec_impactedbiome7,protectionbiome7,sp_richbiome7,accessbiome7,elevationbiome7,TRIbiome7,forlossbiome7,IFLbiome7,align="v", ncol=2,nrow=5);biome7responses
ggsave(filename = paste0(dir,"/plots/ExTFig3C_Biome7_ResponseCurves.png"),plot = biome7responses, width =15, height = 18, dpi = 300)

# pie chart for permutation importance
PI7 <- data.frame(covariate = c("Country income","Species impacted","IUCN protection","Mammal richness","Others"),
  importance = c(35.9599,25.6033,15.5512,7.4977,15.388))

# Add label position
df <- PI7 %>%
  arrange(desc(importance)) %>%
  mutate(lab.ypos = cumsum(importance) - 0.5*importance)

# with ggplot
mycols7 <- c("#000000","#2F4F4F","#778899","white","#808080")

biome7_PI <- ggplot(data=df,aes(x = "", y = importance, fill=reorder(covariate,-importance))) +
geom_bar(width = 2, stat = "identity", color = "grey75",show.legend=TRUE) +
coord_polar("y", start = 0)+
labs(fill='Permutation importance')+
scale_fill_manual(values = mycols7)+
science_theme_facets+
theme_void();
biome7_PI
ggsave(filename = paste0(dir,"/plots/Figure4B2_Biome7_PI_MostImportantDrivers.png"), plot = biome7_PI, width = 10, height = 7, dpi = 300)

# make prediction
ppredictorsBiome7<- predict(biome7@models[[5]], predictorsBiome7Mask,progress='text')
plot(ppredictorsBiome7)
writeRaster(ppredictorsBiome7,filename = paste0(dir,"/output/geo-proc/Predictions/Biome7_predictionFinal.tif"))

# project to EE and write raster
biome7_prediction <- raster(paste0(dir,"/output/geo-proc/Predictions/Biome7_predictionFinal.tif"))
biome7_prediction_ee = projectRaster(Biome7_prediction, crs = crs_equal_earth, method = "bilinear")
writeRaster(biome7_prediction_ee,filename = paste0(dir,"/output/geo-proc/Predictions/Biome7_predictionFinalEE.tif"))

# with ggplot
#  Prediction too big...first aggregate it to get a lower resolution  (larger cells)
biome7_predictionFinalEE <- raster(paste0(dir,"/output/geo-proc/Predictions/Biome7_predictionFinalEE.tif"))
plot(biome7_predictionFinalEE)

biome7_prediction_agg <- raster::aggregate(biome7_predictionFinalEE,fact=5, fun=mean, expand=FALSE, na.rm=TRUE)
writeRaster(biome7_prediction_agg,paste0(dir, "/output/geo-proc/Predictions/Biome7_predictionFinal_agg.tif"))

biome7_predictionFinal_agg_5  <- raster(paste0(dir,"/output/geo-proc/Predictions/Biome7_predictionFinal_agg.tif"))
plot(biome7_predictionFinal_agg_5)
biome7_predictionFinal_agg_5_spdf <- as(biome7_predictionFinal_agg_5_spdf, "SpatialPixelsDataFrame")
biome7_predictionFinal_agg_5_df <- as.data.frame(biome7_predictionFinal_agg_5_spdf)
colnames(biome7_predictionFinal_agg_5_df) <- c("values", "x", "y")

biome7_prediction_plot <- ggplot() +
geom_tile(data=biome7_predictionFinal_agg_5_df, aes(x=x, y=y, fill=values), alpha=0.8)+
geom_sf(data = world, fill=NA, colour = "lightgray", size = 0.2)+
scale_fill_viridis(name="Predicted probabibility") +
science_theme_maps+
theme_map() +
theme(legend.position="bottom") +
theme(legend.key.width=unit(2, "cm"))
biome7_prediction_plot
Biome7prediction_plot_ee <- biome7_prediction_plot + coord_sf(crs = sf::st_crs(crs_equal_earth))
Biome7prediction_plot_ee

# extracting legend
biome7_prediction_NoNA <- as.data.frame(na.omit(values(biome7_predictionFinal_agg_5)))
head(biome7_prediction_NoNA)
my_datal <- melt(biome7_prediction_NoNA, measure.vars = "na.omit(values(biome7_predictionFinal_agg_5))", variable.name = "cell", value.name = "biome7_predictionFinal_agg_5");head(my_datal)

biome7_prediction_legend <- ggplot(my_datal, aes(x=cell, y= biome7_predictionFinal_agg_5))+
geom_point(position = position_jitter(width = 0.25), size = 0.01, alpha=0.7, aes(colour = biome7_predictionFinal_agg_5))+
geom_violin(position = position_nudge(x = 0, y = 0), alpha = 0.5, adjust =1, trim = T, width = .5, fill= "#A4A4A4")+
geom_boxplot(aes(x = cell, y = biome7_predictionFinal_agg_5), outlier.shape = NA, alpha = 0.5, width = 0.02, colour = "black")+
scale_color_viridis(discrete=F, option = "D") +
scale_fill_viridis(discrete=F, option = "D")+
ylab("")+
ylim(0, 1)+
xlab("")+
theme_update(text = element_text(size=12))+
guides(fill = FALSE, colour = FALSE) +
theme_bw()+
science_theme_facets
biome7_prediction_legend
ggsave(filename = paste0(dir,"/plots/Figure4A3_Biome7_PredictionLegend.png"),plot = biome7_prediction_legend, width =10, height = 7, dpi = 300)
```

# Biomes12 (Mediterranean Forests, Woodlands & Scrub) MaxEnt 
```{r biome 12 maxent}
# fit model:
biome12 <- maxent(predictorsBiome12, occtrain_biome12,a=bgBiome12,removeDuplicates=TRUE,factors=c("biome7_ifl","biome7_iucn_wdpa","biome7_country_income_group"), args = c('linear=true', 'quadratic=true', 'product=true', 'threshold=true', 'hinge=true','jackknife=true','outputformat=Logistic','betamultiplier=3.5','maximumiterations=5000','replicates=10','replicatetype=Crossvalidate','responsecurves','writeplotdata=true','doclamp=false'),path=paste0(dir,"/output/models/biome12"));biome12

# Model results
biome12_results <- biome12@results
write.csv(biome12_results,paste0(dir,"/output/models/biome12/Biome12_results.csv"))

# Jacknife test
AUCjktbiome12<- data.frame(driver =c("Accessibility","Number of impacted species","Elevation","Forest loss","Intact Forest Landscape","Country income group","Terrestrial mammal species richness","Terrain Ruggedness Index","IUCN protected area","With all drivers"),
                     
                        Jacknife=c("Without driver","Without driver","Without driver","Without driver","Without driver","Without driver","Without driver","Without driver","Without driver","With all drivers",
                                   
                                   "With only driver","With only driver","With only driver","With only driver","With only driver","With only driver","With only driver","With only driver","With only driver","With all drivers"),
                     
                        AUC=c(0.7769,0.7954,0.8058,0.8016,0.8066,0.7713,0.7978,0.8046,0.7892,0.8068,0.6558,0.5039,0.5,0.6261,0.504,0.6162,0.6699,0.6301,0.5527,0.8068));AUCjktbiome12

dataframebiome12 <- as.data.frame.matrix(AUCjktbiome12)

# lollipop
AUCjkt_JN <- AUCjktbiome12

# Change "Jackknife" value of "Model" 
AUCjkt_JN$Jacknife [AUCjkt_JN$driver == "With all drivers"] <- c("With only driver", "Without driver")

# reorder factor levels (adjust argument labels also - not shown here)
# entries are plotted in reverse order, i.e. Model is on top in the plot
AUCjkt_JN$driver <- factor(AUCjkt_JN$driver, levels = c("Accessibility","Number of impacted species","Elevation","Forest loss","Intact Forest Landscape","Country income group","Terrestrial mammal species richness","Terrain Ruggedness Index","IUCN protected area","With all drivers"))

# create the lollipop plot
p8 <- ggplot(AUCjkt_JN, aes(y = driver, x = AUC, fill = Jacknife)) +
geom_segment(aes(x = 0.5,y = driver, xend = AUC, yend = driver), size=2,color = "grey50") +
geom_point(aes(color=ifelse(driver %in% c("With all drivers","With all drivers"), "With all drivers",ifelse(driver %in% c("Accessibility","Number of impacted species","Elevation","Forest loss","Intact Forest Landscape","Country income group","Terrestrial mammal species richness","Terrain Ruggedness Index","IUCN protected area","With all drivers"),""))), size = 10,alpha=0.7,stroke=2,show.legend=FALSE)+
scale_color_viridis(discrete = TRUE,option = "D")+
scale_fill_viridis(discrete = TRUE,option = "D")+
labs(x="AUC", y="")+
theme_bw()+
science_theme+
xlim(0.5,1.0)+
facet_wrap(~Jacknife);p8
ggsave(filename = paste0(dir,"/plots/ExTFig4_Biome12_JackKnifeAUC.png"), plot = p8, width = 7, height = 5, dpi = 300)

# evaluate model
#train
test.train1 <- evaluate(biome12@models[[1]],p=occtrain_biome12,a=bgBiome12,x=predictorsBiome12);test.train1
test.train2 <- evaluate(biome12@models[[2]],p=occtrain_biome12,a=bgBiome12,x=predictorsBiome12);test.train2
test.train3 <- evaluate(biome12@models[[3]],p=occtrain_biome12,a=bgBiome12,x=predictorsBiome12);test.train3
test.train4 <- evaluate(biome12@models[[4]],p=occtrain_biome12,a=bgBiome12,x=predictorsBiome12);test.train4
test.train5 <- evaluate(biome12@models[[5]],p=occtrain_biome12,a=bgBiome12,x=predictorsBiome12);test.train5
test.train6 <- evaluate(biome12@models[[6]],p=occtrain_biome12,a=bgBiome12,x=predictorsBiome12);test.train6
test.train7 <- evaluate(biome12@models[[7]],p=occtrain_biome12,a=bgBiome12,x=predictorsBiome12);test.train7
test.train8 <- evaluate(biome12@models[[8]],p=occtrain_biome12,a=bgBiome12,x=predictorsBiome12);test.train8
test.train9 <- evaluate(biome12@models[[9]],p=occtrain_biome12,a=bgBiome12,x=predictorsBiome12);test.train9
test.train10 <- evaluate(biome12@models[[10]],p=occtrain_biome12,a=bgBiome12,x=predictorsBiome12);test.train10

# test
test.test1 <- evaluate(biome12@models[[1]],p=occtest_biome12,a=bgBiome12,x=predictorsBiome12);test.test1
test.test2 <- evaluate(biome12@models[[2]],p=occtest_biome12,a=bgBiome12,x=predictorsBiome12);test.test2
test.test3 <- evaluate(biome12@models[[3]],p=occtest_biome12,a=bgBiome12,x=predictorsBiome12);test.test3
test.test4 <- evaluate(biome12@models[[4]],p=occtest_biome12,a=bgBiome12,x=predictorsBiome12);test.test4
test.test5 <- evaluate(biome12@models[[5]],p=occtest_biome12,a=bgBiome12,x=predictorsBiome12);test.test5
test.test6 <- evaluate(biome12@models[[6]],p=occtest_biome12,a=bgBiome12,x=predictorsBiome12);test.test6
test.test7 <- evaluate(biome12@models[[7]],p=occtest_biome12,a=bgBiome12,x=predictorsBiome12);test.test7
test.test8 <- evaluate(biome12@models[[8]],p=occtest_biome12,a=bgBiome12,x=predictorsBiome12);test.test8
test.test9 <- evaluate(biome12@models[[9]],p=occtest_biome12,a=bgBiome12,x=predictorsBiome12);test.test9
test.test10 <- evaluate(biome12@models[[10]],p=occtest_biome12,a=bgBiome12,x=predictorsBiome12);test.test10

# plot response curves
response(biome12@models[[6]], rug=FALSE,expand=0)# replicate with highest AUC

# plot model covariate contributions
plot(biome12@models[[6]])

# Response curves show (and derived from) the mean response of the 10 replicate Maxent runs
# access
accessbiome12<- read.csv(paste0(dir,"/output/models/biome12/plots/responsecurves/access_prj_only.csv"))
accessbiome12$xh <- (accessbiome12$x)*1/60
accessbiome12 <- ggplot(data= accessbiome12,aes(x=xh,y= y))+geom_line(colour="black", size=2)+xlab("")+ylab("")+theme_bw()+
ylim(0,1)+
facet_wrap(~ covariate, scales="free",ncol = 3)+
science_theme_facets;accessbiome12
ggsave(filename = paste0(dir,"/plots/Figure4_ExTFig3D_Biome12_Accessibility.png"),plot = accessbiome12, width =10, height = 7, dpi = 300)

# forest loss
forlossbiome12 <- read.csv(paste0(dir,"/output/models/biome12/plots/responsecurves/for_loss_JN_prj_maskf_prop.csv"))
forlossbiome12 <- ggplot(data=forlossbiome12,aes(x=x,y= y))+geom_line(colour="black", size=2)+xlab("")+ylab("")+theme_bw()+
facet_wrap(~ covariate, scales="free",ncol = 3)+
#theme(axis.text=element_text(size=12), axis.title=element_text(size=12))+
ylim(0,1)+science_theme_facets;forlossbiome12
ggsave(filename = paste0(dir,"/plots/ExTFig3E_Biome12_ForestLOss.png"),plot = forlossbiome12, width =10, height = 7, dpi = 300)

# country income
incomebiome12 <- read.csv(paste0(dir,"/output/models/biome12/plots/responsecurves/income_Avgp_prj.csv"))
incomebiome12 <- ggplot(data=incomebiome12,aes(reorder(x= x,- y), y= y, fill=income))+
geom_bar(sta="identity",position=position_dodge(), colour="Black", fill="Black")+
xlab("")+ylab("Predicted probability")+
theme_bw()+
scale_color_viridis(discrete = TRUE,option = "D",alpha=0.7)+
scale_fill_viridis(discrete = TRUE,option = "D",alpha=0.7)+
ylim(0,1)+
facet_wrap(~ covariate, scales="free",ncol = 3)+ 
science_theme_facets;incomebiome12
ggsave(filename = paste0(dir,"/plots/Figure4_ExTFig3D_Biome12_country.png"),plot = incomebiome12, width =10, height = 7, dpi = 300)

# Number of species impacted 
spec_impactedbiome12<-  read.csv(paste0(dir,"/output/models/biome12/plots/responsecurves/cum_hum_impact_prj.csv"))
spec_impactedbiome12 <- ggplot(data= spec_impactedbiome12,aes(x=x,y= y))+geom_line(colour="black", size=2)+xlab("")+ylab("Predicted probability")+theme_bw()+
ylim(0,1)+
facet_wrap(~ covariate, scales="free",ncol = 3)+
science_theme_facets;spec_impactedbiome12
ggsave(filename = paste0(dir,"/plots/Figure4_ExTFig3D_Biome12_#SpeciesImpacted.png"),plot = spec_impactedbiome12, width =10, height = 7, dpi = 300)

# Species richness
sp_richbiome12<-  read.csv(paste0(dir,"/output/models/biome12/plots/responsecurves/sp_rich_prj.csv"))
sp_richbiome12 <- ggplot(data= sp_richbiome12,aes(x=x,y= y))+geom_line(colour="black",size=2)+xlab("")+ylab("Predicted probability")+theme_bw()+
ylim(0,1)+
facet_wrap(~ covariate, scales="free",ncol = 3)+
science_theme_facets;sp_richbiome12
ggsave(filename = paste0(dir,"/plots/Figure4_ExTFig3D_Biome12_SpeciesRichness.png"),plot = sp_richbiome12, width =10, height = 7, dpi = 300)

# IUCN protection
protectionbiome12 <-  read.csv(paste0(dir,"/output/models/biome12/plots/responsecurves/wdpa_bin_prj.csv"))
protectionbiome12 <- ggplot(data=protectionbiome12,aes(reorder(x= x,- y), y= y, fill=x))+
geom_bar(sta="identity",position=position_dodge(), colour="black", fill="black")+ylim(0,1)+
xlab("")+ylab("")+
theme_bw()+
facet_wrap(~ covariate, scales="free",ncol = 3)+
science_theme_facets;protectionbiome12
ggsave(filename = paste0(dir,"/plots/ExTFig3D_Biome12_IUCNPA.png"),plot = protectionbiome12, width =10, height = 7, dpi = 300)

# IFL
IFLbiome12 <-  read.csv(paste0(dir,"/output/models/biome12/plots/responsecurves/ifl_bin_prj.csv"))
IFLbiome12 <- ggplot(data=IFLbiome12,aes(reorder(x= x,- y), y= y, fill=x))+
geom_bar(sta="identity",position=position_dodge(), colour="black", fill="black")+ylim(0,1)+
xlab("")+ylab("Predicted probability")+
theme_bw()+
facet_wrap(~ covariate, scales="free",ncol = 3)+
science_theme_facets;IFLbiome12
ggsave(filename = paste0(dir,"/plots/ExTFig3D_Biome12_IFL.png"),plot = IFLbiome12, width =10, height = 7, dpi = 300)

# elevation
elevationbiome12 <- read.csv(paste0(dir,"/output/models/biome12/plots/responsecurves/elevation_prj_maskf.csv"))
elevationbiome12 <- ggplot(data=elevationbiome12,aes(x=x,y= y))+geom_line(colour="black", size=2)+xlab("")+ylab("Predicted suitability")+theme_bw()+
facet_wrap(~ covariate, scales="free",ncol = 3)+
ylim(0,1)+science_theme_facets; elevationbiome12
ggsave(filename = paste0(dir,"/plots/ExTFig3D_Biome12_Elevation.png"),plot = elevationbiome12, width =10, height = 7, dpi = 300)

# TRI
TRIbiome12 <- read.csv(paste0(dir,"/output/models/biome12/plots/responsecurves/tri_prj_mask.csv"))
TRIbiome12 <- ggplot(data=TRIbiome12,aes(x=x,y= y))+geom_line(colour="black", size=2)+xlab("")+ylab("Predicted probability")+theme_bw()+
ylim(0,1)+
facet_wrap(~ covariate, scales="free",ncol = 3)+
science_theme_facets; TRIbiome12
ggsave(filename = paste0(dir,"/plots/ExTFig3D_Biome12_TRI.png"),plot = TRIbiome12, width =10, height = 7, dpi = 300)

# with ggpubr
biome12responses <- ggarrange(incomebiome12,accessbiome12,spec_impactedbiome12,protectionbiome12,sp_richbiome12,forlossbiome12,TRIbiome12,elevationbiome12,IFLbiome12,align="v", ncol=2,nrow=5);biome12responses
ggsave(filename = paste0(dir,"/plots/ExTFig3D_Biome12_ResponseCurves.png"),plot = biome12responses, width =15, height = 18, dpi = 300)

# Pie chart for permutation importance
PI <- data.frame(covariate = c("Country income","Accessibility","Species impacted","IUCN protection","Others"),
  importance = c(32.9313,27.1145,14.4269,9.2426,16.2847))

# Add label position
df <- PI %>%
  arrange(desc(importance)) %>%
  mutate(lab.ypos = cumsum(importance) - 0.5*importance)

# with ggplot
mycols <- c("#000000","#2F4F4F","white","#778899","#808080")

biome12_PI <- ggplot(data=df,aes(x = "", y = importance, fill=reorder(covariate,-importance))) +
  geom_bar(width = 2, stat = "identity", color = "grey75",show.legend=TRUE) +
  coord_polar("y", start = 0)+
  labs(fill='Permutation importance')+
  #geom_text(aes(y = lab.ypos, label = importance), color = "white")+
  scale_fill_manual(values = mycols)+
  science_theme_facets+
  theme_void();
  biome12_PI
ggsave(filename = paste0(dir,"/plots/Figure4B4_Biome12_PI_MostImportantDrivers.png"), plot = biome12_PI, width = 10, height = 7, dpi = 300)

# make prediction
ppredictorsbiome12<- predict(biome12@models[[6]], predictorsBiome12Mask,progress='text')
plot(ppredictorsbiome12)
writeRaster(ppredictorsbiome12,filename = paste0(dir,"/output/geo-proc/Predictions/biome12_predictionFinal.tif"))

# project to EE and write raster
biome12_prediction <- raster(paste0(dir,"/output/geo-proc/Predictions/Biome12_predictionFinal.tif"))
biome12_prediction_ee = projectRaster(biome12_prediction, crs = crs_equal_earth, method = "bilinear")
writeRaster(Biome12_prediction_ee,filename = paste0(dir,"/output/geo-proc/Predictions/Biome12_predictionFinalEE.tif"))

# with ggplot
# Prediction too big...first aggregate it to get a lower resolution  (larger cells)
biome12_predictionFinalEE <- raster(paste0(dir,"/output/geo-proc/Predictions/Biome12_predictionFinalEE.tif"))
plot(biome12_predictionFinalEE)

biome12_prediction_agg <- raster::aggregate(biome12_prediction,fact=5, fun=mean, expand=FALSE, na.rm=TRUE);writeRaster(biome12_prediction_agg,paste0(dir, "/output/geo-proc/Predictions/biome12_predictionFinal_agg.tif"))

biome12_prediction_agg_5  <- raster(paste0(dir,"/output/geo-proc/Predictions/biome12_predictionFinal_agg.tif"))
plot(biome12_prediction_agg_5)
biome12_prediction_agg_5_spdf <- as(biome12_prediction_agg_5, "SpatialPixelsDataFrame")
biome12_prediction_agg_5_df <- as.data.frame(biome12_prediction_agg_5_spdf)
colnames(biome12_prediction_agg_5_df) <- c("values", "x", "y")

biome12_prediction_plot <- ggplot() +
geom_tile(data=biome12_prediction_agg_5_df, aes(x=x, y=y, fill=values), alpha=0.8)+
geom_sf(data = world, fill=NA, colour = "lightgray", size = 0.2)+
scale_fill_viridis(name="Predicted probabibility") +
science_theme_maps+
theme_map() +
theme(legend.position="bottom") +
theme(legend.key.width=unit(2, "cm"))
biome12_prediction_plot
Biome12prediction_plot_ee <- biome12_prediction_plot + coord_sf(crs = sf::st_crs(crs_equal_earth))
Biome12prediction_plot_ee

# extracting legend
biome12_prediction_NoNA <- as.data.frame(na.omit(values(biome12_prediction_agg_5))); head(biome12_prediction_NoNA)
my_data12 <- melt(biome12_prediction_NoNA, measure.vars = "na.omit(values(biome12_prediction_agg_5))", variable.name = "cell", value.name = "biome12_prediction_agg_5");head(my_data12)

biome12_prediction_legend <- ggplot(my_data12, aes(x=cell, y= biome12_prediction_agg_5))+
geom_point(position = position_jitter(width = 0.25), size = 0.01, alpha=0.7, aes(colour = biome12_prediction_agg_5))+
geom_violin(position = position_nudge(x = 0, y = 0), alpha = 0.5, adjust =1, trim = T, width = .5, fill= "#A4A4A4")+
geom_boxplot(aes(x = cell, y = biome12_prediction_agg_5), outlier.shape = NA, alpha = 0.5, width = 0.02, colour = "black")+
scale_color_viridis(discrete=F, option = "D") +
scale_fill_viridis(discrete=F, option = "D")+
ylab("")+
ylim(0, 1)+
xlab("")+
theme_update(text = element_text(size=12))+
guides(fill = FALSE, colour = FALSE) +
theme_bw()+
science_theme_facets
biome12_prediction_legend
ggsave(filename = paste0(dir,"/plots/Figure4A4_Biome12_PredictionLegend.png"),plot = biome12_prediction_legend, width =10, height = 7, dpi = 300)
```

# Biome4 (Temperate Broadleaf & Mixed Forests) MaxEnt
```{r biome 4 maxent}
biome4 <- maxent(predictorsBiome4,occtrain_biome4,a=bgBiome4,removeDuplicates=TRUE,factors=c("biome4_ifl","biome4_iucn_wdpa","biome4_country_income_group"), args = c('jackknife=true','outputformat=Logistic','linear=true','maximumiterations=5000','betamultiplier=4.0','replicates=10','replicatetype=Crossvalidate','responsecurves','writeplotdata=true','doclamp=FALSE'),path=paste0(dir,"/output/models/biome4"));biome4

# Model results
biome4_results <- biome4@results
write.csv(biome4_results,paste0(dir,"/output/models/biome4/biome4_results.csv"))

# Jacknife test
AUCjktbiome4<- data.frame(driver =c("Accessibility","Number of impacted species","Elevation","Forest loss","Intact Forest Landscape","Country income group","Terrestrial mammal species richness","Terrain Ruggedness Index","IUCN protected area","With all drivers"),
                     
                        Jacknife=c("Without driver","Without driver","Without driver","Without driver","Without driver","Without driver","Without driver","Without driver","Without driver","With all drivers","With only driver","With only driver","With only driver","With only driver","With only driver","With only driver","With only driver","With only driver","With only driver","With all drivers"),
                     
                        AUC=c(0.7749,0.7887,0.7895,0.7896,0.7898,0.7462,0.7795,0.7767,0.7687,0.7893,0.5887,0.522,0.5487,0.5659,0.5,0.6472,0.6276,0.6352,0.5904,0.7893));AUCjktbiome4
        
# lollipop
AUCjkt_JN <- AUCjktbiome4

# Change "Jackknife" value of "Model" 
AUCjkt_JN$Jacknife [AUCjkt_JN$driver == "With all drivers"] <- c("With only driver", "Without driver")

# reorder factor levels (adjust argument labels also - not shown here)
# entries are plotted in reverse order, i.e. Model is on top in the plot
AUCjkt_JN$driver <- factor(AUCjkt_JN$driver, levels = c("Accessibility","Number of impacted species","Elevation","Forest loss","Intact Forest Landscape","Country income group","Terrestrial mammal species richness","Terrain Ruggedness Index","IUCN protected area","With all drivers"))

# create the lollipop plot
p6 <- ggplot(AUCjkt_JN, aes(y = driver, x = AUC, fill = Jacknife)) +
geom_segment(aes(x = 0.5,y = driver, xend = AUC, yend = driver), size=2,color = "grey50") +
geom_point(aes(color=ifelse(driver %in% c("With all drivers","With all drivers"), "With all drivers",ifelse(driver %in% c("Accessibility","Number of impacted species","Elevation","Forest loss","Intact Forest Landscape","Country income group","Terrestrial mammal species richness","Terrain Ruggedness Index","IUCN protected area","With all drivers"),""))), size = 10,alpha=0.7,stroke=2,show.legend=FALSE)+
scale_color_viridis(discrete = TRUE,option = "D")+
scale_fill_viridis(discrete = TRUE,option = "D")+
labs(x="AUC", y="Predictors")+
theme_bw()+
science_theme+
xlim(0.5,1.0)+
facet_wrap(~Jacknife);p6
ggsave(filename = paste0(dir,"/plots/ExTFig4_Biome4_JackKnifeAUC.png"), plot = p6, width = 7, height = 5, dpi = 300)

# evaluate model
#train
test.train1 <- evaluate(biome4@models[[1]],p=occtrain_biome4,a=bgBiome4,x=predictorsBiome4);test.train1
test.train2 <- evaluate(biome4@models[[2]],p=occtrain_biome4,a=bgBiome4,x=predictorsBiome4);test.train2
test.train3 <- evaluate(biome4@models[[3]],p=occtrain_biome4,a=bgBiome4,x=predictorsBiome4);test.train3
test.train4 <- evaluate(biome4@models[[4]],p=occtrain_biome4,a=bgBiome4,x=predictorsBiome4);test.train4
test.train5 <- evaluate(biome4@models[[5]],p=occtrain_biome4,a=bgBiome4,x=predictorsBiome4);test.train5
test.train6 <- evaluate(biome4@models[[6]],p=occtrain_biome4,a=bgBiome4,x=predictorsBiome4);test.train6
test.train7 <- evaluate(biome4@models[[7]],p=occtrain_biome4,a=bgBiome4,x=predictorsBiome4);test.train7
test.train8 <- evaluate(biome4@models[[8]],p=occtrain_biome4,a=bgBiome4,x=predictorsBiome4);test.train8
test.train9 <- evaluate(biome4@models[[9]],p=occtrain_biome4,a=bgBiome4,x=predictorsBiome4);test.train9
test.train10 <- evaluate(biome4@models[[10]],p=occtrain_biome4,a=bgBiome4,x=predictorsBiome4);test.train10

# test
test.test1 <- evaluate(biome4@models[[1]],p=occtest_biome4,a=bgBiome4,x=predictorsBiome4);test.test1
test.test2 <- evaluate(biome4@models[[2]],p=occtest_biome4,a=bgBiome4,x=predictorsBiome4);test.test2
test.test3 <- evaluate(biome4@models[[3]],p=occtest_biome4,a=bgBiome4,x=predictorsBiome4);test.test3
test.test4 <- evaluate(biome4@models[[4]],p=occtest_biome4,a=bgBiome4,x=predictorsBiome4);test.test4
test.test5 <- evaluate(biome4@models[[5]],p=occtest_biome4,a=bgBiome4,x=predictorsBiome4);test.test5
test.test6 <- evaluate(biome4@models[[6]],p=occtest_biome4,a=bgBiome4,x=predictorsBiome4);test.test6
test.test7 <- evaluate(biome4@models[[7]],p=occtest_biome4,a=bgBiome4,x=predictorsBiome4);test.test7
test.test8 <- evaluate(biome4@models[[8]],p=occtest_biome4,a=bgBiome4,x=predictorsBiome4);test.test8
test.test9 <- evaluate(biome4@models[[9]],p=occtest_biome4,a=bgBiome4,x=predictorsBiome4);test.test9
test.test10 <- evaluate(biome4@models[[10]],p=occtest_biome4,a=bgBiome4,x=predictorsBiome4);test.test10

# plot response curves
response(biome4@models[[1]], rug=FALSE,expand=0)# replicate with highest AUC

# plot model covariate contributions
plot(biome4@models[[1]])

# Response curves show (and derived from) the mean response of the 10 replicate Maxent runs
# access
accessbiome4<- read.csv(paste0(dir,"/output/models/biome4/plots/responsecurves/access_prj.csv"))
accessbiome4$xh <- (accessbiome4$x)*1/60
accessbiome4_plot <- ggplot(data= accessbiome4,aes(x=xh,y= y))+geom_line(colour="black", size=2)+
xlab("")+ylab("Predicted probability")+
theme_bw()+
ylim(0,1)+
facet_wrap(~ covariate, scales="free",ncol = 3)+
science_theme_facets
accessbiome4_plot
ggsave(filename = paste0(dir,"/plots/Figure4_ExTFig4E_Biome4_Accessibility.png"),plot = accessbiome4_plot, width =10, height = 7, dpi = 300)

# forest loss
forlossbiome4 <- read.csv(paste0(dir,"/output/models/biome4/plots/responsecurves/for_loss_JN_prj_maskf_prop.csv"))
forlossbiome4_plot <- ggplot(data=forlossbiome4,aes(x=x,y= y))+geom_line(colour="black", size=2)+xlab("")+ylab("")+theme_bw()+
ylim(0,1)+
facet_wrap(~ covariate, scales="free",ncol = 3)+
science_theme_facets; forlossbiome4_plot
ggsave(filename = paste0(dir,"/plots/ExTFig4E_Biome4_ForestLoss.png"),plot = forlossbiome4_plot, width =10, height = 7, dpi = 300)

# country income
incomebiome4 <- read.csv(paste0(dir,"/output/models/biome4/plots/responsecurves/income_Avgp_prj.csv"))
incomebiome4_plot <- ggplot(data=incomebiome4,aes(reorder(x= x,- y), y= y, fill=income))+
geom_bar(sta="identity",position=position_dodge(), colour="Black", fill="Black")+
xlab("")+ylab("Predicted probability")+
theme_bw()+
scale_color_viridis(discrete = TRUE,option = "D",alpha=0.7)+
scale_fill_viridis(discrete = TRUE,option = "D",alpha=0.7)+
ylim(0,1)+
facet_wrap(~ covariate, scales="free",ncol = 3)+ 
science_theme_facets;incomebiome4_plot
ggsave(filename = paste0(dir,"/plots/Figure4_ExTFig4E_Biome4_country.png"),plot = incomebiome4_plot, width =10, height = 7, dpi = 300)

# Number of species impacted 
spec_impactedbiome4 <-  read.csv(paste0(dir,"/output/models/biome4/plots/responsecurves/cum_hum_impact_prj.csv"))
spec_impactedbiome4_plot <- ggplot(data= spec_impactedbiome4,aes(x=x,y= y))+geom_line(colour="black", size=2)+xlab("")+ylab("")+theme_bw()+
ylim(0,1)+
facet_wrap(~ covariate, scales="free",ncol = 3)+
science_theme_facets;spec_impactedbiome4_plot
ggsave(filename = paste0(dir,"/plots/ExTFig4E_Biome4_#SpeciesImpacted.png"),plot = spec_impactedbiome4_plot, width =10, height = 7, dpi = 300)

# Species richness
sp_richbiome4<-  read.csv(paste0(dir,"/output/models/biome4/plots/responsecurves/sp_rich_prj.csv"))
sp_richbiome4_plot <- ggplot(data= sp_richbiome4,aes(x=x,y= y))+geom_line(colour="black",size=2)+
xlab("")+ylab("Predicted probability")+
theme_bw()+
ylim(0,1)+
facet_wrap(~ covariate, scales="free",ncol = 3)+
science_theme_facets;sp_richbiome4_plot
ggsave(filename = paste0(dir,"/plots/ExTFig4E_Biome4_SpeciesRichness.png"),plot = sp_richbiome4_plot, width =10, height = 7, dpi = 300)

# IUCN protection
protectionbiome4 <-  read.csv(paste0(dir,"/output/models/biome4/plots/responsecurves/wdpa_bin_prj_only.csv"))
protectionbiome4_plot <- ggplot(data=protectionbiome4,aes(reorder(x= x,- y), y= y, fill=x))+
geom_bar(sta="identity",position=position_dodge(), colour="black", fill="black")+ylim(0,1)+
xlab("")+ylab("")+
theme_bw()+
facet_wrap(~ covariate, scales="free",ncol = 3)+
science_theme_facets;protectionbiome4_plot
ggsave(filename = paste0(dir,"/plots/Figure4E_ExTFig4E_Biome4_IUCNPA.png"),plot = protectionbiome4_plot, width =10, height = 7, dpi = 300)

# IFL
IFLbiome4 <-  read.csv(paste0(dir,"/output/models/biome4/plots/responsecurves/ifl_bin_prj.csv"))
IFLbiome4_plot <- ggplot(data=IFLbiome4,aes(reorder(x= x,- y), y= y, fill=x))+
geom_bar(sta="identity",position=position_dodge(), colour="black", fill="black")+ylim(0,1)+
xlab("")+ylab("Predicted probability")+
theme_bw()+
facet_wrap(~ covariate, scales="free",ncol = 3)+
science_theme_facets;IFLbiome4_plot
ggsave(filename = paste0(dir,"/plots/ExTFig4E_Biome4_IFL.png"),plot = IFLbiome4_plot, width =10, height = 7, dpi = 300)

# elevation
elevationbiome4 <- read.csv(paste0(dir,"/output/models/biome4/plots/responsecurves/elevation_prj_maskf.csv"))
elevationbiome4_plot <- ggplot(data=elevationbiome4,aes(x=x,y= y))+geom_line(colour="black", size=2)+xlab("")+ylab("Predicted probability")+theme_bw()+
ylim(0,1)+
facet_wrap(~ covariate, scales="free",ncol = 3)+
science_theme_facets;elevationbiome4_plot
ggsave(filename = paste0(dir,"/plots/ExTFig4E_Biome4_Elevation.png"),plot = elevationbiome4_plot, width =10, height = 7, dpi = 300)

# TRI
TRIbiome4 <- read.csv(paste0(dir,"/output/models/biome4/plots/responsecurves/tri_prj_mask.csv"))
TRIbiome4_plot <- ggplot(data=TRIbiome4,aes(x=x,y= y))+geom_line(colour="black", size=2)+xlab("")+ylab("")+theme_bw()+
ylim(0,1)+
facet_wrap(~ covariate, scales="free",ncol = 3)+
science_theme_facets;TRIbiome4_plot
ggsave(filename = paste0(dir,"/plots/Figure4E_ExTFig4E_Biome4_TRI.png"),plot = TRIbiome4_plot, width =10, height = 7, dpi = 300)

# with ggpubr
biome4responses <- ggarrange(incomebiome4_plot,TRIbiome4_plot,accessbiome4_plot,protectionbiome4_plot,sp_richbiome4_plot,spec_impactedbiome4_plot,IFLbiome4_plot,forlossbiome4_plot,elevationbiome4_plot,align="v", ncol=2,nrow=5);biome4responses
ggsave(filename = paste0(dir,"/plots/ExTFig4E_Biome4_ResponseCurves.png"),plot = biome4responses, width =15, height = 18, dpi = 300)

# pie chart for permutation importance
PI <- data.frame(covariate = c("Country income","TRI","Accessibility","IUCN protected area","Others"),
  importance = c(47.2422,23.1417,11.7065,10.9071,7.0026))

# Add label position
df <- PI %>%
  arrange(desc(importance)) %>%
  mutate(lab.ypos = cumsum(importance) - 0.5*importance)

# with ggplot
mycols <- c("#000000","#2F4F4F","#778899","#808080","white")

biome4_PI <- ggplot(data=df,aes(x = "", y = importance, fill=reorder(covariate,-importance))) +
geom_bar(width = 2, stat = "identity", color = "grey75",show.legend=TRUE) +
coord_polar("y", start = 0)+
labs(fill='Permutation importance')+
scale_fill_manual(values = mycols)+
science_theme_facets+
theme_void();
biome4_PI
ggsave(filename = paste0(dir,"/plots/Figure4B2_Biome4_PI_MostImportantDrivers.png"), plot = biome4_PI, width = 10, height = 7, dpi = 300)

# make prediction
ppredictorsbiome4<- predict(biome4@models[[1]], predictorsBiome4Mask,progress='text')
plot(ppredictorsbiome4)
writeRaster(ppredictorsbiome4,filename = paste0(dir,"/output/geo-proc/predictions/Biome4_predictionFinal.tif"))

# with ggplot
# project to EE and write raster
biome4_prediction <- raster(paste0(dir,"/output/geo-proc/predictions/Biome4_predictionFinal.tif"))
biome4_prediction_ee = projectRaster(Biome4_prediction, crs = crs_equal_earth, method = "bilinear")
writeRaster(biome4_prediction_ee,filename = paste0(dir,"/output/geo-proc/predictions/Biome4_predictionFinalEE.tif"))

#  Prediction too big...first aggregate it to get a lower resolution  (larger cells)
biome4_predictionFinalEE <- raster(paste0(dir,"/output/geo-proc/predictions/Biome4_predictionFinalEE.tif"))
plot(biome4_predictionFinalEE)
biome4_prediction_agg <- raster::aggregate(biome4_prediction,fact=5, fun=mean, expand=FALSE, na.rm=TRUE);writeRaster(biome4_prediction_agg,paste0(dir, "/output/geo-proc/predictions/biome4_prediction_agg.tif"))

biome4_prediction_agg_5  <- raster(paste0(dir,"/output/geo-proc/predictions/biome4_prediction_agg.tif"))
plot(biome4_prediction_agg_5)
biome4_prediction_agg_5_spdf <- as(biome4_prediction_agg_5, "SpatialPixelsDataFrame")
biome4_prediction_agg_5_df <- as.data.frame(biome4_prediction_agg_5_spdf)
colnames(biome4_prediction_agg_5_df) <- c("values", "x", "y")

biome4_prediction_plot <- ggplot() +
geom_tile(data=biome4_prediction_agg_5_df, aes(x=x, y=y, fill=values), alpha=0.8)+
geom_sf(data = world, fill=NA, colour = "lightgray", size = 0.2)+
scale_fill_viridis(name="Predicted probabibility") +
science_theme_maps+
theme_map() +
theme(legend.position="bottom") +
theme(legend.key.width=unit(2, "cm"))
biome4_prediction_plot
Biome4prediction_plot_ee <- biome4_prediction_plot + coord_sf(crs = sf::st_crs(crs_equal_earth))
Biome4prediction_plot_ee

# extracting legend
biome4prediction_NoNA <- as.data.frame(na.omit(values(biome4_prediction_agg_5))); head(biome4prediction_NoNA)
my_data4 <- melt(biome4prediction_NoNA, measure.vars = "na.omit(values(biome4_prediction_agg_5))", variable.name = "cell", value.name = "biome4_prediction_agg_5");head(my_data4)

biome4_prediction_legend <- ggplot(my_data4, aes(x=cell, y= biome4_prediction_agg_5))+
geom_point(position = position_jitter(width = 0.25), size = 0.01, alpha=0.7, aes(colour = biome4_prediction_agg_5))+
geom_violin(position = position_nudge(x = 0, y = 0), alpha = 0.5, adjust =1, trim = T, width = .5, fill= "#A4A4A4")+
geom_boxplot(aes(x = cell, y = biome4_prediction_agg_5), outlier.shape = NA, alpha = 0.5, width = 0.02, colour = "black")+
scale_color_viridis(discrete=F, option = "D") +
scale_fill_viridis(discrete=F, option = "D")+
ylab("")+
ylim(0, 1)+
xlab("")+
theme_update(text = element_text(size=12))+
guides(fill = FALSE, colour = FALSE) +
theme_bw()+
science_theme_facets
biome4_prediction_legend
ggsave(filename = paste0(dir,"/plots/Figure3A2_Biome4_PredictionLegend.png"),plot = biome4_prediction_plot, width =10, height = 7, dpi = 300)
```

# Creating an 'Aichi map': Biome 1 (Tropical & Subtropical Moist Broadleaf Forests)
```{r biome 1 Aichi map}

# normalize covariates
accessBiome1_norm <- normalizeRaster(biome1_access)
cum_hum_impactBiome1_norm <- normalizeRaster(biome1_cum_hum_impact)
for_lossBiome1_norm <- normalizeRaster(biome1_forloss)
sp_richBiome1_norm <- normalizeRaster(biome1_sp_rich)
incomeBiome1_norm <- normalizeRaster(biome1_income)

# take inverse of income_norm because it has a negative association with aichi targets
incomeBiome1_norm_inverse <- 1-incomeBiome1_norm

# create aichi covariate raster stack
Biome1aichi_covs_norm <- stack(accessBiome1_norm,cum_hum_impactBiome1_norm,for_lossBiome1_norm,incomeBiome1_norm_inverse,sp_richBiome1_norm)

# now add here the weights
weights <- c(1,2,1,1,2)

# calculate weighted mean on the stack
aichi_map_biome1 <- weighted.mean(x = Biome1aichi_covs_norm, w = weights)

# write the weighted raster as the “aichi map"
writeRaster(aichi_map_biome1,filename = paste0(dir,"/output/geo-proc/aichi-maps/Biome1aichi_mapFinalTEST.tif"))

# load in the Biome1 aichi map
aichibiome1_map_ras <- raster(paste0(dir,"/output/geo-proc/aichi-maps/Biome1aichi_mapFinalTEST.tif"))
plot(aichibiome1_map_ras)

# project and write raster
aichibiome1_map_ras_ee = projectRaster(aichibiome1_map_ras, crs = crs_equal_earth, method = "bilinear")
writeRaster(aichibiome1_map_ras_ee,filename = paste0(dir,"/output/geo-proc/aichi-maps/Biome1aichi_map_FinalEETEST.tif"))

aichibiome1_ee <- raster(paste0(dir,"/output/geo-proc/aichi-maps/Biome1aichi_map_FinalEETEST.tif"))
plot(aichibiome1_ee)
```

# Creating an 'Aichi map': Biome 7 (Tropical & Subtropical Grasslands, Savannah and Shrubs)
```{r biome 7 Aichi map}

# normalize covariates
accessBiome7_norm <- normalizeRaster(biome7_access)
cum_hum_impactBiome7_norm <- normalizeRaster(biome7_cum_hum_impact)
for_lossBiome7_norm <- normalizeRaster(biome7_forloss)
sp_richBiome7_norm <- normalizeRaster(biome7_sp_rich)
incomeBiome7_norm <- normalizeRaster(biome7_income)

# take inverse of income_norm because it has a negative association with aichi targets
incomeBiome7_norm_inverse <- 1-incomeBiome7_norm

# create aichi covariate raster stack
Biome7aichi_covs_norm <- stack(accessBiome7_norm,cum_hum_impactBiome7_norm,for_lossBiome7_norm,incomeBiome7_norm_inverse,sp_richBiome7_norm)

# now add here the weights
weights <- c(1,2,1,1,2)

# calculate weighted mean on the stack
aichi_map_biome7 <- weighted.mean(x = Biome7aichi_covs_norm, w = weights)

# write the weighted raster as the “aichi map"
writeRaster(aichi_map_biome7,filename = paste0(dir,"/output/geo-proc/aichi-maps/Biome7aichi_mapFinal.tif"))

# load in the Biome4 aichi map
aichibiome7_map_ras <- raster(paste0(dir,"/output/geo-proc/aichi-maps/Biome7aichi_mapFinal.tif"))
plot(aichibiome7_map_ras)

# project and write raster
aichibiome7_map_ras_ee = projectRaster(aichibiome7_map_ras, crs = crs_equal_earth, method = "bilinear")
writeRaster(aichibiome7_map_ras_ee,filename = paste0(dir,"/output/geo-proc/aichi-maps/Biome7aichi_map_FinalEE.tif"))

aichibiome7_ee <- raster(paste0(dir,"/output/geo-proc/aichi-maps/Biome7aichi_map_FinalEE.tif"))
plot(aichibiome7_ee)
```

# Creating an 'Aichi map': Biome 12 (Mediterranean Forests, Woodlands & Scrub)
```{r biome 12 Aichi map}

# normalize covariates
accessBiome12_norm <- normalizeRaster(biome12_access)
cum_hum_impactBiome12_norm <- normalizeRaster(biome12_cum_hum_impact)
for_lossBiome12_norm <- normalizeRaster(biome12_forloss)
sp_richBiome12_norm <- normalizeRaster(biome12_sp_rich)
incomeBiome12_norm <- normalizeRaster(incomeBiome12)

# take inverse of income_norm because it has a negative association with aichi targets
incomeBiome12_norm_inverse <- 1-incomeBiome12_norm

# create aichi covariate raster stack
Biome12aichi_covs_norm <- stack(accessBiome12_norm,cum_hum_impactBiome12_norm,for_lossBiome12_norm,incomeBiome12_norm_inverse,sp_richBiome12_norm)

# now add here the weights
weights <- c(1,2,1,1,2)

# calculate weighted mean on the stack
aichi_map_biome12 <- weighted.mean(x = Biome12aichi_covs_norm, w = weights)

# write the weighted raster as the “aichi map"
writeRaster(aichi_map_biome12,filename = paste0(dir,"/output/geo-proc/aichi-maps/Biome12aichi_mapFinal.tif"))

# load in the Biome12 aichi map
aichibiome12_map_ras <- raster(paste0(dir,"/output/geo-proc/aichi-maps/Biome12aichi_mapFinal.tif"))
plot(aichibiome12_map_ras)

# project and write raster
aichibiome12_map_ras_ee = projectRaster(aichibiome12_map_ras, crs = crs_equal_earth, method = "bilinear")
writeRaster(aichibiome12_map_ras_ee,filename = paste0(dir,"/output/geo-proc/aichi-maps/Biome12aichi_map_FinalEE.tif"))

aichibiome12_ee <- raster(paste0(dir,"/output/geo-proc/aichi-maps/Biome12aichi_map_FinalEE.tif"))
plot(aichibiome12_ee)
```

# Creating an 'Aichi map': Biome 4 (Mediterranean Forests, Woodlands & Scrub)
```{r biome 4 Aichi map}

# normalize covariates
accessBiome4_norm <- normalizeRaster(biome4_access)
cum_hum_impactBiome4_norm <- normalizeRaster(biome4_cum_hum_impact)
for_lossBiome4_norm <- normalizeRaster(biome4_forloss)
sp_richBiome4_norm <- normalizeRaster(biome4_sp_rich)
incomeBiome4_norm <- normalizeRaster(biome4_income)

# take inverse of income_norm because it has a negative association with aichi targets
incomeBiome4_norm_inverse <- 1-incomeBiome4_norm

# create aichi covariate raster stack
Biome4aichi_covs_norm <- stack(accessBiome4_norm,cum_hum_impactBiome4_norm,for_lossBiome4_norm,incomeBiome4_norm_inverse,sp_richBiome4_norm)

# now add here the weights
weights <- c(1,2,1,1,2)

# calculate weighted mean on the stack
aichi_map_biome4 <- weighted.mean(x = Biome4aichi_covs_norm, w = weights)

# write the weighted raster as the “aichi map"
writeRaster(aichi_map_biome4,filename = paste0(dir,"/output/geo-proc/aichi-maps/Biome4aichi_map_Final.tif"))

# project to EE
# load in the Biome4 aichi map
aichibiome4_map_ras <- raster(paste0(dir,"/output/geo-proc/aichi-maps/Biome4aichi_map_Final.tif"))
plot(aichibiome4_map_ras)

# project and write raster
aichi_map_tif_orig_ee = projectRaster(aichibiome4_map_ras, crs = crs_equal_earth, method = "bilinear")
writeRaster(aichi_map_tif_orig_ee,filename = paste0(dir,"/output/geo-proc/aichi-maps/Biome4aichi_map_FinalEE.tif"))

aichibiome4_ee <- raster(paste0(dir,"/output/geo-proc/aichi-maps/Biome4aichi_map_FinalEE.tif"))
plot(aichibiome4_ee)
```

# Creating a biodcrisis map: Biome 1
```{r biome 1 biodcrisis' map}
# normalize covariates
cum_hum_impactBiome1_norm <- normalizeRaster(biome1_cum_hum_impact)
for_lossBiome1_norm <- normalizeRaster(biome1_forloss)
sp_richBiome1_norm <- normalizeRaster(biome1_sp_rich)

# create biodcrisis covariate raster stack
biodcrisis_covs_norm_biome1 <- stack(cum_hum_impactBiome1_norm,for_lossBiome1_norm,sp_richBiome1_norm)

# write the weighted raster as the “aichi map"
writeRaster(biodcrisis_covs_norm_biome1,filename = paste0(dir,"/output/geo-proc/biodcrisis-maps/Biome1biodcrisis_map.tif"))

# load in the Biome1 aichi map
biodcrisisbiome1_map_ras <- raster(paste0(dir,"/output/geo-proc/biodcrisis-maps/Biome1biodcrisis_map.tif"))
plot(biodcrisisbiome1_map_ras)

# project and write raster
biodcrisisbiome1_map_ras_ee = projectRaster(biodcrisisbiome1_map_ras, crs = crs_equal_earth, method = "bilinear")
writeRaster(biodcrisisbiome1_map_ras_ee,filename = paste0(dir,"/output/geo-proc/biodcrisis-maps/Biome1biodcrisis_map_FinalEE.tif"))

biodcrisisbiome1_ee <- raster(paste0(dir,"/output/geo-proc/biodcrisis-maps/Biome1biodcrisis_map_FinalEE.tif"))
plot(biodcrisisbiome1_ee)
```

# Creating a biodcrisis map: Biome 7
```{r biome 7 biodcrisis' map}
# normalize covariates
cum_hum_impactBiome7_norm <- normalizeRaster(biome7_cum_hum_impact)
for_lossBiome7_norm <- normalizeRaster(biome7_forloss)
sp_richBiome7_norm <- normalizeRaster(biome7_sp_rich)

# create biodcrisis covariate raster stack
biodcrisis_covs_norm_biome7 <- stack(cum_hum_impactBiome7_norm,for_lossBiome7_norm,sp_richBiome7_norm)

# write the weighted raster as the “aichi map"
writeRaster(biodcrisis_covs_norm_biome7,filename = paste0(dir,"/output/geo-proc/biodcrisis-maps/Biome7biodcrisis_map.tif"))

# load in the Biome7 aichi map
biodcrisisbiome7_map_ras <- raster(paste0(dir,"/output/geo-proc/biodcrisis-maps/Biome7biodcrisis_map.tif"))
plot(biodcrisisbiome7_map_ras)

# project and write raster
biodcrisisbiome7_map_ras_ee = projectRaster(biodcrisisbiome7_map_ras, crs = crs_equal_earth, method = "bilinear")
writeRaster(biodcrisisbiome7_map_ras_ee,filename = paste0(dir,"/output/geo-proc/biodcrisis-maps/Biome7biodcrisis_map_FinalEE.tif"))

biodcrisisbiome7_ee <- raster(paste0(dir,"/output/geo-proc/biodcrisis-maps/Biome7biodcrisis_map_FinalEE.tif"))
plot(biodcrisisbiome7_ee)
```

# Creating a biodcrisis map: Biome 12
```{r biome 12 biodcrisis' map}
# normalize covariates
cum_hum_impactBiome12_norm <- normalizeRaster(biome12_cum_hum_impact)
for_lossBiome12_norm <- normalizeRaster(biome12_forloss)
sp_richBiome12_norm <- normalizeRaster(biome12_sp_rich)

# create biodcrisis covariate raster stack
biodcrisis_covs_norm_biome12 <- stack(cum_hum_impactBiome12_norm,for_lossBiome12_norm,sp_richBiome12_norm)

# write the weighted raster as the “aichi map"
writeRaster(biodcrisis_covs_norm_biome12,filename = paste0(dir,"/output/geo-proc/biodcrisis-maps/Biome12biodcrisis_map.tif"))

# load in the Biome12 aichi map
biodcrisisbiome12_map_ras <- raster(paste0(dir,"/output/geo-proc/biodcrisis-maps/Biome12biodcrisis_map.tif"))
plot(biodcrisisbiome12_map_ras)

# project and write raster
biodcrisisbiome12_map_ras_ee = projectRaster(biodcrisisbiome12_map_ras, crs = crs_equal_earth, method = "bilinear")
writeRaster(biodcrisisbiome12_map_ras_ee,filename = paste0(dir,"/output/geo-proc/biodcrisis-maps/Biome12biodcrisis_map_FinalEE.tif"))

biodcrisisbiome12_ee <- raster(paste0(dir,"/output/geo-proc/biodcrisis-maps/Biome12biodcrisis_map_FinalEE.tif"))
plot(biodcrisisbiome12_ee)
```

# Creating a biodcrisis map: Biome 4
```{r biome 4 biodcrisis' map}
# normalize covariates
cum_hum_impactBiome4_norm <- normalizeRaster(biome4_cum_hum_impact)
for_lossBiome4_norm <- normalizeRaster(biome4_forloss)
sp_richBiome4_norm <- normalizeRaster(biome4_sp_rich)

# create biodcrisis covariate raster stack
biodcrisis_covs_norm_biome4 <- stack(cum_hum_impactBiome4_norm,for_lossBiome4_norm,sp_richBiome4_norm)

# write the weighted raster as the “aichi map"
writeRaster(biodcrisis_covs_norm_biome4,filename = paste0(dir,"/output/geo-proc/biodcrisis-maps/Biome4biodcrisis_map.tif"))

# load in the Biome4 aichi map
biodcrisisbiome4_map_ras <- raster(paste0(dir,"/output/geo-proc/biodcrisis-maps/Biome4biodcrisis_map.tif"))
plot(biodcrisisbiome4_map_ras)

# project and write raster
biodcrisisbiome4_map_ras_ee = projectRaster(biodcrisisbiome4_map_ras, crs = crs_equal_earth, method = "bilinear")
writeRaster(biodcrisisbiome4_map_ras_ee,filename = paste0(dir,"/output/geo-proc/biodcrisis-maps/Biome4biodcrisis_map_FinalEE.tif"))

biodcrisisbiome4_ee <- raster(paste0(dir,"/output/geo-proc/biodcrisis-maps/Biome4biodcrisis_map_FinalEE.tif"))
plot(biodcrisisbiome4_ee)
```

# Creating a biodcrisis + camera allocation bivariate map: Biome 1 # Doesn't work in Rstudio
```{r biome 1 bivariate plots + with scatter}
# load in the biodcrisis map
biodcrisis_map_tif4<- raster(paste0(dir,"/output/geo-proc/biodcrisis-maps/Biome4biodcrisis_map_FinalEE.tif"))

# load in the Biome1 camera trapping allocation map
camtrap_effort_tif4 <- raster(paste0(dir,"/output/geo-proc/predictions/Biome4_predictionFinal.tif"))

# match extent of the biodcrisis map
biodcrisis_map_tif4ExtMatch <- projectRaster(biodcrisis_map_tif4, camtrap_effort_tif4,0.008333333, projection, method="bilinear", alignOnly=FALSE, over=FALSE, paste0(dir,"/output/geo-proc/biodcrisis-maps/Biome4biodcrisis_map_FinalEEExtMatchF.tif"))

x <- raster(paste0(dir,"/output/geo-proc/biodcrisis-maps/Biome4biodcrisis_map_FinalEEExtMatchF.tif"))

# non-normalized
s1 <- stack(list(maxent = camtrap_effort_tif4,  biodcrisis = x));plot(s1)

# aggregate
s_agg1 <- aggregate(s1, fact = 2)

rbiome1 <- s_agg1

# create the bivariate raster
bivmap1 <- bivariate.map(rasterx = rbiome1[["maxent"]], rastery = rbiome1[["biodcrisis"]],
                        export.colour.matrix = TRUE, outname = "bivMapCols",
                        colormatrix = col.matrix, nquantiles = nBreaks)
plot(bivmap1)

# check values in bivmap
tmp1 <- table(values(bivmap1))
length(tmp1)   # 25 entries as expected
names(tmp1)    # 6-10 missing (that's by design, the color.matrix function is weird that way)

# exporting raster for use in QGIS
writeRaster(bivmap1,filename = paste0(dir,"/output/geo-proc/biodcrisis-maps/Biome1biodcrisis_disparity_map.tif"))

# giving bivariate raster desired color ramp
bivrast1 <- raster(paste0(dir,"/output/geo-proc/biodcrisis-maps/Biome1biodcrisis_disparity_map.tif"))
bivrast1 <- bivrast1 - 1
ctab1 <- c(as.vector(col.matrix[-1,]), rep("purple", times = 256 - length(col.matrix[-1,])))
colortable(bivrast) <- ctab1
plot(bivrast1)
head(colortable(bivrast1))
writeRaster(bivrast1,filename = paste0(dir,"/output/geo-proc/biv-maps/Biome1_disparity_map_coltab.tif"))

# Convert to dataframe for plotting with ggplot
bivmap1 <- raster(paste0(dir,"/output/geo-proc/biv-maps/biodcrisis/Biome1_biodcrisis_disparity_map_coltabFinal.tif"))
bivMapDF1 <- as.data.frame(bivmap1, xy = TRUE) %>%
  tbl_df() %>%
  dplyr::rename("BivValue" = 3) %>%
  pivot_longer(., names_to = "Variable", values_to = "bivVal", cols = BivValue)

# Make the map using ggplot
map1 <- ggplot(bivMapDF1, aes(x = x, y = y)) +
geom_raster(aes(fill = bivVal)) +
scale_y_continuous(breaks = seq(-80, 80, by = 10), 
                     labels = paste0(seq(-80, 80, 10), "°")) +
scale_x_continuous(breaks = seq(-180,180,20), 
                     labels = paste0(seq(-180,180,20), "°")) +
scale_fill_gradientn(colours = col.matrix, na.value = "transparent") + 
theme_bw() +
theme(text = element_text(size = 10, colour = "black")) +
borders(colour = "grey20", size = 0.25) +
theme(legend.position = "none",
        plot.background = element_blank(),
        strip.text = element_text(size = 12, colour = "black"),
        axis.text.y = element_text(angle = 90, hjust = 0.5),
        axis.text = element_text(size = 12, colour = "black"),
        axis.title = element_text(size = 12, colour = "black")) +
labs(x = "Longitude", y = "Latitude")
map1

# Overlay the legend on the map
fig1 <- ggdraw(map1) + 
  draw_plot(BivLegend +
              theme(plot.background = element_rect(fill = "white", colour = NA)),
            width = 0.25, height = 0.25, x = 0.05, y = 0.25)
fig1

# plotting the points over the matrix
# extract raster value 
values_maxent1 <- values(s1$maxent)
values_biodcrisis1  <- values(s1$biodcrisis)
  
# ecdf of all values
ecdf_maxent1 <- ecdf(values_maxent1)
ecdf_aichi1  <- ecdf(values_biodcrisis1)
  
# put ECDF values back in raster
tmp1 <- raster(s_agg1)
values(tmp1) <- ecdf_maxent1(values_maxent1)
s_agg1$maxent_ecdf1 <- tmp1
  
tmp1 <- raster(s_agg1)
values(tmp1) <- ecdf_aichi1(values_aichi1)
s_agg1$aichi_ecdf1 <- tmp1

# My data (study site locations)
df_study_sites1 <- data.frame(lon = biome1_locs$lon,
                               lat = biome1_locs$lat)
  
# extract raster values at study sites
values_at_study_sites1 <- data.frame(raster::extract(s_agg1, df_study_sites1))
plot(s_agg1)
   
# use only the ecdf values
values_at_study_sites1 <- data.frame(X = values_at_study_sites1[, "maxent_ecdf1"],
                                       Y = values_at_study_sites1[, "aichi_ecdf1"],
                                       HEXCode = "#FFFFFF")
     
# adjust to range of color matrix
values_at_study_sites1$X <- values_at_study_sites1$X * 5 + 0.5
values_at_study_sites1$Y <- values_at_study_sites1$Y * 5 + 0.5

# Finally, overlay the study sites over the matrix
p3 <- p + geom_point(data = values_at_study_sites1,fill = "white", col = "black", size = 2, pch = 21)
p3

# save
ggsave(filename = paste0(dir,"/plots/Fig5f_matrix_scatter.png"), plot = p3, width = 7, height = 5, dpi = 300)
```

# Creating a bivariate map: Biome 1
```{r biome 1 bivariate plots + with scatter}
# load in the Biome1 aichi map
aichi_map_tif1<- raster(paste0(dir,"/output/geo-proc/aichi-maps/Biome1aichi_mapFinalTEST.tif"))

# load in the Biome1 camera trapping allocation map
camtrap_effort_tif1 <- raster(paste0(dir,"/output/geo-proc/predictions/Biome1_predictionFinal.tif"))

# non-normalized
s1 <- stack(list(maxent = camtrap_effort_tif1,  aichi = aichi_map_tif1));plot(s1)

# aggregate
s_agg1 <- aggregate(s1, fact = 2)

rbiome1 <- s_agg1

# create the bivariate raster
bivmap1 <- bivariate.map(rasterx = s_agg1[["maxent"]], rastery = s_agg1[["aichi"]],
                        export.colour.matrix = TRUE, outname = "bivMapCols",
                        colormatrix = col.matrix, nquantiles = nBreaks)
plot(bivmap1)

# check values in bivmap
tmp1 <- table(values(bivmap1))
length(tmp1)   # 25 entries as expected
names(tmp1)    # 6-10 missing (that's by design, the color.matrix function is weird that way)

# exporting raster for use in QGIS
writeRaster(bivmap1,filename = paste0(dir,"/output/geo-proc/biv-maps/Biome1_disparity_map.tif"))

# giving bivariate raster desired color ramp
bivrast1 <- raster(paste0(dir,"/output/geo-proc/biv-maps/Biome1_disparity_map.tif"))
bivrast1 <- bivrast1 - 1
ctab1 <- c(as.vector(col.matrix[-1,]), rep("purple", times = 256 - length(col.matrix[-1,])))
colortable(bivrast) <- ctab1
plot(bivrast1)
head(colortable(bivrast1))
writeRaster(bivrast1,filename = paste0(dir,"/output/geo-proc/biv-maps/Biome1_disparity_map_coltab.tif"))

# Convert to dataframe for plotting with ggplot
bivMapDF1 <- as.data.frame(bivmap1, xy = TRUE) %>%
  tbl_df() %>%
  dplyr::rename("BivValue" = 3) %>%
  pivot_longer(., names_to = "Variable", values_to = "bivVal", cols = BivValue)

# Make the map using ggplot
map1 <- ggplot(bivMapDF1, aes(x = x, y = y)) +
geom_raster(aes(fill = bivVal)) +
scale_y_continuous(breaks = seq(-80, 80, by = 10), 
                     labels = paste0(seq(-80, 80, 10), "°")) +
scale_x_continuous(breaks = seq(-180,180,20), 
                     labels = paste0(seq(-180,180,20), "°")) +
scale_fill_gradientn(colours = col.matrix, na.value = "transparent") + 
theme_bw() +
theme(text = element_text(size = 10, colour = "black")) +
borders(colour = "grey20", size = 0.25) +
theme(legend.position = "none",
        plot.background = element_blank(),
        strip.text = element_text(size = 12, colour = "black"),
        axis.text.y = element_text(angle = 90, hjust = 0.5),
        axis.text = element_text(size = 12, colour = "black"),
        axis.title = element_text(size = 12, colour = "black")) +
labs(x = "Longitude", y = "Latitude")
map1

# Overlay the legend on the map
fig1 <- ggdraw(map1) + 
  draw_plot(BivLegend +
              theme(plot.background = element_rect(fill = "white", colour = NA)),
            width = 0.25, height = 0.25, x = 0.05, y = 0.25)
fig1

# plotting the points over the matrix
# extract raster value 
values_maxent1 <- values(s_agg1$maxent)
values_aichi1  <- values(s_agg1$aichi)
  
# ecdf of all values
ecdf_maxent1 <- ecdf(values_maxent1)
ecdf_aichi1  <- ecdf(values_aichi1)
  
# put ECDF values back in raster
tmp1 <- raster(s_agg1)
values(tmp1) <- ecdf_maxent1(values_maxent1)
s_agg1$maxent_ecdf1 <- tmp1
  
tmp1 <- raster(s_agg1)
values(tmp1) <- ecdf_aichi1(values_aichi1)
s_agg1$aichi_ecdf1 <- tmp1

# My data (study site locations)
df_study_sites1 <- data.frame(lon = biome1_locs$lon,
                               lat = biome1_locs$lat)
  
# extract raster values at study sites
values_at_study_sites1 <- data.frame(raster::extract(s_agg1, df_study_sites1))
plot(s_agg1)
   
# use only the ecdf values
values_at_study_sites1 <- data.frame(X = values_at_study_sites1[, "maxent_ecdf1"],
                                       Y = values_at_study_sites1[, "aichi_ecdf1"],
                                       HEXCode = "#FFFFFF")
     
# adjust to range of color matrix
values_at_study_sites1$X <- values_at_study_sites1$X * 5 + 0.5
values_at_study_sites1$Y <- values_at_study_sites1$Y * 5 + 0.5

# Finally, overlay the study sites over the matrix
p3 <- p + geom_point(data = values_at_study_sites1,fill = "white", col = "black", size = 2, pch = 21)
p3

# save
ggsave(filename = paste0(dir,"/plots/Fig5f_matrix_scatter.png"), plot = p3, width = 7, height = 5, dpi = 300)
```

# Creating a bivariate map: Biome 7
```{r biome 7 bivariate plots + with scatter}
# load in the Biome7 aichi map
aichi_map_tif7<- raster(paste0(dir,"/output/geo-proc/aichi-maps/Biome7aichi_mapFinal.tif"))

# load in the Biome7 camera trapping allocation map
camtrap_effort_tif7 <- raster(paste0(dir,"/output/geo-proc/predictions/Biome7_predictionFinal.tif"))

# non-normalized
s7 <- stack(list(maxent = camtrap_effort_tif7,  aichi = aichi_map_tif7));plot(s7)

# aggregate
s_agg7 <- aggregate(s7, fact = 2)

rbiome7 <- s_agg7

# create the bivariate raster
bivmap7 <- bivariate.map(rasterx = rbiome7[["maxent"]], rastery = rbiome7[["aichi"]],
                        export.colour.matrix = TRUE, outname = "bivMapCols",
                        colormatrix = col.matrix, nquantiles = nBreaks)

# check values in bivmap
tmp7 <- table(values(bivmap7))
length(tmp7)   # 25 entries as expected
names(tmp7)    # 6-10 missing (that's by design, the color.matrix function is weird that way)

# exporting raster for use in QGIS
writeRaster(bivmap7,filename = paste0(dir,"/output/geo-proc/biv-maps/Biome7_disparity_map.tif"))

# giving bivariate raster desired color ramp
bivrast7 <- raster(paste0(dir,"/output/geo-proc/biv-maps/Biome7_disparity_map.tif"))
bivrast7 <- bivrast7 - 1
ctab7 <- c(as.vector(col.matrix[-1,]), rep("purple", times = 256 - length(col.matrix[-1,])))
colortable(bivrast) <- ctab7
plot(bivrast7)
head(colortable(bivrast7))
writeRaster(bivrast7,filename = paste0(dir,"/output/geo-proc/biv-maps/Biome7_disparity_map_coltab.tif"))

# Convert to dataframe for plotting with ggplot
bivMapDF7 <- as.data.frame(bivmap7, xy = TRUE) %>%
  tbl_df() %>%
  dplyr::rename("BivValue" = 3) %>%
  pivot_longer(., names_to = "Variable", values_to = "bivVal", cols = BivValue)

# Make the map using ggplot
map7 <- ggplot(bivMapDF7, aes(x = x, y = y)) +
geom_raster(aes(fill = bivVal)) +
scale_y_continuous(breaks = seq(-80, 80, by = 10), 
                     labels = paste0(seq(-80, 80, 10), "°")) +
scale_x_continuous(breaks = seq(-180,180,20), 
                     labels = paste0(seq(-180,180,20), "°")) +
scale_fill_gradientn(colours = col.matrix, na.value = "transparent") + 
theme_bw() +
theme(text = element_text(size = 10, colour = "black")) +
borders(colour = "grey20", size = 0.25) +
theme(legend.position = "none",
        plot.background = element_blank(),
        strip.text = element_text(size = 12, colour = "black"),
        axis.text.y = element_text(angle = 90, hjust = 0.5),
        axis.text = element_text(size = 12, colour = "black"),
        axis.title = element_text(size = 12, colour = "black")) +
labs(x = "Longitude", y = "Latitude")
map7

# Overlay the legend on the map
fig7 <- ggdraw(map7) + 
  draw_plot(BivLegend +
              theme(plot.background = element_rect(fill = "white", colour = NA)),
            width = 0.25, height = 0.25, x = 0.05, y = 0.25)
fig7

# plotting the points over the matrix
# extract raster value 
values_maxent7 <- values(s_agg7$maxent)
values_aichi7  <- values(s_agg7$aichi)
  
# ecdf of all values
ecdf_maxent7 <- ecdf(values_maxent7)
ecdf_aichi7  <- ecdf(values_aichi7)
  
# put ECDF values back in raster
tmp7 <- raster(s_agg7)
values(tmp7) <- ecdf_maxent7(values_maxent7)
s_agg7$maxent_ecdf7 <- tmp7
  
tmp7 <- raster(s_agg7)
values(tmp7) <- ecdf_aichi7(values_aichi7)
s_agg7$aichi_ecdf7 <- tmp7

# My data (study site locations)
df_study_sites7 <- data.frame(lon = biome7_locs$lon,
                               lat = biome7_locs$lat)
  
# extract raster values at study sites
values_at_study_sites7 <- data.frame(raster::extract(s_agg7, df_study_sites7))
plot(s_agg7)
   
# use only the ecdf values
values_at_study_sites7 <- data.frame(X = values_at_study_sites7[, "maxent_ecdf7"],
                                       Y = values_at_study_sites7[, "aichi_ecdf7"],
                                       HEXCode = "#FFFFFF")
     
# adjust to range of color matrix
values_at_study_sites7$X <- values_at_study_sites7$X * 5 + 0.5
values_at_study_sites7$Y <- values_at_study_sites7$Y * 5 + 0.5

# Finally, overlay the study sites over the matrix
p4 <- p + geom_point(data = values_at_study_sites7,fill = "white", col = "black", size = 2, pch = 21)
p4

# save
ggsave(filename = paste0(dir,"/plots/Fig5i_matrix_scatter.png"), plot = p4, width = 7, height = 5, dpi = 300)
```

# Creating a bivariate map: Biome 12
```{r biome 12 bivariate plots + with scatter}
# load in the Biome12 aichi map
aichi_map_tif12<- raster(paste0(dir,"/output/geo-proc/aichi-maps/Biome12aichi_mapFinal.tif"))

# load in the Biome12 camera trapping allocation map
camtrap_effort_tif12 <- raster(paste0(dir,"/output/geo-proc/predictions/Biome12_predictionFinal.tif"))

# non-normalized
s12 <- stack(list(maxent = camtrap_effort_tif12,  aichi = aichi_map_tif12));plot(s12)

# aggregate
s_agg12 <- aggregate(s12, fact = 2)

rbiome12 <- s_agg12

# create the bivariate raster
bivmap12 <- bivariate.map(rasterx = rbiome12[["maxent"]], rastery = rbiome12[["aichi"]],
                        export.colour.matrix = TRUE, outname = "bivMapCols",
                        colormatrix = col.matrix, nquantiles = nBreaks)

# check values in bivmap
tmp12 <- table(values(bivmap12))
length(tmp12)   # 25 entries as expected
names(tmp12)    # 6-10 missing (that's by design, the color.matrix function is weird that way)

# exporting raster for use in QGIS
writeRaster(bivmap12,filename = paste0(dir,"/output/geo-proc/biv-maps/Biome12_disparity_map.tif"))

# giving bivariate raster desired color ramp
bivrast12 <- raster(paste0(dir,"/output/geo-proc/biv-maps/Biome12_disparity_map.tif"))
bivrast12 <- bivrast12 - 1
ctab12 <- c(as.vector(col.matrix[-1,]), rep("purple", times = 256 - length(col.matrix[-1,])))
colortable(bivrast) <- ctab12
plot(bivrast12)
head(colortable(bivrast12))
writeRaster(bivrast12,filename = paste0(dir,"/output/geo-proc/biv-maps/Biome12_disparity_map_coltab.tif"))

# Convert to dataframe for plotting with ggplot
bivMapDF12 <- as.data.frame(bivmap, xy = TRUE) %>%
  tbl_df() %>%
  dplyr::rename("BivValue" = 3) %>%
  pivot_longer(., names_to = "Variable", values_to = "bivVal", cols = BivValue)

# Make the map using ggplot
map12 <- ggplot(bivMapDF, aes(x = x, y = y)) +
geom_raster(aes(fill = bivVal)) +
scale_y_continuous(breaks = seq(-80, 80, by = 10), 
                     labels = paste0(seq(-80, 80, 10), "°")) +
scale_x_continuous(breaks = seq(-180,180,20), 
                     labels = paste0(seq(-180,180,20), "°")) +
scale_fill_gradientn(colours = col.matrix, na.value = "transparent") + 
theme_bw() +
theme(text = element_text(size = 10, colour = "black")) +
borders(colour = "grey20", size = 0.25) +
theme(legend.position = "none",
        plot.background = element_blank(),
        strip.text = element_text(size = 12, colour = "black"),
        axis.text.y = element_text(angle = 90, hjust = 0.5),
        axis.text = element_text(size = 12, colour = "black"),
        axis.title = element_text(size = 12, colour = "black")) +
labs(x = "Longitude", y = "Latitude")
map12

# Overlay the legend on the map
fig12 <- ggdraw(map12) + 
  draw_plot(BivLegend +
              theme(plot.background = element_rect(fill = "white", colour = NA)),
            width = 0.25, height = 0.25, x = 0.05, y = 0.25)
fig12

# plotting the points over the matrix
# extract raster value 
values_maxent12 <- values(s_agg12$maxent)
values_aichi12  <- values(s_agg12$aichi)
  
# ecdf of all values
ecdf_maxent12 <- ecdf(values_maxent12)
ecdf_aichi12  <- ecdf(values_aichi12)
  
# put ECDF values back in raster
tmp12 <- raster(s_agg12)
values(tmp12) <- ecdf_maxent12(values_maxent12)
s_agg12$maxent_ecdf12 <- tmp12
  
tmp12 <- raster(s_agg12)
values(tmp12) <- ecdf_aichi12(values_aichi12)
s_agg12$aichi_ecdf12 <- tmp12

# My data (study site locations)
df_study_sites12 <- data.frame(lon = biome12_locs$lon,
                               lat = biome12_locs$lat)
  
# extract raster values at study sites
values_at_study_sites12 <- data.frame(raster::extract(s_agg12, df_study_sites12))
plot(s_agg12)
   
# use only the ecdf values
values_at_study_sites12 <- data.frame(X = values_at_study_sites12[, "maxent_ecdf12"],
                                       Y = values_at_study_sites12[, "aichi_ecdf12"],
                                       HEXCode = "#FFFFFF")
     
# adjust to range of color matrix
values_at_study_sites12$X <- values_at_study_sites12$X * 5 + 0.5
values_at_study_sites12$Y <- values_at_study_sites12$Y * 5 + 0.5

# Finally, overlay the study sites over the matrix
p5 <- p + geom_point(data = values_at_study_sites12,fill = "white", col = "black", size = 2, pch = 21)
p5

# save
ggsave(filename = paste0(dir,"/plots/Fig5l_matrix_scatter.png"), plot = p5, width = 7, height = 5, dpi = 300)
```

# Creating a bivariate map: Biome 4
```{r biome 4 bivariate plots + with scatter}
# load in the Biome4 aichi map
aichi_map_tif4<- raster(paste0(dir,"/output/geo-proc/aichi-maps/Biome4aichi_mapFinal.tif"))

# load in the Biome4 camera trapping allocation map
camtrap_effort_tif4 <- raster(paste0(dir,"/output/geo-proc/predictions/Biome4_predictionFinal.tif"))

# non-normalized
s4 <- stack(list(maxent = camtrap_effort_tif4,  aichi = aichi_map_tif4));plot(s4)

# aggregate
s_agg4 <- aggregate(s4, fact = 2)

rbiome4 <- s_agg4

# create the bivariate raster
bivmap4 <- bivariate.map(rasterx = rbiome4[["maxent"]], rastery = rbiome4[["aichi"]],
                        export.colour.matrix = TRUE, outname = "bivMapCols",
                        colormatrix = col.matrix, nquantiles = nBreaks)

# bring in the bivmap
bivmap4 <- readRDS(paste(dir,"/output/geo-proc/biv-maps/biodcrisis/Biome4bivmap.rds",sep=""))

# check values in bivmap
tmp4 <- table(values(bivmap4))
length(tmp4)   # 25 entries as expected
names(tmp4)    # 6-10 missing (that's by design, the color.matrix function is weird that way)

# exporting raster for use in QGIS
writeRaster(bivmap4,filename = paste0(dir,"/output/geo-proc/biv-maps/Biome4_disparity_map.tif"))

# giving bivariate raster desired color ramp
bivrast4 <- raster(paste0(dir,"/output/geo-proc/biv-maps/Biome4_disparity_map.tif"))
bivrast4 <- bivrast4 - 1
ctab4 <- c(as.vector(col.matrix[-1,]), rep("purple", times = 256 - length(col.matrix[-1,])))
colortable(bivrast) <- ctab4
plot(bivrast4)
head(colortable(bivrast4))
writeRaster(bivrast4,filename = paste0(dir,"/output/geo-proc/biv-maps/Biome4_disparity_map_coltab.tif"))

# bring in the bivmap
bivmap <- readRDS(paste(dir,"/output/geo-proc/biv-maps/biodcrisis/Biome4bivmap.rds",sep=""))

# Convert to dataframe for plotting with ggplot
bivMapDF4 <- as.data.frame(bivmap, xy = TRUE) %>%
  tbl_df() %>%
  dplyr::rename("BivValue" = 3) %>%
  pivot_longer(., names_to = "Variable", values_to = "bivVal", cols = BivValue)

# Make the map using ggplot
map4 <- ggplot(bivMapDF, aes(x = x, y = y)) +
geom_raster(aes(fill = bivVal)) +
scale_y_continuous(breaks = seq(-80, 80, by = 10), 
                     labels = paste0(seq(-80, 80, 10), "°")) +
scale_x_continuous(breaks = seq(-180,180,20), 
                     labels = paste0(seq(-180,180,20), "°")) +
scale_fill_gradientn(colours = col.matrix, na.value = "transparent") + 
theme_bw() +
theme(text = element_text(size = 10, colour = "black")) +
borders(colour = "grey20", size = 0.25) +
theme(legend.position = "none",
        plot.background = element_blank(),
        strip.text = element_text(size = 12, colour = "black"),
        axis.text.y = element_text(angle = 90, hjust = 0.5),
        axis.text = element_text(size = 12, colour = "black"),
        axis.title = element_text(size = 12, colour = "black")) +
labs(x = "Longitude", y = "Latitude")
map4

# Overlay the legend on the map
fig4 <- ggdraw(map4) + 
  draw_plot(BivLegend +
              theme(plot.background = element_rect(fill = "white", colour = NA)),
            width = 0.25, height = 0.25, x = 0.05, y = 0.25)
fig4

# plotting the points over the matrix
# extract raster value 
values_maxent4 <- values(s_agg4$maxent)
values_aichi4 <- values(s_agg4$aichi)
  
# ecdf of all values
ecdf_maxent4 <- ecdf(values_maxent4)
ecdf_aichi4  <- ecdf(values_aichi4)
  
# put ECDF values back in raster
tmp4 <- raster(s_agg4)
values(tmp4) <- ecdf_maxent4(values_maxent4)
s_agg4$maxent_ecdf4 <- tmp4
  
tmp4 <- raster(s_agg4)
values(tmp4) <- ecdf_aichi4(values_aichi4)
s_agg4$aichi_ecdf4 <- tmp4

# My data (study site locations)
df_study_sites4 <- data.frame(lon = biome4_locs$lon,
                               lat = biome4_locs$lat)
  
# extract raster values at study sites
values_at_study_sites4 <- data.frame(raster::extract(s_agg4, df_study_sites4))
plot(s_agg4)
   
# use only the ecdf values
values_at_study_sites4<- data.frame(X = values_at_study_sites4[, "maxent_ecdf4"],
                                       Y = values_at_study_sites4[, "aichi_ecdf4"],
                                       HEXCode = "#FFFFFF")
     
# adjust to range of color matrix
values_at_study_sites4$X <- values_at_study_sites4$X * 5 + 0.5
values_at_study_sites4$Y <- values_at_study_sites4$Y * 5 + 0.5

# Finally, overlay the study sites over the matrix
p6 <- p + geom_point(data = values_at_study_sites4,fill = "white", col = "black", size = 2, pch = 21)
p6

# save
ggsave(filename = paste0(dir,"/plots/Fig5o_matrix_scatter.png"), plot = p6, width = 7, height = 5, dpi = 300)
```

# Creating disparity figures for Biomes#OBSELETE
```{r disparity random and locations (also for figure 4)}

#Biome 1
# create random points # this only works in R
# avail <- spsample(biome1.shp, n = 50000, "Fibonacci")
# plot(avail)

# write the random points as a csv
# write.csv(avail,paste0(dir,"/output/data-tables/biome1_aichi_used_unused_diparity.csv"))

# Load used vs unused data
biome1_aichi_disp <- read.csv(paste0(dir,"/output/data-tables/biome1_biodcrisis_used_unused_disparityFINAL.csv"));head(biome1_aichi_disp)

# used vs unused aichi on a rain cloud plot
biome1_aichi_unused_used <- ggplot(biome1_aichi_disp,aes(x=data,y= Biome1biod, fill = data, colour = data))+
theme_update(text = element_text(size=12))+
geom_flat_violin(position = position_nudge(x = .01, y = 0),adjust =2, trim = FALSE, alpha=0.7,color="white")+
geom_boxplot(aes(x = data, y = Biome1biod),outlier.shape = NA, alpha = 0.3, width = .1, colour = "BLACK")+
ylab("Biodiversity crisis value")+
xlab("Research locations")+
ylim(0,0.75)+
coord_flip()+
guides(fill = FALSE, colour = FALSE) +
scale_fill_manual(values = c("grey75","grey75"))+
theme_bw()+
science_theme_distribution
biome1_aichi_unused_used

# save
ggsave(filename = paste0(dir,"/plots/Fig5e_biodcrisis_matrix_scatter.png"), plot = biome1_aichi_unused_used, width = 7, height = 5, dpi = 300)

# Biome 7
# create random points # this only works in R
# avail <- spsample(biome7.shp, n = 50000, "Fibonacci")
# plot(avail)

# write the random points as a csv
# write.csv(avail,paste0(dir,"/output/data-tables/biome7_avail_unused_used_aichi_disparity.csv"))

# Load used vs unused data
biome7_aichi_disp <- read.csv(paste0(dir,"/output/data-tables/biome7_avail_unused_used_aichi_disparity.csv"));head(biome7_aichi_disp)

# used vs unused aichi on a rain cloud plot
biome7_aichi_used_unused <- ggplot(biome7_aichi_disp,aes(x=data,y= Biome7aich, fill = data, colour = data))+
theme_update(text = element_text(size=12))+
geom_flat_violin(position = position_nudge(x = .01, y = 0),adjust =2, trim = FALSE, alpha=0.7,color="white")+
geom_boxplot(aes(x = data, y = Biome7aich),outlier.shape = NA, alpha = 0.3, width = .1, colour = "BLACK")+
ylab("Aichi value")+
xlab("Research locations")+
ylim(0,0.75)+
coord_flip()+
guides(fill = FALSE, colour = FALSE) +
scale_fill_manual(values = c("grey75","grey75"))+
theme_bw()+
science_theme_distribution
biome7_aichi_used_unused

# save
ggsave(filename = paste0(dir,"/plots/Fig5h_matrix_scatter.png"), plot = biome7_aichi_used_unused, width = 7, height = 5, dpi = 300)

# Biome 12
# create random points # this only works in R
# avail <- spsample(biome12.shp, n = 50000, "Fibonacci")
# plot(avail)

# write the random points as a csv
# write.csv(avail,paste0(dir,"/output/data-tables/biome12_avail_unused_used_aichi_disparity.csv"))

# Load used vs unused data
biome12_aichi_disp <- read.csv(paste0(dir,"/output/data-tables/biome12_avail_unused_used_aichi_disparity.csv"));head(biome12_aichi_disp)

# used vs unused aichi on a rain cloud plot
biome12_aichi_used_unused <- ggplot(biome12_aichi_disp,aes(x=data,y= Biome12aich, fill = data, colour = data))+
theme_update(text = element_text(size=12))+
geom_flat_violin(position = position_nudge(x = .01, y = 0),adjust =2, trim = FALSE, alpha=0.7,color="white")+
geom_boxplot(aes(x = data, y = Biome12aich),outlier.shape = NA, alpha = 0.3, width = .1, colour = "BLACK")+
ylab("Aichi value")+
xlab("Research locations")+
ylim(0,0.75)+
coord_flip()+
guides(fill = FALSE, colour = FALSE) +
scale_fill_manual(values = c("grey75","grey75"))+
theme_bw()+
science_theme_distribution
biome12_aichi_used_unused

# save
ggsave(filename = paste0(dir,"/plots/Fig5k_matrix_scatter.png"), plot = biome12_aichi_used_unused, width = 7, height = 5, dpi = 300)

# Biome 4
# create random points # this only works in R
# avail <- spsample(biome4.shp, n = 50000, "Fibonacci")
# plot(avail)

# write the random points as a csv
# write.csv(avail,paste0(dir,"/output/data-tables/biome4_aichi_used_unused_disparity.csv"))

# Load used vs unused data
biome4_aichi_disp <- read.csv(paste0(dir,"/output/data-tables/biome4_aichi_biodcrisis_used_unused_disparity.csv"));head(biome4_aichi_disp)

# used vs unused aichi on a rain cloud plot
biome4_aichi_used_unused <- ggplot(biome4_aichi_disp,aes(x=data,y= Biome4biod, fill = data, colour = data))+
theme_update(text = element_text(size=12))+
geom_flat_violin(position = position_nudge(x = .01, y = .0),adjust =2, trim = FALSE, alpha=0.7,color="white")+
geom_boxplot(aes(x = data, y = Biome4biod),outlier.shape = NA, alpha = 0.3, width = .1, colour = "BLACK")+
ylab("Biodiversity crisis value")+
xlab("Research locations")+
ylim(0,0.5)+
coord_flip()+
guides(fill = FALSE, colour = FALSE) +
scale_fill_manual(values = c("grey75","grey75"))+
theme_bw()+
science_theme_distribution
biome4_aichi_used_unused

# save
ggsave(filename = paste0(dir,"/plots/Fig5n_biodcrisis_matrix_scatter.png"), plot = biome4_aichi_used_unused, width = 7, height = 5, dpi = 300)
```

# Creating disparity figures for Biomes
```{r disparity random and locations (also for figure 4)}

#Biome 1
# create random points # this only works in R
# avail <- spsample(biome1.shp, n = 50000, "Fibonacci")
# plot(avail)

# write the random points as a csv
# write.csv(avail,paste0(dir,"/output/data-tables/biome1_aichi_used_unused_diparity.csv"))

# Load used vs unused data
biome1_biodcrisis_disp <- read.csv(paste0(dir,"/output/data-tables/biome1_biodcrisis_used_unused_disparityFINAL.csv"));head(biome1_biodcrisis_disp)

# used vs unused aichi on a rain cloud plot
biome1_biodcrisis_unused_used <- ggplot(biome1_biodcrisis_disp,aes(x=data,y= Biome1biod, fill = data, colour = data))+
theme_update(text = element_text(size=12))+
geom_flat_violin(position = position_nudge(x = .01, y = 0),adjust =2, trim = FALSE, alpha=0.7,color="white")+
geom_boxplot(aes(x = data, y = Biome1biod),outlier.shape = NA, alpha = 0.3, width = .1, colour = "BLACK")+
ylab("")+
xlab("")+
ylim(0,0.75)+
coord_flip()+
guides(fill = FALSE, colour = FALSE) +
scale_fill_manual(values = c("grey75","grey75"))+
theme_bw()+
science_theme_distribution
biome1_biodcrisis_unused_used

# save
ggsave(filename = paste0(dir,"/plots/Fig5e_biodcrisis_matrix_scatter.png"), plot = biome1_biodcrisis_unused_used, width = 7, height = 5, dpi = 300)

# Biome 7
# create random points # this only works in R
# avail <- spsample(biome7.shp, n = 50000, "Fibonacci")
# plot(avail)

# write the random points as a csv
# write.csv(avail,paste0(dir,"/output/data-tables/biome7_avail_unused_used_aichi_disparity.csv"))

# Load used vs unused data
biome7_biodcrisis_disp <- read.csv(paste0(dir,"/output/data-tables/biome7_biodcrisis_used_unused_disparityFINAL.csv"));head(biome7_biodcrisis_disp)

# used vs unused aichi on a rain cloud plot
biome7_biodcrisis_unused_used <- ggplot(biome7_biodcrisis_disp,aes(x=data,y= Biome7biod, fill = data, colour = data))+
theme_update(text = element_text(size=12))+
geom_flat_violin(position = position_nudge(x = .01, y = 0),adjust =2, trim = FALSE, alpha=0.7,color="white")+
geom_boxplot(aes(x = data, y = Biome7biod),outlier.shape = NA, alpha = 0.3, width = .1, colour = "BLACK")+
ylab("")+
xlab("")+
ylim(0,0.75)+
coord_flip()+
guides(fill = FALSE, colour = FALSE) +
scale_fill_manual(values = c("grey75","grey75"))+
theme_bw()+
science_theme_distribution
biome7_biodcrisis_unused_used

# save
ggsave(filename = paste0(dir,"/plots/Fig5h_biodcrisis_matrix_scatter.png"), plot = biome7_biodcrisis_unused_used, width = 7, height = 5, dpi = 300)

# Biome 12
# create random points # this only works in R
# avail <- spsample(biome12.shp, n = 50000, "Fibonacci")
# plot(avail)

# write the random points as a csv
# write.csv(avail,paste0(dir,"/output/data-tables/biome12_avail_unused_used_aichi_disparity.csv"))

# Load used vs unused data
biome12_biodcrisis_disp <- read.csv(paste0(dir,"/output/data-tables/biome12_biodcrisis_used_unused_disparityFINAL.csv"));head(biome12_biodcrisis_disp)

# used vs unused aichi on a rain cloud plot
biome12_biodcrisis_unused_used <- ggplot(biome12_biodcrisis_disp,aes(x=data,y= Biome12bio, fill = data, colour = data))+
theme_update(text = element_text(size=12))+
geom_flat_violin(position = position_nudge(x = .01, y = 0),adjust =2, trim = FALSE, alpha=0.7,color="white")+
geom_boxplot(aes(x = data, y = Biome12bio),outlier.shape = NA, alpha = 0.3, width = .1, colour = "BLACK")+
ylab("")+
xlab("")+
ylim(0,0.75)+
coord_flip()+
guides(fill = FALSE, colour = FALSE) +
scale_fill_manual(values = c("grey75","grey75"))+
theme_bw()+
science_theme_distribution
biome12_biodcrisis_unused_used

# save
ggsave(filename = paste0(dir,"/plots/Fig5k_biodcrisis_matrix_scatter.png"), plot = biome12_biodcrisis_unused_used, width = 7, height = 5, dpi = 300)

# Biome 4
# create random points # this only works in R
# avail <- spsample(biome4.shp, n = 50000, "Fibonacci")
# plot(avail)

# write the random points as a csv
# write.csv(avail,paste0(dir,"/output/data-tables/biome4_aichi_used_unused_disparity.csv"))

# Load used vs unused data
biome4_aichi_disp <- read.csv(paste0(dir,"/output/data-tables/biome4_aichi_biodcrisis_used_unused_disparity.csv"));head(biome4_aichi_disp)

# used vs unused aichi on a rain cloud plot
biome4_aichi_used_unused <- ggplot(biome4_aichi_disp,aes(x=data,y= Biome4biod, fill = data, colour = data))+
theme_update(text = element_text(size=12))+
geom_flat_violin(position = position_nudge(x = .01, y = .0),adjust =2, trim = FALSE, alpha=0.7,color="white")+
geom_boxplot(aes(x = data, y = Biome4biod),outlier.shape = NA, alpha = 0.3, width = .1, colour = "BLACK")+
ylab("Biodiversity crisis value")+
xlab("Research locations")+
ylim(0,0.5)+
coord_flip()+
guides(fill = FALSE, colour = FALSE) +
scale_fill_manual(values = c("grey75","grey75"))+
theme_bw()+
science_theme_distribution
biome4_aichi_used_unused

# save
ggsave(filename = paste0(dir,"/plots/Fig5n_biodcrisis_matrix_scatter.png"), plot = biome4_aichi_used_unused, width = 7, height = 5, dpi = 300)
```

# Percent of locations in the different Aichi quintiles for all biomes
```{r percent of locs and aichi targets (also for figure 4)}
# biomes and aichi
# locs_biomes_aichi <-read.csv(paste0(dir,"/output/data-tables/All_4_biomes_aichiF.csv"));names(locs_biomes_aichi)

# Building the dataframe
percent_biomes_aichi <- data.frame(Biomes =c("Tropical moist forests",
                                             "Tropical grasslands",
                                             "Mediterranean forests",
                                             "Temperate forests"), 
                                                                    Quintiles=c("5","5","5","5",
                                                                                "4","4","4","4",
                                                                                "3","3","3","3",
                                                                                "2","2","2","2",
                                                                                "1","1","1","1"), 

          percent=c(40.79320113,66.84092606,43.83886256,42.98280688,
          14.9197356,20.01493652,27.48815166,28.62854858,
          20.39660057,11.65048544,21.32701422,16.19352259,
          18.88574127,1.194921583,6.161137441,10.15593762,
          5.004721435,0.298730396,1.184834123,2.039184326))
percent_biomes_aichi

# as a matrix
dataframe <- as.data.frame.matrix(percent_biomes_aichi)

# the plot
biomes_aichi_quintiles <- ggplot(data=dataframe, aes(x=Biomes,y=percent, fill= Quintiles)) +
geom_bar(stat="identity",color="white", alpha=0.95,position = position_fill(reverse = TRUE))+
labs(fill="Aichi Quintiles")+
xlab("Most researched biomes")+ylab("Percentage of locations")+
theme_bw()+
scale_fill_manual(values = c("#E5E5E5","#EBBDAC","#F29674","#F86E3C","#FF4704","#E5E5E5"))+
coord_flip()+
science_theme_distribution_diparity
biomes_aichi_quintiles
ggsave(filename = paste0(dir,"/plots/locs_biomes_Aichi_disparity.png"), plot = biomes_aichi_quintiles, width = 9, height = 5, dpi = 300)
```

# Percent of locations in the different Aichi quintiles for all biomes
```{r percent of locs and aichi targets (also for figure 4)}
# biomes and aichi
# locs_biomes_aichi <-read.csv(paste0(dir,"/output/data-tables/All_4_biomes_aichiF.csv"));names(locs_biomes_aichi)

# Building the dataframe
percent_biomes_biodcrisis<- data.frame(Biomes =c("Tropical moist forests",
                                             "Tropical grasslands",
                                             "Mediterranean forests",
                                             "Temperate forests"), 
                                                                    Quintiles=c("5","5","5","5",
                                                                                "4","4","4","4",
                                                                                "3","3","3","3",
                                                                                "2","2","2","2",
                                                                                "1","1","1","1"), 

          percent=c(42.82982792,54.36893204,20.88888889,25.10822511,
          20.7456979,16.50485437,17.77777778,14.14141414,
          17.87762906,9.708737864,16.88888889,23.37662338,
          13.38432122,9.708737864,28.88888889,20.2020202,
          5.162523901,9.708737864,15.55555556,17.17171717))
percent_biomes_biodcrisis

# as a matrix
dataframe <- as.data.frame.matrix(percent_biomes_biodcrisis)

# the plot
biomes_biodcrisis_quintiles <- ggplot(data=dataframe, aes(x=Biomes,y=percent, fill= Quintiles)) +
geom_bar(stat="identity",color="white", alpha=0.95,position = position_fill(reverse = TRUE))+
labs(fill="Quintiles")+
xlab("Most researched biomes")+ylab("Percentage of locations")+
theme_bw()+
scale_fill_manual(values = c("#E5E5E5","#EBBDAC","#F29674","#F86E3C","#FF4704","#E5E5E5"))+
coord_flip()+
science_theme_distribution_diparity
biomes_biodcrisis_quintiles
ggsave(filename = paste0(dir,"/plots/locs_biomes_biodcrisis_disparity.png"), plot = biomes_biodcrisis_quintiles, width = 9, height = 5, dpi = 300)
```



# Figure
```{r extended data figure 3: Response curves for the predictors}
# AUC tests at global scale; global, biome 1, biome 4, biome 7 and biome 12
responsesGL#global(a)
biome1responses#biome1(b)
biome7responses#biome7(c)
biome12responses#biome12(d)
biome4responses#biome4(e)
```

# Figure
```{r figure 3: Global prediction map and drivers (also figure 3)}

```

# Figure
```{r figure 4: Four biome prediction maps (also for figure 4)}
biome1_pred <- raster(paste0(dir,"/output/geo-proc/predictions/Biome1_prediction.tif"))
biome7_pred <- raster(paste0(dir,"/output/geo-proc/predictions/Biome7_prediction.tif"))
biome12_pred <- raster(paste0(dir,"/output/geo-proc/predictions/Biome12_prediction.tif"))
biome4_pred <- raster(paste0(dir,"/output/geo-proc/predictions/Biome4_prediction.tif"))

# converting to spatial data frames
# biome 1
biome1_pred_spdf <- as(biome1_pred, "SpatialPixelsDataFrame")
biome1_pred_df <- as.data.frame(biome1_pred_spdf)
colnames(biome1_pred_df) <- c("values", "x", "y")

# biome 7
biome7_pred_spdf <- as(biome7_pred, "SpatialPixelsDataFrame")
biome7_pred_df <- as.data.frame(biome7_pred_spdf)
colnames(biome7_pred_df) <- c("values", "x", "y")

# biome 12
biome12_pred_spdf <- as(biome12_pred, "SpatialPixelsDataFrame")
biome12_pred_df <- as.data.frame(biome12_pred_spdf)
colnames(biome12_pred_df) <- c("values", "x", "y")

# biome 4
biome4_pred_spdf <- as(biome4_pred, "SpatialPixelsDataFrame")
biome4_pred_df <- as.data.frame(biome4_pred_spdf)
colnames(biome4_pred_df) <- c("values", "x", "y")

# add JN: aggregate for faster processing, remove for final figure
biome1_pred_spdf_r <- raster(biome1_pred_spdf)
biome7_pred_spdf_r <- raster(biome7_pred_spdf)
biome12_pred_spdf_r <- raster(biome12_pred_spdf)
biome4_pred_spdf_r <- raster(biome4_pred_spdf)

# Aggregate 
biome1_pred_agg_10  <- aggregate(biome1_pred_spdf_r, fact =3, FUN = mean)
biome7_pred_agg_10  <- aggregate(biome7_pred_spdf_r, fact = 3, FUN = mean)
biome12_pred_agg_10  <- aggregate(biome12_pred_spdf_r, fact = 3, FUN = mean)
biome4_pred_agg_10  <- aggregate(biome4_pred_spdf_r, fact = 3, FUN = mean)

# reproject raster
biome1_pred_agg_ee <- projectRaster(biome1_pred_agg_10, crs = crs("+proj=eqearth"))
biome7_pred_agg_ee <- projectRaster(biome7_pred_agg_10, crs = crs("+proj=eqearth"))
biome12_pred_agg_ee <- projectRaster(biome12_pred_agg_10, crs = crs("+proj=eqearth"))
biome4_pred_agg_ee <- projectRaster(biome4_pred_agg_10, crs = crs("+proj=eqearth"))

biome1_pred_agg_ee_df <- as.data.frame(biome1_pred_agg_ee, xy = TRUE)
biome7_pred_agg_ee_df <- as.data.frame(biome7_pred_agg_ee, xy = TRUE)
biome12_pred_agg_ee_df <- as.data.frame(biome12_pred_agg_ee, xy = TRUE)
biome4_pred_agg_ee_df <- as.data.frame(biome4_pred_agg_ee, xy = TRUE)

colnames(biome1_pred_agg_ee_df) <- c("x", "y", "values")
colnames(biome7_pred_agg_ee_df) <- c("x", "y", "values")
colnames(biome12_pred_agg_ee_df) <- c("x", "y", "values")
colnames(biome4_pred_agg_ee_df) <- c("x", "y", "values")

# Conversion of raster to stars, then sf
# convert to stars object
biome1_pred_agg_stars <- st_as_stars(biome1_pred_agg_10)
dim(biome1_pred_agg_stars)
str(biome1_pred_agg_stars)

biome7_pred_agg_stars <- st_as_stars(biome7_pred_agg_10)
dim(biome7_pred_agg_stars)
str(biome7_pred_agg_stars)

biome12_pred_agg_stars <- st_as_stars(biome12_pred_agg_10)
dim(biome12_pred_agg_stars)
str(biome12_pred_agg_stars)

biome4_pred_agg_stars <- st_as_stars(biome4_pred_agg_10)
dim(biome4_pred_agg_stars)
str(biome4_pred_agg_stars)

# convert stars to polygons (each pixel becomes a polyon)
biome1_pred_poly <- st_xy2sfc(biome1_pred_agg_stars, as_points = FALSE)
biome1_pred_agg_sf <- st_as_sf(biome1_pred_poly)
names(biome1_pred_agg_sf)[1] <- "values"

biome7_pred_poly <- st_xy2sfc(biome7_pred_agg_stars, as_points = FALSE)
biome7_pred_agg_sf <- st_as_sf(biome7_pred_poly)
names(biome7_pred_agg_sf)[1] <- "values"

biome12_pred_poly <- st_xy2sfc(biome12_pred_agg_stars, as_points = FALSE)
biome12_pred_agg_sf <- st_as_sf(biome12_pred_poly)
names(biome12_pred_agg_sf)[1] <- "values"

biome4_pred_poly <- st_xy2sfc(biome4_pred_agg_stars, as_points = FALSE)
biome4_pred_agg_sf <- st_as_sf(biome4_pred_poly)
names(biome4_pred_agg_sf)[1] <- "values"

ctry_border_size <- 0.1
ctry_border_color1 <- "grey60"
ctry_border_color2 <- "grey25"
color_plot_border <- "grey20"
ocean_color <- "grey95"
biome_color <- "#adff2f"
ctry_border_size_biomes <- 0.02

# Using reprojected raster #  problem is that Alaska and Russian far east show up twice
# also happens when reprojecting in QGIS
biome1_pred_plot_ee_v2 <- ggplot() +
geom_sf(data = biome1_pred_agg_sf, mapping = aes(fill = values), color = NA) +
geom_sf(data = ocean_ee, color = ctry_border_color2, fill = ocean_color, size = ctry_border_size)+
geom_sf(data = world_sf_ee, fill=NA, color= alpha(ctry_border_color2, 0.5), size = ctry_border_size)+
scale_fill_viridis_c(name="Allocation probability", na.value = "white") +
theme_map() +
coord_sf(crs = sf::st_crs(crs_equal_earth)) 
biome1_pred_plot_ee_v2 
# save
ggsave(filename = paste0(dir,"/plots/Figure.4_biome1.png"), 
plot = biome1_pred_plot_ee_v2, dpi = 300)

biome7_pred_plot_ee_v2 <- ggplot() +
geom_sf(data = biome7_pred_agg_sf, mapping = aes(fill = values), color = NA) +
geom_sf(data = ocean_ee, color = ctry_border_color2, fill = ocean_color, size = ctry_border_size)+
geom_sf(data = world_sf, fill=NA, color= alpha(ctry_border_color2, 0.5), size = ctry_border_size)+
scale_fill_viridis_c(name="Allocation probability", na.value = "white") +
theme_map() +
coord_sf(crs = sf::st_crs(crs_equal_earth)) 
biome7_pred_plot_ee_v2 
# save
ggsave(filename = paste0(dir,"/plots/Figure.4_biome7.png"), 
plot = biome7_pred_plot_ee_v2, dpi = 300)

biome12_pred_plot_ee_v2 <- ggplot() +
geom_sf(data = biome12_pred_agg_sf, mapping = aes(fill = values), color = NA) +
geom_sf(data = ocean_ee, color = ctry_border_color2, fill = ocean_color, size = ctry_border_size)+
geom_sf(data = world_sf, fill=NA, color= alpha(ctry_border_color2, 0.5), size = ctry_border_size)+
geom_tile(data = biome12_pred_agg_ee_df, aes(x = x, y = y, fill = values)) +
scale_fill_viridis_d(name="Allocation probability", na.value = "white") +
theme_map() +
coord_sf(crs = sf::st_crs(crs_equal_earth)) 
biome12_pred_plot_ee_v2 
# save
ggsave(filename = paste0(dir,"/plots/Figure.4_biome12.png"), 
plot = biome12_pred_plot_ee_v2, dpi = 300)

biome4_pred_plot_ee_v2 <- ggplot() +
geom_sf(data = biome4_pred_agg_sf, mapping = aes(fill = values), color = NA) +
geom_sf(data = ocean_ee, color = ctry_border_color2, fill = ocean_color, size = ctry_border_size)+
geom_sf(data = world_sf, fill=NA, color= alpha(ctry_border_color2, 0.5), size = ctry_border_size)+
scale_fill_viridis_c(name="Allocation probability", na.value = "white") +
theme_map() +
coord_sf(crs = sf::st_crs(crs_equal_earth)) 
biome4_pred_plot_ee_v2 
# save
ggsave(filename = paste0(dir,"/plots/Figure.4_biome4.png"), 
plot = biome4_pred_plot_ee_v2, dpi = 300)
```

# Figure
```{r figure 5: Four biome Aichi disparity maps (also for figure 5)}
biome1_disp <- raster(paste0(dir,"/output/geo-proc/biv-maps/Aichi/Biome1_bivmapFinalEE.tif"))
biome7_disp <- raster(paste0(dir,"/output/geo-proc/biv-maps/Aichi/Biome7_bivmapFinal.tif"))
biome12_disp <- raster(paste0(dir,"/output/geo-proc/biv-maps/Aichi/Biome12_bivmapFinal.tif"))
biome4_disp <- raster(paste0(dir,"/output/geo-proc/biv-maps/Aichi/Biome4_bivmapFinal.tif"))

# transforming world and ocean shape files to equal earth projection
world_sf_ee <- st_transform(world, crs = st_crs(crs_equal_earth))# transforming to CRS
ocean_ee <- st_transform(ocean, crs = st_crs(crs_equal_earth))# transforming to CRS

# converting to spatial data frames
# biome 1
biome1_disp_spdf <- as(biome1_disp, "SpatialPixelsDataFrame")
biome1_disp_df <- as.data.frame(biome1_disp_spdf)
colnames(biome1_disp_df) <- c("values", "x", "y")

# biome 7
biome7_disp_spdf <- as(biome7_disp, "SpatialPixelsDataFrame")
biome7_disp_df <- as.data.frame(biome7_disp_spdf)
colnames(biome7_disp_df) <- c("values", "x", "y")

# biome 12
biome12_disp_spdf <- as(biome12_disp, "SpatialPixelsDataFrame")
biome12_disp_df <- as.data.frame(biome12_disp_spdf)
colnames(biome12_disp_df) <- c("values", "x", "y")

# biome 4
biome4_disp_spdf <- as(biome4_disp, "SpatialPixelsDataFrame")
biome4_disp_df <- as.data.frame(biome4_disp_spdf)
colnames(biome4_disp_df) <- c("values", "x", "y")

# aggregate for faster processing, remove for final figure
biome1_disp_spdf_r <- raster(biome1_disp_spdf)
biome7_disp_spdf_r <- raster(biome7_disp_spdf)
biome12_disp_spdf_r <- raster(biome12_disp_spdf)
biome4_disp_spdf_r <- raster(biome4_disp_spdf)

biome1_disp_agg_10  <- aggregate(biome1_disp_spdf_r, fact = 3, FUN = mean)
biome7_disp_agg_10  <- aggregate(biome7_disp_spdf_r, fact = 3, FUN = mean)
biome12_disp_agg_10  <- aggregate(biome12_disp_spdf_r, fact = 3, FUN = mean)
biome4_disp_agg_10  <- aggregate(biome4_disp_spdf_r, fact = 3, FUN = mean)

crs(biome1_disp_agg_10) <- "+proj=eqearth"
crs(biome7_disp_agg_10) <- "+proj=eqearth"
crs(biome12_disp_agg_10) <- "+proj=eqearth"
crs(biome4_disp_agg_10) <- "+proj=eqearth"


# reproject raster
biome1_disp_agg_ee <- projectRaster(biome1_disp_agg_10, crs = crs("+proj=eqearth"))
biome7_disp_agg_ee <- projectRaster(biome7_disp_agg_10, crs = crs("+proj=eqearth"))
biome12_disp_agg_ee <- projectRaster(biome12_disp_agg_10, crs = crs("+proj=eqearth"))
biome4_disp_agg_ee <- projectRaster(biome4_disp_agg_10, crs = crs("+proj=eqearth"))

biome1_disp_agg_ee_df <- as.data.frame(biome1_disp_agg_ee, xy = TRUE)
biome7_disp_agg_ee_df <- as.data.frame(biome7_disp_agg_ee, xy = TRUE)
biome12_disp_agg_ee_df <- as.data.frame(biome12_disp_agg_ee, xy = TRUE)
biome4_disp_agg_ee_df <- as.data.frame(biome4_disp_agg_ee, xy = TRUE)

colnames(biome1_disp_agg_ee_df) <- c("x", "y", "values")
colnames(biome7_disp_agg_ee_df) <- c("x", "y", "values")
colnames(biome12_disp_agg_ee_df) <- c("x", "y", "values")
colnames(biome4_disp_agg_ee_df) <- c("x", "y", "values")

# Conversion of raster to stars, then sf
# convert to stars object
biome1_disp_agg_stars <- st_as_stars(biome1_disp_agg_10)
dim(biome1_disp_agg_stars)
str(biome1_disp_agg_stars)

biome7_disp_agg_stars <- st_as_stars(biome7_disp_agg_10)
dim(biome7_disp_agg_stars)
str(biome7_disp_agg_stars)

biome12_disp_agg_stars <- st_as_stars(biome12_disp_agg_10)
dim(biome12_disp_agg_stars)
str(biome12_disp_agg_stars)

biome4_disp_agg_stars <- st_as_stars(biome4_disp_agg_10)
dim(biome4_disp_agg_stars)
str(biome4_disp_agg_stars)

# convert stars to polygons (each pixel becomes a polyon)
biome1_disp_poly <- st_xy2sfc(biome1_disp_agg_stars, as_points = FALSE)
biome1_disp_agg_sf <- st_as_sf(biome1_disp_poly)
names(biome1_disp_agg_sf)[1] <- "values"

biome7_disp_poly <- st_xy2sfc(biome7_disp_agg_stars, as_points = FALSE)
biome7_disp_agg_sf <- st_as_sf(biome7_disp_poly)
names(biome7_disp_agg_sf)[1] <- "values"

biome12_disp_poly <- st_xy2sfc(biome12_disp_agg_stars, as_points = FALSE)
biome12_disp_agg_sf <- st_as_sf(biome12_disp_poly)
names(biome12_disp_agg_sf)[1] <- "values"

biome4_disp_poly <- st_xy2sfc(biome4_disp_agg_stars, as_points = FALSE)
biome4_disp_agg_sf <- st_as_sf(biome4_disp_poly)
names(biome4_disp_agg_sf)[1] <- "values"

ctry_border_size <- 0.1
ctry_border_color1 <- "grey60"
ctry_border_color2 <- "grey25"
color_plot_border <- "grey20"
ocean_color <- "grey95"
biome_color <- "#adff2f"
ctry_border_size_biomes <- 0.02

# using reprojected raster #  problem is that Alaska and Russian far east show up twice
# also happens when reprojecting in QGIS
biomes_disp_plot_ee_v2 <- ggplot() +
geom_sf(data = biome1_disp_agg_sf, mapping = aes(fill = values), color = NA) +
geom_sf(data = biome7_disp_agg_sf, mapping = aes(fill = values), color = NA) +
geom_sf(data = biome12_disp_agg_sf, mapping = aes(fill = values), color = NA) +
geom_sf(data = biome4_disp_agg_sf, mapping = aes(fill = values), color = NA) +
geom_sf(data = ocean_ee, color = ctry_border_color2, fill = ocean_color, size = ctry_border_size)+
geom_sf(data = world_sf_ee, fill=NA, color= alpha(ctry_border_color2, 0.5), size = ctry_border_size)+
scale_fill_gradientn(colours = col.matrix, na.value = "transparent")+
theme_map() +
coord_sf(crs = sf::st_crs(crs_equal_earth)) 
biomes_disp_plot_ee_v2
# save
ggsave(filename = paste0(dir,"/plots/FigureTESTB.5x.png"), plot = biomes_disp_plot_ee_v2
, dpi = 300)

# Insets: biome extents
biome1_sf <- st_read(paste0(dir,"/data-raw/geo-raw/shp/Biome1.shp"))
biome7_sf <- st_read(paste0(dir,"/data-raw/geo-raw/shp/Biome7.shp"))
biome12_sf <- st_read(paste0(dir,"/data-raw/geo-raw/shp/Biome12.shp"))
biome4_sf <- st_read(paste0(dir,"/data-raw/geo-raw/shp/Biome4.shp"))

biome1_sf_ee <- st_transform(biome1_sf, crs = st_crs(crs_equal_earth))# transforming to CRS
biome7_sf_ee <- st_transform(biome7_sf, crs = st_crs(crs_equal_earth))# transforming to CRS
biome12_sf_ee <- st_transform(biome12_sf, crs = st_crs(crs_equal_earth))# transforming to CRS
biome4_sf_ee <- st_transform(biome4_sf, crs = st_crs(crs_equal_earth))# transforming to CRS

# Inset plots
biome1_inset_ee_v2 <- ggplot() +
geom_sf(data = biome1_sf, color = biome_color, fill = biome_color, size= ctry_border_size_biomes)+
geom_sf(data = ocean_ee, color = ctry_border_color2, fill = ocean_color, size = ctry_border_size_biomes)+
geom_sf(data = world_sf, fill=NA, color= alpha(ctry_border_color2, 0.5), size = ctry_border_size_biomes)+
theme_map() +
coord_sf(crs = sf::st_crs(crs_equal_earth)) 
biome1_inset_ee_v2
ggsave(filename = paste0(dir,"/plots/Figure.5_biome1.png"), plot = biome1_inset_ee_v2
, dpi = 300)

biome7_inset_ee_v2 <- ggplot() +
geom_sf(data = biome7_sf, color = biome_color, fill = biome_color, size= ctry_border_size_biomes)+
geom_sf(data = ocean_ee, color = ctry_border_color2, fill = ocean_color, size = ctry_border_size_biomes)+
geom_sf(data = world_sf, fill=NA, color= alpha(ctry_border_color2, 0.5), size = ctry_border_size_biomes)+
theme_map() +
coord_sf(crs = sf::st_crs(crs_equal_earth)) 
biome7_inset_ee_v2
ggsave(filename = paste0(dir,"/plots/Figure.5_biome7.png"), plot = biome7_inset_ee_v2
, dpi = 300)

biome12_inset_ee_v2 <- ggplot() +
geom_sf(data = biome12_sf, color = biome_color, fill = biome_color, size= ctry_border_size_biomes)+
geom_sf(data = ocean_ee, color = ctry_border_color2, fill = ocean_color, size = ctry_border_size_biomes)+
geom_sf(data = world_sf, fill=NA, color= alpha(ctry_border_color2, 0.5), size = ctry_border_size_biomes)+
theme_map() +
coord_sf(crs = sf::st_crs(crs_equal_earth)) 
biome12_inset_ee_v2
ggsave(filename = paste0(dir,"/plots/Figure.5_biome12.png"), plot = biome12_inset_ee_v2
, dpi = 300)

biome4_inset_ee_v2 <- ggplot() +
geom_sf(data = biome4_sf, color = biome_color, fill = biome_color, size= ctry_border_size_biomes)+
geom_sf(data = ocean_ee, color = ctry_border_color2, fill = ocean_color, size = ctry_border_size_biomes)+
geom_sf(data = world_sf, fill=NA, color= alpha(ctry_border_color2, 0.5), size = ctry_border_size_biomes)+
theme_map() +
coord_sf(crs = sf::st_crs(crs_equal_earth)) 
biome4_inset_ee_v2
ggsave(filename = paste0(dir,"/plots/Figure.5_biome4.png"), plot = biome4_inset_ee_v2
, dpi = 300)

```

# Figure
```{r figure 5: biodcrisis disparity maps}
# disparity
biome1_disp <- raster(paste0(dir,"/output/geo-proc/biv-maps/biodcrisis/Biome1_biodcrisis_disparity_map_coltabFinal.tif"))
biome7_disp <- raster(paste0(dir,"/output/geo-proc/biv-maps/biodcrisis/Biome7_biodcrisis_disparity_map_coltabFinal.tif"))
biome12_disp <- raster(paste0(dir,"/output/geo-proc/biv-maps/biodcrisis/Biome12_biodcrisis_disparity_map_coltabFinal.tif"))
biome4_disp <- raster(paste0(dir,"/output/geo-proc/biv-maps/biodcrisis/Biome4_biodcrisis_disparity_map_coltabFinal.tif"))

# transforming world and ocean shape files to equal earth projection
world_sf_ee <- st_transform(world, crs = st_crs(crs_equal_earth))# transforming to CRS
ocean_ee <- st_transform(ocean, crs = st_crs(crs_equal_earth))# transforming to CRS

# converting to spatial data frames
# biome 1
biome1_disp_spdf <- as(biome1_disp, "SpatialPixelsDataFrame")
biome1_disp_df <- as.data.frame(biome1_disp_spdf)
colnames(biome1_disp_df) <- c("values", "x", "y")

# biome 7
biome7_disp_spdf <- as(biome7_disp, "SpatialPixelsDataFrame")
biome7_disp_df <- as.data.frame(biome7_disp_spdf)
colnames(biome7_disp_df) <- c("values", "x", "y")

# biome 12
biome12_disp_spdf <- as(biome12_disp, "SpatialPixelsDataFrame")
biome12_disp_df <- as.data.frame(biome12_disp_spdf)
colnames(biome12_disp_df) <- c("values", "x", "y")

# biome 4
biome4_disp_spdf <- as(biome4_disp, "SpatialPixelsDataFrame")
biome4_disp_df <- as.data.frame(biome4_disp_spdf)
colnames(biome4_disp_df) <- c("values", "x", "y")

# aggregate for faster processing, remove for final figure
biome1_disp_spdf_r <- raster(biome1_disp_spdf)
biome7_disp_spdf_r <- raster(biome7_disp_spdf)
biome12_disp_spdf_r <- raster(biome12_disp_spdf)
biome4_disp_spdf_r <- raster(biome4_disp_spdf)

biome1_disp_agg_10  <- aggregate(biome1_disp_spdf_r, fact = 3, FUN = mean)
biome7_disp_agg_10  <- aggregate(biome7_disp_spdf_r, fact = 3, FUN = mean)
biome12_disp_agg_10  <- aggregate(biome12_disp_spdf_r, fact = 3, FUN = mean)
biome4_disp_agg_10  <- aggregate(biome4_disp_spdf_r, fact = 3, FUN = mean)

crs(biome1_disp_agg_10) <- "+proj=eqearth"
crs(biome7_disp_agg_10) <- "+proj=eqearth"
crs(biome12_disp_agg_10) <- "+proj=eqearth"
crs(biome4_disp_agg_10) <- "+proj=eqearth"


# reproject raster
biome1_disp_agg_ee <- projectRaster(biome1_disp_agg_10, crs = crs("+proj=eqearth"))
biome7_disp_agg_ee <- projectRaster(biome7_disp_agg_10, crs = crs("+proj=eqearth"))
biome12_disp_agg_ee <- projectRaster(biome12_disp_agg_10, crs = crs("+proj=eqearth"))
biome4_disp_agg_ee <- projectRaster(biome4_disp_agg_10, crs = crs("+proj=eqearth"))

biome1_disp_agg_ee_df <- as.data.frame(biome1_disp_agg_ee, xy = TRUE)
biome7_disp_agg_ee_df <- as.data.frame(biome7_disp_agg_ee, xy = TRUE)
biome12_disp_agg_ee_df <- as.data.frame(biome12_disp_agg_ee, xy = TRUE)
biome4_disp_agg_ee_df <- as.data.frame(biome4_disp_agg_ee, xy = TRUE)

colnames(biome1_disp_agg_ee_df) <- c("x", "y", "values")
colnames(biome7_disp_agg_ee_df) <- c("x", "y", "values")
colnames(biome12_disp_agg_ee_df) <- c("x", "y", "values")
colnames(biome4_disp_agg_ee_df) <- c("x", "y", "values")

# Conversion of raster to stars, then sf
# convert to stars object
biome1_disp_agg_stars <- st_as_stars(biome1_disp_agg_10)
dim(biome1_disp_agg_stars)
str(biome1_disp_agg_stars)

biome7_disp_agg_stars <- st_as_stars(biome7_disp_agg_10)
dim(biome7_disp_agg_stars)
str(biome7_disp_agg_stars)

biome12_disp_agg_stars <- st_as_stars(biome12_disp_agg_10)
dim(biome12_disp_agg_stars)
str(biome12_disp_agg_stars)

biome4_disp_agg_stars <- st_as_stars(biome4_disp_agg_10)
dim(biome4_disp_agg_stars)
str(biome4_disp_agg_stars)

# convert stars to polygons (each pixel becomes a polyon)
biome1_disp_poly <- st_xy2sfc(biome1_disp_agg_stars, as_points = FALSE)
biome1_disp_agg_sf <- st_as_sf(biome1_disp_poly)
names(biome1_disp_agg_sf)[1] <- "values"

biome7_disp_poly <- st_xy2sfc(biome7_disp_agg_stars, as_points = FALSE)
biome7_disp_agg_sf <- st_as_sf(biome7_disp_poly)
names(biome7_disp_agg_sf)[1] <- "values"

biome12_disp_poly <- st_xy2sfc(biome12_disp_agg_stars, as_points = FALSE)
biome12_disp_agg_sf <- st_as_sf(biome12_disp_poly)
names(biome12_disp_agg_sf)[1] <- "values"

biome4_disp_poly <- st_xy2sfc(biome4_disp_agg_stars, as_points = FALSE)
biome4_disp_agg_sf <- st_as_sf(biome4_disp_poly)
names(biome4_disp_agg_sf)[1] <- "values"

ctry_border_size <- 0.1
ctry_border_color1 <- "grey60"
ctry_border_color2 <- "grey25"
color_plot_border <- "grey20"
ocean_color <- "grey95"
biome_color <- "#adff2f"
ctry_border_size_biomes <- 0.02

# using reprojected raster #  problem is that Alaska and Russian far east show up twice
# also happens when reprojecting in QGIS
biomes_disp_plot_ee_v2 <- ggplot() +
geom_sf(data = biome1_disp_agg_sf, mapping = aes(fill = values), color = NA) +
geom_sf(data = biome7_disp_agg_sf, mapping = aes(fill = values), color = NA) +
geom_sf(data = biome12_disp_agg_sf, mapping = aes(fill = values), color = NA) +
geom_sf(data = biome4_disp_agg_sf, mapping = aes(fill = values), color = NA) +
geom_sf(data = ocean_ee, color = ctry_border_color2, fill = ocean_color, size = ctry_border_size)+
geom_sf(data = world_sf_ee, fill=NA, color= alpha(ctry_border_color2, 0.5), size = ctry_border_size)+
scale_fill_gradientn(colours = col.matrix, na.value = "transparent")+
theme_map() +
coord_sf(crs = sf::st_crs(crs_equal_earth)) 
biomes_disp_plot_ee_v2
# save
ggsave(filename = paste0(dir,"/plots/Figure.5_biodcrisis.png"), plot = biomes_disp_plot_ee_v2
, dpi = 300)

# Insets: biome extents
biome1_sf <- st_read(paste0(dir,"/data-raw/geo-raw/shp/Biome1.shp"))
biome7_sf <- st_read(paste0(dir,"/data-raw/geo-raw/shp/Biome7.shp"))
biome12_sf <- st_read(paste0(dir,"/data-raw/geo-raw/shp/Biome12.shp"))
biome4_sf <- st_read(paste0(dir,"/data-raw/geo-raw/shp/Biome4.shp"))

biome1_sf_ee <- st_transform(biome1_sf, crs = st_crs(crs_equal_earth))# transforming to CRS
biome7_sf_ee <- st_transform(biome7_sf, crs = st_crs(crs_equal_earth))# transforming to CRS
biome12_sf_ee <- st_transform(biome12_sf, crs = st_crs(crs_equal_earth))# transforming to CRS
biome4_sf_ee <- st_transform(biome4_sf, crs = st_crs(crs_equal_earth))# transforming to CRS

# Inset plots
biome1_inset_ee_v2 <- ggplot() +
geom_sf(data = biome1_sf, color = biome_color, fill = biome_color, size= ctry_border_size_biomes)+
geom_sf(data = ocean_ee, color = ctry_border_color2, fill = ocean_color, size = ctry_border_size_biomes)+
geom_sf(data = world_sf_ee, fill=NA, color= alpha(ctry_border_color2, 0.5), size = ctry_border_size_biomes)+
theme_map() +
coord_sf(crs = sf::st_crs(crs_equal_earth)) 
biome1_inset_ee_v2
ggsave(filename = paste0(dir,"/plots/Figure.5_biome1.png"), plot = biome1_inset_ee_v2
, dpi = 300)

biome7_inset_ee_v2 <- ggplot() +
geom_sf(data = biome7_sf, color = biome_color, fill = biome_color, size= ctry_border_size_biomes)+
geom_sf(data = ocean_ee, color = ctry_border_color2, fill = ocean_color, size = ctry_border_size_biomes)+
geom_sf(data = world_sf, fill=NA, color= alpha(ctry_border_color2, 0.5), size = ctry_border_size_biomes)+
theme_map() +
coord_sf(crs = sf::st_crs(crs_equal_earth)) 
biome7_inset_ee_v2
ggsave(filename = paste0(dir,"/plots/Figure.5_biome7.png"), plot = biome7_inset_ee_v2
, dpi = 300)

biome12_inset_ee_v2 <- ggplot() +
geom_sf(data = biome12_sf, color = biome_color, fill = biome_color, size= ctry_border_size_biomes)+
geom_sf(data = ocean_ee, color = ctry_border_color2, fill = ocean_color, size = ctry_border_size_biomes)+
geom_sf(data = world_sf, fill=NA, color= alpha(ctry_border_color2, 0.5), size = ctry_border_size_biomes)+
theme_map() +
coord_sf(crs = sf::st_crs(crs_equal_earth)) 
biome12_inset_ee_v2
ggsave(filename = paste0(dir,"/plots/Figure.5_biome12.png"), plot = biome12_inset_ee_v2
, dpi = 300)

biome4_inset_ee_v2 <- ggplot() +
geom_sf(data = biome4_sf, color = biome_color, fill = biome_color, size= ctry_border_size_biomes)+
geom_sf(data = ocean_ee, color = ctry_border_color2, fill = ocean_color, size = ctry_border_size_biomes)+
geom_sf(data = world_sf, fill=NA, color= alpha(ctry_border_color2, 0.5), size = ctry_border_size_biomes)+
theme_map() +
coord_sf(crs = sf::st_crs(crs_equal_earth)) 
biome4_inset_ee_v2
ggsave(filename = paste0(dir,"/plots/Figure.5_biome4.png"), plot = biome4_inset_ee_v2
, dpi = 300)

```

# Figure 
```{r extended data figure 4: Jacknife tests}
# AUC tests at global scale; global, biome 1, biome 4, biome 7 and biome 12
p4#global(a)
p5#biome1(b)
p7#biome7(c)
p8#biome12(d)
p6#biome4(e)

# create grid
AUCjkt <- ggarrange(p4,p5,p7,p8,p6,labels = c("a)", "b)", "c)","d)","e)"),ncol=2, nrow=3)
AUCjkt

# save
ggsave(filename = paste0(dir,"/plots/ExTFig4_Jackknifes.png"), plot = AUCjkt, width = 13, height = 13, dpi = 300)
```

# Figure
```{r extended data figure 5: Aichi disparity maps}
# Biome aichi maps
biome1_aichi <- raster(paste0(dir,"/output/geo-proc/aichi-maps/Biome1aichi_map_FinalEE.tif"))
biome7_aichi <- raster(paste0(dir,"/output/geo-proc/aichi-maps/Biome7aichi_map_FinalEE.tif"))
biome12_aichi <- raster(paste0(dir,"/output/geo-proc/aichi-maps/Biome12aichi_map_FinalEE.tif"))
biome4_aichi<- raster(paste0(dir,"/output/geo-proc/aichi-maps/Biome4aichi_map_FinalEE.tif"))

# converting to spatial data frames
# biome 1
biome1_aichi_spdf <- as(biome1_aichi, "SpatialPixelsDataFrame")
biome1_aichi_df <- as.data.frame(biome1_aichi_spdf)
colnames(biome1_aichi_df) <- c("values", "x", "y")

# biome 7
biome7_aichi_spdf <- as(biome7_aichi, "SpatialPixelsDataFrame")
biome7_aichi_df <- as.data.frame(biome7_aichi_spdf)
colnames(biome7_aichi_df) <- c("values", "x", "y")

# biome 12
biome12_aichi_spdf <- as(biome12_aichi, "SpatialPixelsDataFrame")
biome12_aichi_df <- as.data.frame(biome12_aichi_spdf)
colnames(biome12_aichi_df) <- c("values", "x", "y")

# biome 4
biome4_aichi_spdf <- as(biome4_aichi, "SpatialPixelsDataFrame")
biome4_aichi_df <- as.data.frame(biome4_aichi_spdf)
colnames(biome4_aichi_df) <- c("values", "x", "y")

# aggregate for faster processing, remove for final figure
biome1_aichi_spdf_r <- raster(biome1_aichi_spdf)
biome7_aichi_spdf_r <- raster(biome7_aichi_spdf)
biome12_aichi_spdf_r <- raster(biome12_aichi_spdf)
biome4_aichi_spdf_r <- raster(biome4_aichi_spdf)

# Aggregate 
biome1_aichi_agg_10  <- aggregate(biome1_aichi_spdf_r, fact =3, FUN = mean)
biome7_aichi_agg_10  <- aggregate(biome7_aichi_spdf_r, fact = 3, FUN = mean)
biome12_aichi_agg_10  <- aggregate(biome12_aichi_spdf_r, fact = 3, FUN = mean)
biome4_aichi_agg_10  <- aggregate(biome4_aichi_spdf_r, fact = 3, FUN = mean)

# reproject raster
biome1_aichi_agg_ee <- projectRaster(biome1_aichi_agg_10, crs = crs("+proj=eqearth"))
biome7_aichi_agg_ee <- projectRaster(biome7_aichi_agg_10, crs = crs("+proj=eqearth"))
biome12_aichi_agg_ee <- projectRaster(biome12_aichi_agg_10, crs = crs("+proj=eqearth"))
biome4_aichi_agg_ee <- projectRaster(biome4_aichi_agg_10, crs = crs("+proj=eqearth"))

biome1_aichi_agg_ee_df <- as.data.frame(biome1_aichi_agg_ee, xy = TRUE)
biome7_aichi_agg_ee_df <- as.data.frame(biome7_aichi_agg_ee, xy = TRUE)
biome12_aichi_agg_ee_df <- as.data.frame(biome12_aichi_agg_ee, xy = TRUE)
biome4_aichi_agg_ee_df <- as.data.frame(biome4_aichi_agg_ee, xy = TRUE)

colnames(biome1_aichi_agg_ee_df) <- c("x", "y", "values")
colnames(biome7_aichi_agg_ee_df) <- c("x", "y", "values")
colnames(biome12_aichi_agg_ee_df) <- c("x", "y", "values")
colnames(biome4_aichi_agg_ee_df) <- c("x", "y", "values")

# Conversion of raster to stars, then sf
# convert to stars object
biome1_aichi_agg_stars <- st_as_stars(biome1_aichi_agg_10)
dim(biome1_aichi_agg_stars)
str(biome1_aichi_agg_stars)

biome7_aichi_agg_stars <- st_as_stars(biome7_aichi_agg_10)
dim(biome7_aichi_agg_stars)
str(biome7_aichi_agg_stars)

biome12_aichi_agg_stars <- st_as_stars(biome12_aichi_agg_10)
dim(biome12_aichi_agg_stars)
str(biome12_aichi_agg_stars)

biome4_aichi_agg_stars <- st_as_stars(biome4_aichi_agg_10)
dim(biome4_aichi_agg_stars)
str(biome4_aichi_agg_stars)

# convert stars to polygons (each pixel becomes a polyon)
biome1_aichi_poly <- st_xy2sfc(biome1_aichi_agg_stars, as_points = FALSE)
biome1_aichi_agg_sf <- st_as_sf(biome1_aichi_poly)
names(biome1_aichi_agg_sf)[1] <- "values"

biome7_aichi_poly <- st_xy2sfc(biome7_aichi_agg_stars, as_points = FALSE)
biome7_aichi_agg_sf <- st_as_sf(biome7_aichi_poly)
names(biome7_aichi_agg_sf)[1] <- "values"

biome12_aichi_poly <- st_xy2sfc(biome12_aichi_agg_stars, as_points = FALSE)
biome12_aichi_agg_sf <- st_as_sf(biome12_aichi_poly)
names(biome12_aichi_agg_sf)[1] <- "values"

biome4_aichi_poly <- st_xy2sfc(biome4_aichi_agg_stars, as_points = FALSE)
biome4_aichi_agg_sf <- st_as_sf(biome4_aichi_poly)
names(biome4_aichi_agg_sf)[1] <- "values"

ctry_border_size <- 0.1
ctry_border_color1 <- "grey60"
ctry_border_color2 <- "grey25"
color_plot_border <- "grey20"
ocean_color <- "grey95"
biome_color <- "#adff2f"
ctry_border_size_biomes <- 0.02

# Plotting
biome1_aichi_plot_ee_v2 <- ggplot() +
geom_sf(data = biome1_aichi_agg_sf, mapping = aes(fill = values), color = NA) +
geom_sf(data = ocean_ee, color = ctry_border_color2, fill = ocean_color, size = ctry_border_size)+
geom_sf(data = world, fill=NA, color= alpha(ctry_border_color2, 0.5), size = ctry_border_size)+
scale_color_viridis(discrete=F, option = "A") +
scale_fill_viridis(discrete=F, option = "A",name="Aichi value", na.value = "white")+
theme_map() +
coord_sf(crs = sf::st_crs(crs_equal_earth)) 
biome1_aichi_plot_ee_v2 
# save
ggsave(filename = paste0(dir,"/plots/ExTFigure5_biome1.png"), 
plot = biome1_aichi_plot_ee_v2, dpi = 300)

biome7_aichi_plot_ee_v2 <- ggplot() +
geom_sf(data = biome7_aichi_agg_sf, mapping = aes(fill = values), color = NA) +
geom_sf(data = ocean_ee, color = ctry_border_color2, fill = ocean_color, size = ctry_border_size)+
geom_sf(data = world, fill=NA, color= alpha(ctry_border_color2, 0.5), size = ctry_border_size)+
scale_color_viridis(discrete=F, option = "A") +
scale_fill_viridis(discrete=F, option = "A",name="Aichi value", na.value = "white")+
theme_map() +
coord_sf(crs = sf::st_crs(crs_equal_earth)) 
biome7_aichi_plot_ee_v2 
# save
ggsave(filename = paste0(dir,"/plots/ExTFigure5_biome7.png"), 
plot = biome7_aichi_plot_ee_v2, dpi = 300)

biome12_aichi_plot_ee_v2 <- ggplot() +
geom_sf(data = biome12_aichi_agg_sf, mapping = aes(fill = values), color = NA) +
geom_sf(data = ocean_ee, color = ctry_border_color2, fill = ocean_color, size = ctry_border_size)+
geom_sf(data = world, fill=NA, color= alpha(ctry_border_color2, 0.5), size = ctry_border_size)+
scale_color_viridis(discrete=F, option = "A") +
scale_fill_viridis(discrete=F, option = "A",name="Aichi value", na.value = "white")+
theme_map() +
coord_sf(crs = sf::st_crs(crs_equal_earth)) 
biome12_aichi_plot_ee_v2 
# save
ggsave(filename = paste0(dir,"/plots/ExTFigure5_biome12.png"), 
plot = biome12_aichi_plot_ee_v2, dpi = 300)

biome4_aichi_plot_ee_v2 <- ggplot() +
geom_sf(data = biome4_aichi_agg_sf, mapping = aes(fill = values), color = NA) +
geom_sf(data = ocean_ee, color = ctry_border_color2, fill = ocean_color, size = ctry_border_size)+
geom_sf(data = world, fill=NA, color= alpha(ctry_border_color2, 0.5), size = ctry_border_size)+
scale_color_viridis(discrete=F, option = "A") +
scale_fill_viridis(discrete=F, option = "A",name="Aichi value", na.value = "white")+
theme_map() +
coord_sf(crs = sf::st_crs(crs_equal_earth)) 
biome4_aichi_plot_ee_v2 
# save
ggsave(filename = paste0(dir,"/plots/ExTFigure5_biome4.png"), 
plot = biome4_aichi_plot_ee_v2, dpi = 300)

# Violin plots
biome1_aichi_NoNA <- as.data.frame(na.omit(values(biome1_aichi))); head(biome1_aichi_NoNA)
biome7_aichi_NoNA <- as.data.frame(na.omit(values(biome7_aichi))); head(biome7_aichi_NoNA)
biome12_aichi_NoNA <- as.data.frame(na.omit(values(biome12_aichi))); head(biome12_aichi_NoNA)
biome4_aichi_NoNA <- as.data.frame(na.omit(values(biome4_aichi))); head(biome4_aichi_NoNA)


my_datal <- melt(biome1_aichi_NoNA, measure.vars = "na.omit(values(biome1_aichi))",
                 variable.name = "variable", value.name = "biome1_aichi");head(my_datal)
my_data7 <- melt(biome7_aichi_NoNA, measure.vars = "na.omit(values(biome7_aichi))", 
                 variable.name = "variable", value.name = "biome7_aichi");head(my_data7)
my_data12 <- melt(biome12_aichi_NoNA, measure.vars = "na.omit(values(biome12_aichi))", 
                  variable.name = "variable", value.name = "biome12_aichi");head(my_data12)
my_data4 <- melt(biome4_aichi_NoNA, measure.vars = "na.omit(values(biome4_aichi))", 
                 variable.name = "variable", value.name = "biome4_aichi");head(my_data4)

# plots
biome1_aichi_plot <- ggplot(my_datal, aes(x=variable, y= biome1_aichi))+
#geom_point(position = position_jitter(width = 0.25), size = 0.01, alpha=0.7, aes(colour = value))+
geom_violin(position = position_nudge(x = 0, y = 0), alpha = 0.5, adjust =1, trim = T, width = .5, fill= "#A4A4A4")+
geom_boxplot(aes(x = variable, y = biome1_aichi), outlier.shape = NA, alpha = 0.5, width = 0.02, colour = "black")+
scale_color_viridis(discrete=F, option = "A") +
scale_fill_viridis(discrete=F, option = "A")+
ylab("")+
ylim(0, 1)+
xlab("")+
theme_update(text = element_text(size=12))+
  guides(fill = FALSE, colour = FALSE) +
  theme_bw()+
  science_theme_facets
biome1_aichi_plot
ggsave(filename = paste0(dir,"/plots/ExTFigure5_biome1_violin.png"),
plot = biome1_aichi_plot, width =10, height = 7, dpi = 300)

biome7_aichi_plot <- ggplot(my_data7, aes(x=variable, y= biome7_aichi))+
#geom_point(position = position_jitter(width = 0.25), size = 0.01, alpha=0.7, aes(colour = value))+
geom_violin(position = position_nudge(x = 0, y = 0), alpha = 0.5, adjust =1, trim = T, width = .5, fill= "#A4A4A4")+
geom_boxplot(aes(x = variable, y = biome7_aichi), outlier.shape = NA, alpha = 0.5, width = 0.02, colour = "black")+
scale_color_viridis(discrete=F, option = "A") +
scale_fill_viridis(discrete=F, option = "A")+
ylab("")+
ylim(0, 1)+
xlab("")+
theme_update(text = element_text(size=12))+
guides(fill = FALSE, colour = FALSE) +
theme_bw()+
science_theme_facets
biome7_aichi_plot
ggsave(filename = paste0(dir,"/plots/ExTFigure5_biome7_violin.png"),
plot = biome7_aichi_plot, width =10, height = 7, dpi = 300)

biome12_aichi_plot <- ggplot(my_data12, aes(x=variable, y= biome12_aichi))+
#geom_point(position = position_jitter(width = 0.25), size = 0.01, alpha=0.7, aes(colour = value))+
geom_violin(position = position_nudge(x = 0, y = 0), alpha = 0.5, adjust =1, trim = T, width = .5, fill= "#A4A4A4")+
geom_boxplot(aes(x = variable, y = biome12_aichi), outlier.shape = NA, alpha = 0.5, width = 0.02, colour = "black")+
scale_color_viridis(discrete=F, option = "A") +
scale_fill_viridis(discrete=F, option = "A")+
ylab("")+
ylim(0, 1)+
xlab("")+
theme_update(text = element_text(size=12))+
guides(fill = FALSE, colour = FALSE) +
theme_bw()+
science_theme_facets
biome12_aichi_plot
ggsave(filename = paste0(dir,"/plots/ExTFigure5_biome12_violin.png"),plot = biome12_aichi_plot, width =10, height = 7, dpi = 300)

biome4_aichi_plot <- ggplot(my_data4, aes(x=variable, y= biome4_aichi))+
#geom_point(position = position_jitter(width = 0.25), size = 0.01, alpha=0.7, aes(colour = value))+
geom_violin(position = position_nudge(x = 0, y = 0), alpha = 0.5, adjust =1, trim = T, width = .5, fill= "#A4A4A4")+
geom_boxplot(aes(x = variable, y = biome4_aichi), outlier.shape = NA, alpha = 0.5, width = 0.02, colour = "black")+
scale_color_viridis(discrete=F, option = "A") +
scale_fill_viridis(discrete=F, option = "A")+
ylab("")+
ylim(0, 1)+
xlab("")+
theme_update(text = element_text(size=12))+
guides(fill = FALSE, colour = FALSE) +
theme_bw()+
science_theme_facets
biome4_aichi_plot
ggsave(filename = paste0(dir,"/plots/ExTFigure5_biome4_violin.png"),
plot = biome4_aichi_plot, width =10, height = 7, dpi = 300)
```

# Figure
```{r extended data figure 5: biodcrisis maps}
# transforming world and ocean shape files to equal earth projection
world_sf_ee <- st_transform(world, crs = st_crs(crs_equal_earth))# transforming to CRS
ocean_ee <- st_transform(ocean, crs = st_crs(crs_equal_earth))# transforming to CRS

# Biome biocrisis maps
biome1_bioodcrisis <- raster(paste0(dir,"/output/geo-proc/biodcrisis-maps/Biome1biodcrisis_map_FinalEEExtMatch3.tif"))
biome7_aichi <- raster(paste0(dir,"/output/geo-proc/aichi-maps/Biome7aichi_map_FinalEE.tif"))
biome12_aichi <- raster(paste0(dir,"/output/geo-proc/aichi-maps/Biome12aichi_map_FinalEE.tif"))
biome4_aichi<- raster(paste0(dir,"/output/geo-proc/aichi-maps/Biome4aichi_map_FinalEE.tif"))

# converting to spatial data frames
# biome 1
biome1_bioodcrisis_spdf <- as(biome1_bioodcrisis, "SpatialPixelsDataFrame")
biome1_bioodcrisis_df <- as.data.frame(biome1_bioodcrisis_spdf)
colnames(biome1_bioodcrisis_df) <- c("values", "x", "y")

# biome 7
biome7_aichi_spdf <- as(biome7_aichi, "SpatialPixelsDataFrame")
biome7_aichi_df <- as.data.frame(biome7_aichi_spdf)
colnames(biome7_aichi_df) <- c("values", "x", "y")

# biome 12
biome12_aichi_spdf <- as(biome12_aichi, "SpatialPixelsDataFrame")
biome12_aichi_df <- as.data.frame(biome12_aichi_spdf)
colnames(biome12_aichi_df) <- c("values", "x", "y")

# biome 4
biome4_aichi_spdf <- as(biome4_aichi, "SpatialPixelsDataFrame")
biome4_aichi_df <- as.data.frame(biome4_aichi_spdf)
colnames(biome4_aichi_df) <- c("values", "x", "y")

# aggregate for faster processing, remove for final figure
biome1_bioodcrisis_spdf_r <- raster(biome1_bioodcrisis_spdf)
biome7_aichi_spdf_r <- raster(biome7_aichi_spdf)
biome12_aichi_spdf_r <- raster(biome12_aichi_spdf)
biome4_aichi_spdf_r <- raster(biome4_aichi_spdf)

# Aggregate 
biome1_biocrisis_agg_10  <- aggregate(biome1_bioodcrisis_spdf_r, fact =3, FUN = mean)
biome7_aichi_agg_10  <- aggregate(biome7_aichi_spdf_r, fact = 3, FUN = mean)
biome12_aichi_agg_10  <- aggregate(biome12_aichi_spdf_r, fact = 3, FUN = mean)
biome4_aichi_agg_10  <- aggregate(biome4_aichi_spdf_r, fact = 3, FUN = mean)

# reproject raster
biome1_biocrisis_agg_ee <- projectRaster(biome1_biocrisis_agg_10, crs = crs("+proj=eqearth"))
biome7_aichi_agg_ee <- projectRaster(biome7_aichi_agg_10, crs = crs("+proj=eqearth"))
biome12_aichi_agg_ee <- projectRaster(biome12_aichi_agg_10, crs = crs("+proj=eqearth"))
biome4_aichi_agg_ee <- projectRaster(biome4_aichi_agg_10, crs = crs("+proj=eqearth"))

biome1_biocrisis_agg_ee_df <- as.data.frame(biome1_biocrisis_agg_ee, xy = TRUE)
biome7_aichi_agg_ee_df <- as.data.frame(biome7_aichi_agg_ee, xy = TRUE)
biome12_aichi_agg_ee_df <- as.data.frame(biome12_aichi_agg_ee, xy = TRUE)
biome4_aichi_agg_ee_df <- as.data.frame(biome4_aichi_agg_ee, xy = TRUE)

colnames(biome1_biocrisis_agg_ee_df) <- c("x", "y", "values")
colnames(biome7_aichi_agg_ee_df) <- c("x", "y", "values")
colnames(biome12_aichi_agg_ee_df) <- c("x", "y", "values")
colnames(biome4_aichi_agg_ee_df) <- c("x", "y", "values")

# Conversion of raster to stars, then sf
# convert to stars object
biome1_biocrisis_agg_stars <- st_as_stars(biome1_biocrisis_agg_10)
dim(biome1_biocrisis_agg_stars)
str(biome1_biocrisis_agg_stars)

biome7_aichi_agg_stars <- st_as_stars(biome7_aichi_agg_10)
dim(biome7_aichi_agg_stars)
str(biome7_aichi_agg_stars)

biome12_aichi_agg_stars <- st_as_stars(biome12_aichi_agg_10)
dim(biome12_aichi_agg_stars)
str(biome12_aichi_agg_stars)

biome4_aichi_agg_stars <- st_as_stars(biome4_aichi_agg_10)
dim(biome4_aichi_agg_stars)
str(biome4_aichi_agg_stars)

# convert stars to polygons (each pixel becomes a polyon)
biome1_biocrisis_poly <- st_xy2sfc(biome1_biocrisis_agg_stars, as_points = FALSE)
biome1_biocrisis_agg_sf <- st_as_sf(biome1_biocrisis_poly)
names(biome1_biocrisis_agg_sf)[1] <- "values"

biome7_aichi_poly <- st_xy2sfc(biome7_aichi_agg_stars, as_points = FALSE)
biome7_aichi_agg_sf <- st_as_sf(biome7_aichi_poly)
names(biome7_aichi_agg_sf)[1] <- "values"

biome12_aichi_poly <- st_xy2sfc(biome12_aichi_agg_stars, as_points = FALSE)
biome12_aichi_agg_sf <- st_as_sf(biome12_aichi_poly)
names(biome12_aichi_agg_sf)[1] <- "values"

biome4_aichi_poly <- st_xy2sfc(biome4_aichi_agg_stars, as_points = FALSE)
biome4_aichi_agg_sf <- st_as_sf(biome4_aichi_poly)
names(biome4_aichi_agg_sf)[1] <- "values"

ctry_border_size <- 0.1
ctry_border_color1 <- "grey60"
ctry_border_color2 <- "grey25"
color_plot_border <- "grey20"
ocean_color <- "grey95"
biome_color <- "#adff2f"
ctry_border_size_biomes <- 0.02

# Plotting
biome1_biocrisis_plot_ee_v2 <- ggplot() +
geom_sf(data = biome1_biocrisis_agg_sf, mapping = aes(fill = values), color = NA) +
geom_sf(data = ocean_ee, color = ctry_border_color2, fill = ocean_color, size = ctry_border_size)+
geom_sf(data = world, fill=NA, color= alpha(ctry_border_color2, 0.5), size = ctry_border_size)+
scale_color_viridis(discrete=F, option = "A") +
scale_fill_viridis(discrete=F, option = "A",name="Aichi value", na.value = "white")+
theme_map() +
coord_sf(crs = sf::st_crs(crs_equal_earth)) 
biome1_biocrisis_plot_ee_v2 
# save
ggsave(filename = paste0(dir,"/plots/ExTFigure5_biome1_biocrisis.png"), 
plot = biome1_biocrisis_plot_ee_v2, dpi = 300)

biome7_aichi_plot_ee_v2 <- ggplot() +
geom_sf(data = biome7_aichi_agg_sf, mapping = aes(fill = values), color = NA) +
geom_sf(data = ocean_ee, color = ctry_border_color2, fill = ocean_color, size = ctry_border_size)+
geom_sf(data = world, fill=NA, color= alpha(ctry_border_color2, 0.5), size = ctry_border_size)+
scale_color_viridis(discrete=F, option = "A") +
scale_fill_viridis(discrete=F, option = "A",name="Aichi value", na.value = "white")+
theme_map() +
coord_sf(crs = sf::st_crs(crs_equal_earth)) 
biome7_aichi_plot_ee_v2 
# save
ggsave(filename = paste0(dir,"/plots/ExTFigure5_biome7.png"), 
plot = biome7_aichi_plot_ee_v2, dpi = 300)

biome12_aichi_plot_ee_v2 <- ggplot() +
geom_sf(data = biome12_aichi_agg_sf, mapping = aes(fill = values), color = NA) +
geom_sf(data = ocean_ee, color = ctry_border_color2, fill = ocean_color, size = ctry_border_size)+
geom_sf(data = world, fill=NA, color= alpha(ctry_border_color2, 0.5), size = ctry_border_size)+
scale_color_viridis(discrete=F, option = "A") +
scale_fill_viridis(discrete=F, option = "A",name="Aichi value", na.value = "white")+
theme_map() +
coord_sf(crs = sf::st_crs(crs_equal_earth)) 
biome12_aichi_plot_ee_v2 
# save
ggsave(filename = paste0(dir,"/plots/ExTFigure5_biome12.png"), 
plot = biome12_aichi_plot_ee_v2, dpi = 300)

biome4_aichi_plot_ee_v2 <- ggplot() +
geom_sf(data = biome4_aichi_agg_sf, mapping = aes(fill = values), color = NA) +
geom_sf(data = ocean_ee, color = ctry_border_color2, fill = ocean_color, size = ctry_border_size)+
geom_sf(data = world, fill=NA, color= alpha(ctry_border_color2, 0.5), size = ctry_border_size)+
scale_color_viridis(discrete=F, option = "A") +
scale_fill_viridis(discrete=F, option = "A",name="Aichi value", na.value = "white")+
theme_map() +
coord_sf(crs = sf::st_crs(crs_equal_earth)) 
biome4_aichi_plot_ee_v2 
# save
ggsave(filename = paste0(dir,"/plots/ExTFigure5_biome4.png"), 
plot = biome4_aichi_plot_ee_v2, dpi = 300)

# Violin plots
biome1_aichi_NoNA <- as.data.frame(na.omit(values(biome1_aichi))); head(biome1_aichi_NoNA)
biome7_aichi_NoNA <- as.data.frame(na.omit(values(biome7_aichi))); head(biome7_aichi_NoNA)
biome12_aichi_NoNA <- as.data.frame(na.omit(values(biome12_aichi))); head(biome12_aichi_NoNA)
biome4_aichi_NoNA <- as.data.frame(na.omit(values(biome4_aichi))); head(biome4_aichi_NoNA)


my_datal <- melt(biome1_aichi_NoNA, measure.vars = "na.omit(values(biome1_aichi))",
                 variable.name = "variable", value.name = "biome1_aichi");head(my_datal)
my_data7 <- melt(biome7_aichi_NoNA, measure.vars = "na.omit(values(biome7_aichi))", 
                 variable.name = "variable", value.name = "biome7_aichi");head(my_data7)
my_data12 <- melt(biome12_aichi_NoNA, measure.vars = "na.omit(values(biome12_aichi))", 
                  variable.name = "variable", value.name = "biome12_aichi");head(my_data12)
my_data4 <- melt(biome4_aichi_NoNA, measure.vars = "na.omit(values(biome4_aichi))", 
                 variable.name = "variable", value.name = "biome4_aichi");head(my_data4)

# plots
biome1_aichi_plot <- ggplot(my_datal, aes(x=variable, y= biome1_aichi))+
#geom_point(position = position_jitter(width = 0.25), size = 0.01, alpha=0.7, aes(colour = value))+
geom_violin(position = position_nudge(x = 0, y = 0), alpha = 0.5, adjust =1, trim = T, width = .5, fill= "#A4A4A4")+
geom_boxplot(aes(x = variable, y = biome1_aichi), outlier.shape = NA, alpha = 0.5, width = 0.02, colour = "black")+
scale_color_viridis(discrete=F, option = "A") +
scale_fill_viridis(discrete=F, option = "A")+
ylab("")+
ylim(0, 1)+
xlab("")+
theme_update(text = element_text(size=12))+
  guides(fill = FALSE, colour = FALSE) +
  theme_bw()+
  science_theme_facets
biome1_aichi_plot
ggsave(filename = paste0(dir,"/plots/ExTFigure5_biome1_violin.png"),
plot = biome1_aichi_plot, width =10, height = 7, dpi = 300)

biome7_aichi_plot <- ggplot(my_data7, aes(x=variable, y= biome7_aichi))+
#geom_point(position = position_jitter(width = 0.25), size = 0.01, alpha=0.7, aes(colour = value))+
geom_violin(position = position_nudge(x = 0, y = 0), alpha = 0.5, adjust =1, trim = T, width = .5, fill= "#A4A4A4")+
geom_boxplot(aes(x = variable, y = biome7_aichi), outlier.shape = NA, alpha = 0.5, width = 0.02, colour = "black")+
scale_color_viridis(discrete=F, option = "A") +
scale_fill_viridis(discrete=F, option = "A")+
ylab("")+
ylim(0, 1)+
xlab("")+
theme_update(text = element_text(size=12))+
guides(fill = FALSE, colour = FALSE) +
theme_bw()+
science_theme_facets
biome7_aichi_plot
ggsave(filename = paste0(dir,"/plots/ExTFigure5_biome7_violin.png"),
plot = biome7_aichi_plot, width =10, height = 7, dpi = 300)

biome12_aichi_plot <- ggplot(my_data12, aes(x=variable, y= biome12_aichi))+
#geom_point(position = position_jitter(width = 0.25), size = 0.01, alpha=0.7, aes(colour = value))+
geom_violin(position = position_nudge(x = 0, y = 0), alpha = 0.5, adjust =1, trim = T, width = .5, fill= "#A4A4A4")+
geom_boxplot(aes(x = variable, y = biome12_aichi), outlier.shape = NA, alpha = 0.5, width = 0.02, colour = "black")+
scale_color_viridis(discrete=F, option = "A") +
scale_fill_viridis(discrete=F, option = "A")+
ylab("")+
ylim(0, 1)+
xlab("")+
theme_update(text = element_text(size=12))+
guides(fill = FALSE, colour = FALSE) +
theme_bw()+
science_theme_facets
biome12_aichi_plot
ggsave(filename = paste0(dir,"/plots/ExTFigure5_biome12_violin.png"),plot = biome12_aichi_plot, width =10, height = 7, dpi = 300)

biome4_aichi_plot <- ggplot(my_data4, aes(x=variable, y= biome4_aichi))+
#geom_point(position = position_jitter(width = 0.25), size = 0.01, alpha=0.7, aes(colour = value))+
geom_violin(position = position_nudge(x = 0, y = 0), alpha = 0.5, adjust =1, trim = T, width = .5, fill= "#A4A4A4")+
geom_boxplot(aes(x = variable, y = biome4_aichi), outlier.shape = NA, alpha = 0.5, width = 0.02, colour = "black")+
scale_color_viridis(discrete=F, option = "A") +
scale_fill_viridis(discrete=F, option = "A")+
ylab("")+
ylim(0, 1)+
xlab("")+
theme_update(text = element_text(size=12))+
guides(fill = FALSE, colour = FALSE) +
theme_bw()+
science_theme_facets
biome4_aichi_plot
ggsave(filename = paste0(dir,"/plots/ExTFigure5_biome4_violin.png"),
plot = biome4_aichi_plot, width =10, height = 7, dpi = 300)
```

# Session
```{r sessionInfo}
## DO NOT REMOVE!
## We store the settings of your computer and the current versions of the
## packages used to allow for reproducibility
Sys.time()
#git2r::repository() ## uncomment if you are using GitHub
sessionInfo()
```


